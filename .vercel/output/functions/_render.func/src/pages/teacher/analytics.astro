---
/**
 * Teacher Analytics Dashboard
 * Agent 2: Teacher Analytics Specialist
 *
 * Comprehensive analytics dashboard for teachers with engagement heat maps,
 * dropout predictions, lesson effectiveness, and custom reporting
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// Check authentication
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/login?redirect=/teacher/analytics');
}

// Get teacher's cohorts with enrollment counts
const { data: cohorts } = await supabase
  .from('cohorts')
  .select(`
    id,
    name,
    course_id,
    cohort_enrollments(count)
  `)
  .eq('created_by', session.user.id)
  .order('created_at', { ascending: false });

// Transform to add student count
const cohortsWithCounts = cohorts?.map(c => ({
  ...c,
  student_count: c.cohort_enrollments?.[0]?.count || 0
})) || [];

const defaultCohort = cohortsWithCounts?.[0];
---

<BaseLayout title="Teacher Analytics Dashboard">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">
        Analytics Dashboard
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        Track student engagement, identify at-risk learners, and optimize your teaching
      </p>
    </div>

    <!-- Cohort Selector -->
    <div class="mb-6">
      <label for="cohort-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        Select Cohort
      </label>
      <select
        id="cohort-select"
        class="w-full md:w-96 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
      >
        {cohortsWithCounts?.map(cohort => (
          <option value={cohort.id} selected={cohort.id === defaultCohort?.id}>
            {cohort.name} ({cohort.student_count} students)
          </option>
        ))}
      </select>
    </div>

    <!-- Date Range Selector -->
    <div id="date-range-container" class="mb-8"></div>

    <!-- Key Metrics Cards -->
    <div id="metrics-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>

    <!-- Tabs for Different Analytics Views -->
    <div class="mb-6">
      <div class="border-b border-gray-200 dark:border-gray-700">
        <nav class="-mb-px flex space-x-8">
          <button
            class="tab-button active py-4 px-1 border-b-2 font-medium text-sm"
            data-tab="engagement"
          >
            Engagement Heat Map
          </button>
          <button
            class="tab-button py-4 px-1 border-b-2 font-medium text-sm"
            data-tab="at-risk"
          >
            At-Risk Students
          </button>
          <button
            class="tab-button py-4 px-1 border-b-2 font-medium text-sm"
            data-tab="lessons"
          >
            Lesson Effectiveness
          </button>
          <button
            class="tab-button py-4 px-1 border-b-2 font-medium text-sm"
            data-tab="reports"
          >
            Custom Reports
          </button>
        </nav>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Engagement Heat Map Tab -->
      <div id="engagement-tab" class="tab-panel active">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
              Student Engagement Heat Map
            </h2>
            <div id="heatmap-export"></div>
          </div>
          <p class="text-gray-600 dark:text-gray-400 mb-6">
            Visualize when your students are most active throughout the week
          </p>
          <div id="heatmap-container" class="min-h-[400px]"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
              Peak Activity Times
            </h3>
            <div id="peak-times" class="space-y-3"></div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
              Activity Trends
            </h3>
            <canvas id="activity-trend-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- At-Risk Students Tab -->
      <div id="at-risk-tab" class="tab-panel hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
              Dropout Risk Analysis
            </h2>
            <button
              id="recalculate-risk"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Recalculate
            </button>
          </div>
          <p class="text-gray-600 dark:text-gray-400 mb-6">
            Identify students who need support and take proactive action
          </p>

          <!-- Risk Level Filters -->
          <div class="flex space-x-2 mb-6">
            <button class="risk-filter active px-4 py-2 rounded-lg" data-level="all">
              All Students
            </button>
            <button class="risk-filter px-4 py-2 rounded-lg bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-400" data-level="critical">
              Critical
            </button>
            <button class="risk-filter px-4 py-2 rounded-lg bg-orange-100 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400" data-level="high">
              High
            </button>
            <button class="risk-filter px-4 py-2 rounded-lg bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-400" data-level="medium">
              Medium
            </button>
            <button class="risk-filter px-4 py-2 rounded-lg bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-400" data-level="low">
              Low
            </button>
          </div>

          <div id="at-risk-container"></div>
        </div>
      </div>

      <!-- Lesson Effectiveness Tab -->
      <div id="lessons-tab" class="tab-panel hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
            Lesson Performance
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mb-6">
            Analyze completion rates and engagement for each lesson
          </p>
          <div id="lessons-container"></div>
        </div>
      </div>

      <!-- Custom Reports Tab -->
      <div id="reports-tab" class="tab-panel hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
            Custom Report Builder
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mb-6">
            Create and export custom analytics reports
          </p>
          <div class="text-center py-12">
            <p class="text-gray-500 dark:text-gray-400 mb-4">
              Report builder coming soon!
            </p>
            <p class="text-sm text-gray-400">
              Export current view data using the export buttons above each section
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import D3HeatMap from '../../components/analytics/D3HeatMap';
    import DateRangeSelector from '../../components/analytics/DateRangeSelector';
    import MetricCard from '../../components/analytics/MetricCard';
    import ExportPanel from '../../components/analytics/ExportPanel';
    import { createRoot } from 'react-dom/client';
    import { createElement } from 'react';
    import { Chart, registerables } from 'chart.js';

    Chart.register(...registerables);

    // Global state
    let currentCohortId: number | null = null;
    let currentDateRange = { start: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), end: new Date() };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initializeCohortSelector();
      initializeDateRangeSelector();
      initializeTabs();
      loadDashboardData();
    });

    function initializeCohortSelector() {
      const select = document.getElementById('cohort-select') as HTMLSelectElement;
      if (select && select.value) {
        currentCohortId = parseInt(select.value);
      }

      select?.addEventListener('change', (e) => {
        currentCohortId = parseInt((e.target as HTMLSelectElement).value);
        loadDashboardData();
      });
    }

    function initializeDateRangeSelector() {
      const container = document.getElementById('date-range-container');
      if (container) {
        const root = createRoot(container);
        root.render(
          createElement(DateRangeSelector, {
            onChange: (range) => {
              currentDateRange = range;
              loadDashboardData();
            }
          })
        );
      }
    }

    function initializeTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName: string) {
      // Update button states
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
      });

      const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
      activeButton?.classList.add('active', 'border-blue-600', 'text-blue-600');
      activeButton?.classList.remove('border-transparent', 'text-gray-500');

      // Update panel visibility
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.add('hidden');
      });

      const activePanel = document.getElementById(`${tabName}-tab`);
      activePanel?.classList.remove('hidden');

      // Load tab-specific data
      loadTabData(tabName);
    }

    async function loadDashboardData() {
      if (!currentCohortId) return;

      await Promise.all([
        loadMetrics(),
        loadTabData('engagement')
      ]);
    }

    async function loadMetrics() {
      const container = document.getElementById('metrics-container');
      if (!container) return;

      // TODO: Fetch real metrics from API
      const metrics = [
        { title: 'Total Students', value: '42', trend: 'up', trendValue: '+8%', color: 'blue', icon: 'ðŸ‘¥' },
        { title: 'Avg Completion', value: '78%', trend: 'up', trendValue: '+5%', color: 'green', icon: 'âœ“' },
        { title: 'At Risk', value: '6', trend: 'down', trendValue: '-2', color: 'red', icon: 'âš ï¸' },
        { title: 'Engagement Rate', value: '85%', trend: 'stable', trendValue: '0%', color: 'purple', icon: 'ðŸ“Š' }
      ];

      container.innerHTML = '';
      metrics.forEach(metric => {
        const div = document.createElement('div');
        container.appendChild(div);
        const root = createRoot(div);
        root.render(createElement(MetricCard, metric));
      });
    }

    async function loadTabData(tabName: string) {
      switch (tabName) {
        case 'engagement':
          await loadEngagementHeatMap();
          break;
        case 'at-risk':
          await loadAtRiskStudents();
          break;
        case 'lessons':
          await loadLessonEffectiveness();
          break;
      }
    }

    async function loadEngagementHeatMap() {
      if (!currentCohortId) return;

      try {
        const response = await fetch(`/api/analytics/engagement-heatmap?cohortId=${currentCohortId}`);
        const data = await response.json();

        // Transform data for D3HeatMap
        const heatmapData = data.map((d: any) => ({
          day: d.day_of_week,
          hour: d.hour_of_day,
          value: d.unique_users || 0,
          label: `${d.total_events} events`
        }));

        // Render heatmap
        const container = document.getElementById('heatmap-container');
        if (container) {
          container.innerHTML = '';
          const div = document.createElement('div');
          container.appendChild(div);
          const root = createRoot(div);
          root.render(createElement(D3HeatMap, {
            data: heatmapData,
            onCellClick: (cell) => {
              console.log('Clicked cell:', cell);
            }
          }));
        }

        // Render export panel
        const exportContainer = document.getElementById('heatmap-export');
        if (exportContainer) {
          const root = createRoot(exportContainer);
          root.render(createElement(ExportPanel, {
            chartId: 'heatmap-container',
            data: heatmapData,
            filename: 'engagement-heatmap',
            title: 'Engagement Heat Map'
          }));
        }
      } catch (error) {
        console.error('Failed to load heatmap:', error);
      }
    }

    async function loadAtRiskStudents() {
      if (!currentCohortId) return;

      const container = document.getElementById('at-risk-container');
      if (!container) return;

      container.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div></div>';

      try {
        // TODO: Get courseId from cohort
        const courseId = 1;
        const response = await fetch(`/api/analytics/dropout-predictions?cohortId=${currentCohortId}&courseId=${courseId}`);
        const data = await response.json();

        // Render at-risk students by level
        container.innerHTML = `
          <div class="space-y-4">
            ${renderRiskLevel('critical', data.byRiskLevel.critical)}
            ${renderRiskLevel('high', data.byRiskLevel.high)}
            ${renderRiskLevel('medium', data.byRiskLevel.medium)}
            ${renderRiskLevel('low', data.byRiskLevel.low)}
          </div>
        `;
      } catch (error) {
        console.error('Failed to load at-risk students:', error);
        container.innerHTML = '<p class="text-red-600">Failed to load predictions. Please try again.</p>';
      }
    }

    function renderRiskLevel(level: string, students: any[]) {
      const colors = {
        critical: 'bg-red-100 dark:bg-red-900/20 border-red-300 dark:border-red-800',
        high: 'bg-orange-100 dark:bg-orange-900/20 border-orange-300 dark:border-orange-800',
        medium: 'bg-yellow-100 dark:bg-yellow-900/20 border-yellow-300 dark:border-yellow-800',
        low: 'bg-green-100 dark:bg-green-900/20 border-green-300 dark:border-green-800'
      };

      if (!students || students.length === 0) return '';

      return `
        <div class="border-2 ${colors[level]} rounded-lg p-4">
          <h4 class="font-bold text-lg mb-3 capitalize">${level} Risk (${students.length})</h4>
          <div class="space-y-2">
            ${students.slice(0, 5).map(student => `
              <div class="bg-white dark:bg-gray-800 rounded p-3 flex justify-between items-center">
                <div>
                  <p class="font-medium">${student.user?.email || 'Unknown'}</p>
                  <p class="text-sm text-gray-600">${student.last_activity_days} days inactive</p>
                </div>
                <button class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                  Contact
                </button>
              </div>
            `).join('')}
          </div>
          ${students.length > 5 ? `<p class="text-sm text-gray-600 mt-2">+ ${students.length - 5} more</p>` : ''}
        </div>
      `;
    }

    async function loadLessonEffectiveness() {
      const container = document.getElementById('lessons-container');
      if (!container) return;

      container.innerHTML = '<p class="text-center text-gray-500">Loading lesson data...</p>';
      // TODO: Implement lesson effectiveness display
    }

    // Risk filter buttons
    document.querySelectorAll('.risk-filter').forEach(button => {
      button.addEventListener('click', (e) => {
        document.querySelectorAll('.risk-filter').forEach(b => b.classList.remove('active', 'ring-2', 'ring-blue-600'));
        (e.target as HTMLElement).classList.add('active', 'ring-2', 'ring-blue-600');
        // TODO: Filter at-risk students by level
      });
    });

    // Recalculate risk button
    document.getElementById('recalculate-risk')?.addEventListener('click', async () => {
      if (currentCohortId) {
        const button = document.getElementById('recalculate-risk') as HTMLButtonElement;
        button.disabled = true;
        button.textContent = 'Calculating...';
        await loadAtRiskStudents();
        button.disabled = false;
        button.textContent = 'Recalculate';
      }
    });
  </script>

  <style>
    .tab-button.active {
      border-color: rgb(37, 99, 235);
      color: rgb(37, 99, 235);
    }

    .tab-button:not(.active) {
      border-color: transparent;
      color: rgb(107, 114, 128);
    }

    .tab-button:not(.active):hover {
      color: rgb(55, 65, 81);
      border-color: rgb(209, 213, 219);
    }

    .risk-filter.active {
      box-shadow: 0 0 0 2px rgb(37, 99, 235);
    }
  </style>
</BaseLayout>
