import{s as r}from"../assets/supabase.DdTcER9f.js";import{C as m,r as h}from"../assets/chart._lwrjFc3.js";import"../assets/index.CS-uK3Uq.js";import"../assets/_commonjsHelpers.D6-XlEtG.js";m.register(...h);let p=null,y=null,f=null,b=null;async function w(){const{data:{session:t}}=await r.auth.getSession();if(!t)return window.location.href="/login",!1;p=t.user;const{data:o}=await r.from("applications").select("role").eq("user_id",p.id).single();return!o||o.role!=="admin"?(document.getElementById("loading-state")?.classList.add("hidden"),document.getElementById("access-denied")?.classList.remove("hidden"),!1):!0}async function E(){try{const t=Date.now(),{count:o}=await r.from("applications").select("id",{count:"exact",head:!0}).eq("role","student"),{count:c}=await r.from("enrollments").select("id",{count:"exact",head:!0}).eq("status","active"),{data:e}=await r.from("lesson_progress").select("completed, time_spent_seconds"),a=Date.now()-t,d=e?.filter(u=>u.completed).length||0,n=e?.length||1,s=Math.round(d/n*100),l=e?.reduce((u,g)=>u+(g.time_spent_seconds||0),0)||0,i=Math.round(l/3600);document.getElementById("metric-students").textContent=o?.toString()||"0",document.getElementById("metric-enrollments").textContent=c?.toString()||"0",document.getElementById("metric-completion").textContent=s+"%",document.getElementById("metric-watchtime").textContent=i.toLocaleString()+"h",document.getElementById("health-response").textContent=a+"ms"}catch(t){console.error("Error loading metrics:",t)}}async function x(){try{const t=new Date;t.setDate(t.getDate()-30);const{data:o}=await r.from("enrollments").select("enrolled_at").gte("enrolled_at",t.toISOString()).order("enrolled_at",{ascending:!0}),c={},e=[];for(let n=0;n<30;n++){const s=new Date(t);s.setDate(s.getDate()+n);const l=s.toISOString().split("T")[0];c[l]=0,e.push(s.toLocaleDateString("en-US",{month:"short",day:"numeric"}))}o?.forEach(n=>{const s=n.enrolled_at.split("T")[0];c[s]!==void 0&&c[s]++});const a=Object.values(c),d=document.getElementById("enrollment-chart");y=new m(d,{type:"line",data:{labels:e,datasets:[{label:"New Enrollments",data:a,borderColor:"rgb(59, 130, 246)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.3,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}catch(t){console.error("Error loading enrollment trend:",t)}}async function C(){try{const{data:t}=await r.from("enrollments").select("course_id, courses(name)"),o={},c={};t?.forEach(s=>{const l=s.course_id,i=s.courses?.name||"Unknown";c[l]=i,o[i]=(o[i]||0)+1});const e=Object.entries(o).sort(([,s],[,l])=>l-s).slice(0,5),a=e.map(([s])=>s),d=e.map(([,s])=>s),n=document.getElementById("courses-chart");f=new m(n,{type:"bar",data:{labels:a,datasets:[{label:"Enrollments",data:d,backgroundColor:["rgba(59, 130, 246, 0.8)","rgba(16, 185, 129, 0.8)","rgba(251, 191, 36, 0.8)","rgba(239, 68, 68, 0.8)","rgba(139, 92, 246, 0.8)"]}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0}}}})}catch(t){console.error("Error loading course popularity:",t)}}async function v(){try{const{data:t}=await r.from("courses").select("id, name").limit(10);if(!t)return;const o=document.getElementById("completion-list"),c=[];for(const e of t){const{count:a}=await r.from("enrollments").select("id",{count:"exact",head:!0}).eq("course_id",e.id),{count:d}=await r.from("enrollments").select("id",{count:"exact",head:!0}).eq("course_id",e.id).eq("status","completed"),n=a&&a>0?Math.round((d||0)/a*100):0;c.push({name:e.title,rate:n})}o.innerHTML=c.sort((e,a)=>a.rate-e.rate).map(e=>`
            <div>
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium">${e.name}</span>
                <span class="text-sm text-text-muted">${e.rate}%</span>
              </div>
              <div class="w-full bg-surface-hover rounded-full h-2">
                <div class="bg-primary h-2 rounded-full" style="width: ${e.rate}%"></div>
              </div>
            </div>
          `).join("")}catch(t){console.error("Error loading completion rates:",t)}}async function I(){try{const{data:t}=await r.from("applications").select("role"),o={student:0,teacher:0,admin:0};t?.forEach(e=>{e.role in o&&o[e.role]++});const c=document.getElementById("roles-chart");b=new m(c,{type:"doughnut",data:{labels:["Students","Teachers","Admins"],datasets:[{data:[o.student,o.teacher,o.admin],backgroundColor:["rgba(59, 130, 246, 0.8)","rgba(16, 185, 129, 0.8)","rgba(239, 68, 68, 0.8)"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}catch(t){console.error("Error loading role distribution:",t)}}async function _(){const t=document.getElementById("cohorts-loading"),o=document.getElementById("cohorts-list"),c=document.getElementById("cohorts-empty"),e=document.getElementById("cohorts-table-body");try{const{data:a}=await r.from("cohorts").select("id, name, start_date, status, course_id, courses(name)").eq("status","active");if(t?.classList.add("hidden"),!a||a.length===0){c?.classList.remove("hidden");return}const d=await Promise.all(a.map(async n=>{const{count:s}=await r.from("cohort_enrollments").select("id",{count:"exact",head:!0}).eq("cohort_id",n.id),{data:l}=await r.from("cohort_enrollments").select("completed_lessons").eq("cohort_id",n.id),i=l&&l.length>0?Math.round(l.reduce((u,g)=>u+g.completed_lessons,0)/l.length):0;return{...n,studentCount:s||0,avgCompletion:i}}));e.innerHTML=d.map(n=>`
          <tr class="border-b border-border">
            <td class="p-3 font-medium">${n.name}</td>
            <td class="p-3 text-text-muted">${n.courses?.name||"Unknown"}</td>
            <td class="p-3">${n.studentCount}</td>
            <td class="p-3">${n.avgCompletion} lessons</td>
            <td class="p-3">
              <span class="px-2 py-1 rounded text-xs font-medium bg-green-500/10 text-green-500">
                ${n.status}
              </span>
            </td>
            <td class="p-3 text-text-muted text-sm">
              ${new Date(n.start_date).toLocaleDateString()}
            </td>
          </tr>
        `).join(""),o?.classList.remove("hidden")}catch(a){console.error("Error loading cohort analytics:",a),t?.classList.add("hidden"),c?.classList.remove("hidden")}}async function B(){try{const[t,o,c,e]=await Promise.all([r.from("courses").select("id",{count:"exact",head:!0}),r.from("enrollments").select("id",{count:"exact",head:!0}),r.from("applications").select("id",{count:"exact",head:!0}),r.from("lessons").select("id",{count:"exact",head:!0})]),a=(t.count||0)+(o.count||0)+(c.count||0)+(e.count||0);document.getElementById("health-records").textContent=a.toLocaleString(),document.getElementById("health-db-size").textContent="N/A"}catch(t){console.error("Error loading system health:",t)}}async function L(){await w()&&(document.getElementById("loading-state")?.classList.add("hidden"),document.getElementById("analytics-content")?.classList.remove("hidden"),await Promise.all([E(),x(),C(),v(),I(),_(),B()]))}document.getElementById("logout-btn")?.addEventListener("click",async()=>{await r.auth.signOut(),window.location.href="/login"});L();
