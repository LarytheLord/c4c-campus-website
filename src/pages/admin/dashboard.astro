---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Admin Dashboard - C4C Campus" currentPage="dashboard">
  <!-- Loading State -->
  <div id="loading-state" class="container mx-auto px-4 py-12">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
      <p class="mt-4 text-text-muted">Loading dashboard...</p>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div id="dashboard-content" class="hidden">
    <div class="container mx-auto px-4 py-8">
      <!-- Page Title -->
      <div class="mb-8">
        <h1 class="text-2xl font-bold">Dashboard</h1>
        <p class="text-text-muted">Platform overview and quick actions</p>
      </div>

      <!-- Overview Stats -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="card">
          <div class="flex items-center gap-3">
            <div class="p-3 bg-blue-500/10 rounded-lg">
              <span class="text-2xl">ðŸ‘¥</span>
            </div>
            <div>
              <p class="text-sm text-text-muted">Total Users</p>
              <p class="text-2xl font-bold" id="stat-total-users">-</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center gap-3">
            <div class="p-3 bg-yellow-500/10 rounded-lg">
              <span class="text-2xl">ðŸ“‹</span>
            </div>
            <div>
              <p class="text-sm text-text-muted">Pending Applications</p>
              <p class="text-2xl font-bold" id="stat-pending-apps">-</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center gap-3">
            <div class="p-3 bg-green-500/10 rounded-lg">
              <span class="text-2xl">ðŸ“š</span>
            </div>
            <div>
              <p class="text-sm text-text-muted">Total Courses</p>
              <p class="text-2xl font-bold" id="stat-total-courses">-</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center gap-3">
            <div class="p-3 bg-purple-500/10 rounded-lg">
              <span class="text-2xl">ðŸŽ“</span>
            </div>
            <div>
              <p class="text-sm text-text-muted">Active Cohorts</p>
              <p class="text-2xl font-bold" id="stat-active-cohorts">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Recent Applications -->
        <div class="card">
          <h2 class="text-xl font-bold mb-4">Recent Applications</h2>
          <div id="recent-apps-loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
          </div>
          <div id="recent-apps-list" class="hidden space-y-3"></div>
          <div id="recent-apps-empty" class="hidden text-center py-8 text-text-muted">
            <p>No recent applications</p>
          </div>
          <a href="/admin/applications-review" class="btn btn-secondary btn-sm mt-4 w-full">View All Applications</a>
        </div>
      </div>

      <!-- System Health -->
      <div class="card mb-8">
        <h2 class="text-xl font-bold mb-4">System Health</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-text-muted">Database Status</span>
              <span class="text-sm font-semibold text-green-500" id="db-status">Checking...</span>
            </div>
            <div class="w-full bg-surface-hover rounded-full h-2">
              <div class="bg-green-500 h-2 rounded-full" id="db-health-bar" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-text-muted">Storage Used</span>
              <span class="text-sm font-semibold" id="storage-used">-</span>
            </div>
            <div class="w-full bg-surface-hover rounded-full h-2">
              <div class="bg-blue-500 h-2 rounded-full" id="storage-bar" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-text-muted">RLS Policies</span>
              <span class="text-sm font-semibold text-green-500" id="rls-status">Active</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <a href="/admin/applications-review" class="btn btn-primary">Review Applications</a>
          <a href="/admin/users" class="btn btn-secondary">Manage Users</a>
          <a href="/admin/cohorts" class="btn btn-secondary">Manage Cohorts</a>
          <button id="refresh-stats-btn" class="btn btn-ghost">Refresh Stats</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    let currentUser: any = null;

    async function loadDashboardStats() {
      try {
        const [usersResult, appsResult, coursesResult, cohortsResult] = await Promise.all([
          supabase.from('applications').select('id', { count: 'exact', head: true }),
          supabase.from('applications').select('id', { count: 'exact', head: true }).eq('status', 'pending'),
          supabase.from('courses').select('id', { count: 'exact', head: true }),
          supabase.from('cohorts').select('id', { count: 'exact', head: true }).eq('status', 'active')
        ]);

        document.getElementById('stat-total-users')!.textContent = usersResult.count?.toString() || '0';
        document.getElementById('stat-pending-apps')!.textContent = appsResult.count?.toString() || '0';
        document.getElementById('stat-total-courses')!.textContent = coursesResult.count?.toString() || '0';
        document.getElementById('stat-active-cohorts')!.textContent = cohortsResult.count?.toString() || '0';

        document.getElementById('db-status')!.textContent = 'Connected';
        document.getElementById('db-health-bar')!.style.width = '100%';
        document.getElementById('storage-used')!.textContent = 'N/A';
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('db-status')!.textContent = 'Error';
        document.getElementById('db-status')!.classList.replace('text-green-500', 'text-red-500');
      }
    }

    async function loadRecentApplications() {
      const loadingEl = document.getElementById('recent-apps-loading');
      const listEl = document.getElementById('recent-apps-list');
      const emptyEl = document.getElementById('recent-apps-empty');

      try {
        const { data: applications } = await supabase
          .from('applications')
          .select('id, name, email, status, created_at')
          .order('created_at', { ascending: false })
          .limit(5);

        loadingEl?.classList.add('hidden');

        if (!applications || applications.length === 0) {
          emptyEl?.classList.remove('hidden');
          return;
        }

        listEl!.innerHTML = applications.map(app => {
          const statusColor = app.status === 'pending' ? 'bg-yellow-500/10 text-yellow-500' :
                              app.status === 'approved' ? 'bg-green-500/10 text-green-500' :
                              'bg-red-500/10 text-red-500';
          return `
            <div class="border border-border rounded-lg p-3">
              <div class="flex items-start justify-between">
                <div>
                  <p class="font-semibold">${app.name}</p>
                  <p class="text-sm text-text-muted">${app.email}</p>
                </div>
                <span class="px-2 py-1 rounded text-xs font-medium ${statusColor}">${app.status}</span>
              </div>
            </div>
          `;
        }).join('');
        listEl?.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading recent applications:', error);
        loadingEl?.classList.add('hidden');
        emptyEl?.classList.remove('hidden');
      }
    }

    async function initDashboard() {
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('dashboard-content')?.classList.remove('hidden');

      await Promise.all([
        loadDashboardStats(),
        loadRecentApplications()
      ]);
    }

    document.getElementById('refresh-stats-btn')?.addEventListener('click', loadDashboardStats);

    initDashboard();
  </script>
</AdminLayout>
