---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Branding Settings - Admin" currentPage="settings">
    <!-- Header -->
    <div class="container mx-auto px-4 py-6">
      <div class="flex items-center justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl font-bold">Branding Settings</h1>
          <p class="text-text-muted text-sm">Customize your platform's look and feel</p>
        </div>
        <a href="/admin/settings" class="btn btn-ghost btn-sm">‚Üê Back to Settings</a>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading branding settings...</p>
      </div>
    </div>

    <!-- Settings Content -->
    <div id="settings-content" class="hidden">
      <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Settings Form -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Brand Identity -->
            <div class="card">
              <h2 class="text-xl font-bold mb-4">Brand Identity</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Brand Name</label>
                  <input type="text" id="brand_name" class="input w-full" placeholder="C4C Campus" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Tagline</label>
                  <input type="text" id="tagline" class="input w-full" placeholder="Building with purpose" />
                </div>
              </div>
            </div>

            <!-- Color System -->
            <div class="card">
              <h2 class="text-xl font-bold mb-4">Color System</h2>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Primary Color</label>
                  <div class="flex gap-2">
                    <input type="color" id="primary_color" class="h-10 w-20 rounded cursor-pointer" />
                    <input type="text" id="primary_color_hex" class="input flex-1" placeholder="#10b981" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Secondary Color</label>
                  <div class="flex gap-2">
                    <input type="color" id="secondary_color" class="h-10 w-20 rounded cursor-pointer" />
                    <input type="text" id="secondary_color_hex" class="input flex-1" placeholder="#8b5cf6" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Background Color</label>
                  <div class="flex gap-2">
                    <input type="color" id="background_color" class="h-10 w-20 rounded cursor-pointer" />
                    <input type="text" id="background_color_hex" class="input flex-1" placeholder="#0a0a0a" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Surface Color</label>
                  <div class="flex gap-2">
                    <input type="color" id="surface_color" class="h-10 w-20 rounded cursor-pointer" />
                    <input type="text" id="surface_color_hex" class="input flex-1" placeholder="#1a1a1a" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Text Color</label>
                  <div class="flex gap-2">
                    <input type="color" id="text_color" class="h-10 w-20 rounded cursor-pointer" />
                    <input type="text" id="text_color_hex" class="input flex-1" placeholder="#ffffff" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Border Color</label>
                  <div class="flex gap-2">
                    <input type="color" id="border_color" class="h-10 w-20 rounded cursor-pointer" />
                    <input type="text" id="border_color_hex" class="input flex-1" placeholder="#2a2a2a" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Typography -->
            <div class="card">
              <h2 class="text-xl font-bold mb-4">Typography</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Heading Font</label>
                  <input type="text" id="font_family_heading" class="input w-full" placeholder="Inter, system-ui, sans-serif" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Body Font</label>
                  <input type="text" id="font_family_body" class="input w-full" placeholder="Inter, system-ui, sans-serif" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Monospace Font</label>
                  <input type="text" id="font_family_mono" class="input w-full" placeholder="JetBrains Mono, monospace" />
                </div>
              </div>
            </div>

            <!-- Styling -->
            <div class="card">
              <h2 class="text-xl font-bold mb-4">Styling</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Border Radius</label>
                  <input type="text" id="border_radius" class="input w-full" placeholder="0.5rem" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Button Style</label>
                  <select id="button_style" class="input w-full">
                    <option value="rounded">Rounded</option>
                    <option value="square">Square</option>
                    <option value="pill">Pill</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Save Button -->
            <div class="flex gap-4">
              <button id="save-btn" class="btn btn-primary flex-1">
                <span id="save-btn-text">Save Changes</span>
                <span id="save-btn-loading" class="hidden">
                  <div class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                  Saving...
                </span>
              </button>
              <button id="reset-btn" class="btn btn-secondary">Reset to Defaults</button>
            </div>
          </div>

          <!-- Live Preview -->
          <div class="lg:col-span-1">
            <div class="sticky top-24">
              <div class="card">
                <h2 class="text-xl font-bold mb-4">Live Preview</h2>
                <div id="live-preview" class="space-y-4 p-4 rounded-lg border-2 border-border">
                  <div class="preview-brand-name text-2xl font-bold">C4C Campus</div>
                  <div class="preview-tagline text-sm text-text-muted">Building with purpose</div>
                  <hr class="preview-border" />
                  <button class="preview-btn-primary w-full py-2 px-4 rounded font-medium">Primary Button</button>
                  <button class="preview-btn-secondary w-full py-2 px-4 rounded font-medium">Secondary Button</button>
                  <div class="preview-card p-4 rounded">
                    <p class="preview-text-heading font-bold mb-2">Card Example</p>
                    <p class="preview-text-body text-sm">This is how your content will look with the selected branding.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Toast -->
    <div id="success-toast" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
      Changes saved successfully!
    </div>

    <!-- Error Toast -->
    <div id="error-toast" class="hidden fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg">
      <span id="error-message">Error saving changes</span>
    </div>

  <script>
    import { supabase } from '../../../lib/supabase';

    let currentBranding: any = null;
    let isAdmin = false;

    async function checkAdminAccess() {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        window.location.href = '/login';
        return false;
      }

      const { data: application } = await supabase
        .from('applications')
        .select('role')
        .eq('user_id', session.user.id)
        .single();

      if (!application || application.role !== 'admin') {
        window.location.href = '/admin/dashboard';
        return false;
      }

      isAdmin = true;
      return true;
    }

    async function loadBranding() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const token = session?.access_token;

        const response = await fetch('/api/admin/config/branding', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error('Failed to load branding');

        currentBranding = await response.json();
        populateForm(currentBranding);
        updatePreview();
      } catch (error) {
        console.error('Error loading branding:', error);
        showError('Failed to load branding settings');
      }
    }

    function populateForm(branding: any) {
      // Brand Identity
      (document.getElementById('brand_name') as HTMLInputElement).value = branding.brand_name || '';
      (document.getElementById('tagline') as HTMLInputElement).value = branding.tagline || '';

      // Colors
      const colorFields = ['primary_color', 'secondary_color', 'background_color', 'surface_color', 'text_color', 'border_color'];
      colorFields.forEach(field => {
        const value = branding[field] || '#000000';
        (document.getElementById(field) as HTMLInputElement).value = value;
        (document.getElementById(`${field}_hex`) as HTMLInputElement).value = value;
      });

      // Typography
      (document.getElementById('font_family_heading') as HTMLInputElement).value = branding.font_family_heading || '';
      (document.getElementById('font_family_body') as HTMLInputElement).value = branding.font_family_body || '';
      (document.getElementById('font_family_mono') as HTMLInputElement).value = branding.font_family_mono || '';

      // Styling
      (document.getElementById('border_radius') as HTMLInputElement).value = branding.border_radius || '';
      (document.getElementById('button_style') as HTMLSelectElement).value = branding.button_style || 'rounded';
    }

    function updatePreview() {
      const preview = document.getElementById('live-preview');
      if (!preview) return;

      const brandName = (document.getElementById('brand_name') as HTMLInputElement).value;
      const tagline = (document.getElementById('tagline') as HTMLInputElement).value;
      const primaryColor = (document.getElementById('primary_color') as HTMLInputElement).value;
      const secondaryColor = (document.getElementById('secondary_color') as HTMLInputElement).value;
      const surfaceColor = (document.getElementById('surface_color') as HTMLInputElement).value;
      const textColor = (document.getElementById('text_color') as HTMLInputElement).value;
      const borderColor = (document.getElementById('border_color') as HTMLInputElement).value;

      // Update preview content
      const brandNameEl = preview.querySelector('.preview-brand-name');
      if (brandNameEl) brandNameEl.textContent = brandName;

      const taglineEl = preview.querySelector('.preview-tagline');
      if (taglineEl) taglineEl.textContent = tagline;

      // Update preview styles
      preview.style.backgroundColor = surfaceColor;
      preview.style.color = textColor;
      preview.style.borderColor = borderColor;

      const primaryBtn = preview.querySelector('.preview-btn-primary') as HTMLElement;
      if (primaryBtn) {
        primaryBtn.style.backgroundColor = primaryColor;
        primaryBtn.style.color = '#ffffff';
      }

      const secondaryBtn = preview.querySelector('.preview-btn-secondary') as HTMLElement;
      if (secondaryBtn) {
        secondaryBtn.style.backgroundColor = secondaryColor;
        secondaryBtn.style.color = '#ffffff';
      }

      const card = preview.querySelector('.preview-card') as HTMLElement;
      if (card) {
        card.style.backgroundColor = surfaceColor;
        card.style.borderColor = borderColor;
      }
    }

    async function saveBranding() {
      const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
      const saveBtnText = document.getElementById('save-btn-text');
      const saveBtnLoading = document.getElementById('save-btn-loading');

      try {
        saveBtn.disabled = true;
        saveBtnText?.classList.add('hidden');
        saveBtnLoading?.classList.remove('hidden');

        const updates = {
          brand_name: (document.getElementById('brand_name') as HTMLInputElement).value,
          tagline: (document.getElementById('tagline') as HTMLInputElement).value,
          primary_color: (document.getElementById('primary_color') as HTMLInputElement).value,
          secondary_color: (document.getElementById('secondary_color') as HTMLInputElement).value,
          background_color: (document.getElementById('background_color') as HTMLInputElement).value,
          surface_color: (document.getElementById('surface_color') as HTMLInputElement).value,
          text_color: (document.getElementById('text_color') as HTMLInputElement).value,
          border_color: (document.getElementById('border_color') as HTMLInputElement).value,
          font_family_heading: (document.getElementById('font_family_heading') as HTMLInputElement).value,
          font_family_body: (document.getElementById('font_family_body') as HTMLInputElement).value,
          font_family_mono: (document.getElementById('font_family_mono') as HTMLInputElement).value,
          border_radius: (document.getElementById('border_radius') as HTMLInputElement).value,
          button_style: (document.getElementById('button_style') as HTMLSelectElement).value
        };

        const { data: { session } } = await supabase.auth.getSession();
        const token = session?.access_token;

        const response = await fetch('/api/admin/config/branding', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updates)
        });

        if (!response.ok) throw new Error('Failed to save branding');

        showSuccess();
        await loadBranding();
      } catch (error) {
        console.error('Error saving branding:', error);
        showError('Failed to save changes');
      } finally {
        saveBtn.disabled = false;
        saveBtnText?.classList.remove('hidden');
        saveBtnLoading?.classList.add('hidden');
      }
    }

    function showSuccess() {
      const toast = document.getElementById('success-toast');
      toast?.classList.remove('hidden');
      setTimeout(() => toast?.classList.add('hidden'), 3000);
    }

    function showError(message: string) {
      const toast = document.getElementById('error-toast');
      const messageEl = document.getElementById('error-message');
      if (messageEl) messageEl.textContent = message;
      toast?.classList.remove('hidden');
      setTimeout(() => toast?.classList.add('hidden'), 3000);
    }

    async function init() {
      const hasAccess = await checkAdminAccess();
      if (!hasAccess) return;

      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('settings-content')?.classList.remove('hidden');

      await loadBranding();

      // Setup color pickers
      const colorFields = ['primary_color', 'secondary_color', 'background_color', 'surface_color', 'text_color', 'border_color'];
      colorFields.forEach(field => {
        const picker = document.getElementById(field) as HTMLInputElement;
        const hex = document.getElementById(`${field}_hex`) as HTMLInputElement;

        picker?.addEventListener('input', (e) => {
          hex.value = (e.target as HTMLInputElement).value;
          updatePreview();
        });

        hex?.addEventListener('input', (e) => {
          picker.value = (e.target as HTMLInputElement).value;
          updatePreview();
        });
      });

      // Setup real-time preview updates
      document.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('input', updatePreview);
      });

      // Save button
      document.getElementById('save-btn')?.addEventListener('click', saveBranding);

      // Reset button
      document.getElementById('reset-btn')?.addEventListener('click', () => {
        if (confirm('Reset all branding settings to defaults?')) {
          populateForm(currentBranding);
          updatePreview();
        }
      });

    }

    init();
  </script>
</AdminLayout>
