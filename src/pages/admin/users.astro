---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="User Management - Admin - C4C Campus" currentPage="users">
    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading users...</p>
      </div>
    </div>

    <!-- Access Denied State -->
    <div id="access-denied" class="hidden container mx-auto px-4 py-12">
      <div class="max-w-md mx-auto text-center">
        <div class="card">
          <h2 class="text-2xl font-bold mb-4">Access Denied</h2>
          <p class="text-text-muted mb-6">You need admin privileges to access this page.</p>
          <a href="/dashboard" class="btn btn-primary">Go to Dashboard</a>
        </div>
      </div>
    </div>

    <!-- User Management Content -->
    <div id="users-content" class="hidden">
      <div class="container mx-auto px-4 py-8">
        <!-- Filters and Bulk Actions -->
        <div class="card mb-6">
          <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
            <div class="flex-1 flex gap-4">
              <!-- Search -->
              <input
                type="text"
                id="search-input"
                placeholder="Search by name or email..."
                class="border border-border rounded-lg px-4 py-2 bg-background flex-1"
              />

              <!-- Role Filter -->
              <select id="role-filter" class="border border-border rounded-lg px-4 py-2 bg-background">
                <option value="">All Roles</option>
                <option value="student">Students</option>
                <option value="teacher">Teachers</option>
                <option value="admin">Admins</option>
              </select>
            </div>

            <!-- Bulk Actions -->
            <div class="flex gap-2">
              <button id="bulk-student-btn" class="btn btn-secondary btn-sm" disabled>
                Make Students
              </button>
              <button id="bulk-teacher-btn" class="btn btn-secondary btn-sm" disabled>
                Make Teachers
              </button>
              <button id="bulk-admin-btn" class="btn btn-secondary btn-sm" disabled>
                Make Admins
              </button>
            </div>
          </div>
          <p class="text-sm text-text-muted mt-2" id="selection-count">
            0 users selected
          </p>
        </div>

        <!-- Users Table -->
        <div class="card">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-border">
                  <th class="text-left p-4">
                    <input type="checkbox" id="select-all" class="rounded" />
                  </th>
                  <th class="text-left p-4">Name</th>
                  <th class="text-left p-4">Email</th>
                  <th class="text-left p-4">Role</th>
                  <th class="text-left p-4">Status</th>
                  <th class="text-left p-4">Joined</th>
                  <th class="text-left p-4">Actions</th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <tr>
                  <td colspan="7" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Role Change Confirmation Modal -->
  <div id="role-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="card max-w-md mx-4">
      <h3 class="text-xl font-bold mb-4">Confirm Role Change</h3>
      <p class="text-text-muted mb-6" id="role-modal-message">
        Are you sure you want to change this user's role?
      </p>
      <div class="flex gap-3 justify-end">
        <button id="role-modal-cancel" class="btn btn-ghost">Cancel</button>
        <button id="role-modal-confirm" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';
    import { showToast, showConfirm } from '../../lib/notifications';

    let currentUser: any = null;
    let allUsers: any[] = [];
    let filteredUsers: any[] = [];
    let selectedUserIds = new Set<string>();
    let pendingRoleChange: { userId: string, newRole: string } | null = null;

    async function checkAdminAccess() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login';
        return false;
      }

      currentUser = session.user;

      const { data: application } = await supabase
        .from('applications')
        .select('role')
        .eq('user_id', currentUser.id)
        .single();

      if (!application || application.role !== 'admin') {
        document.getElementById('loading-state')?.classList.add('hidden');
        document.getElementById('access-denied')?.classList.remove('hidden');
        return false;
      }

      return true;
    }

    async function loadUsers() {
      try {
        const { data: applications, error } = await supabase
          .from('applications')
          .select('user_id, name, email, role, status, created_at')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allUsers = applications || [];
        filteredUsers = [...allUsers];
        renderUsers();

      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-table-body')!.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-8 text-red-500">
              Error loading users. Please try again.
            </td>
          </tr>
        `;
      }
    }

    function filterUsers() {
      const searchTerm = (document.getElementById('search-input') as HTMLInputElement).value.toLowerCase();
      const roleFilter = (document.getElementById('role-filter') as HTMLSelectElement).value;

      filteredUsers = allUsers.filter(user => {
        const matchesSearch = user.name.toLowerCase().includes(searchTerm) ||
                             user.email.toLowerCase().includes(searchTerm);
        const matchesRole = !roleFilter || user.role === roleFilter;
        return matchesSearch && matchesRole;
      });

      renderUsers();
    }

    function renderUsers() {
      const tbody = document.getElementById('users-table-body')!;

      if (filteredUsers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-8 text-text-muted">
              No users found
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredUsers.map(user => {
        const roleColor = user.role === 'admin' ? 'bg-red-500/10 text-red-500' :
                         user.role === 'teacher' ? 'bg-blue-500/10 text-blue-500' :
                         'bg-gray-500/10 text-gray-500';

        const statusColor = user.status === 'approved' ? 'text-green-500' :
                           user.status === 'pending' ? 'text-yellow-500' :
                           'text-red-500';

        const isChecked = selectedUserIds.has(user.user_id);

        return `
          <tr class="border-b border-border hover:bg-surface-hover">
            <td class="p-4">
              <input type="checkbox" class="user-checkbox rounded" data-user-id="${user.user_id}" ${isChecked ? 'checked' : ''} />
            </td>
            <td class="p-4 font-medium">${user.name}</td>
            <td class="p-4 text-text-muted">${user.email}</td>
            <td class="p-4">
              <span class="px-2 py-1 rounded text-xs font-medium ${roleColor}">
                ${user.role}
              </span>
            </td>
            <td class="p-4">
              <span class="${statusColor}">
                ${user.status}
              </span>
            </td>
            <td class="p-4 text-text-muted text-sm">
              ${new Date(user.created_at).toLocaleDateString()}
            </td>
            <td class="p-4">
              <select class="role-select border border-border rounded px-2 py-1 text-sm bg-background" data-user-id="${user.user_id}" data-current-role="${user.role}">
                <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
                <option value="teacher" ${user.role === 'teacher' ? 'selected' : ''}>Teacher</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
              </select>
            </td>
          </tr>
        `;
      }).join('');

      // Attach event listeners
      attachEventListeners();
      updateSelectionCount();
    }

    function attachEventListeners() {
      // Individual checkboxes
      document.querySelectorAll('.user-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const userId = (e.target as HTMLInputElement).dataset.userId!;
          if ((e.target as HTMLInputElement).checked) {
            selectedUserIds.add(userId);
          } else {
            selectedUserIds.delete(userId);
          }
          updateSelectionCount();
        });
      });

      // Role selects
      document.querySelectorAll('.role-select').forEach(select => {
        select.addEventListener('change', async (e) => {
          const userId = (e.target as HTMLSelectElement).dataset.userId!;
          const currentRole = (e.target as HTMLSelectElement).dataset.currentRole!;
          const newRole = (e.target as HTMLSelectElement).value;

          if (newRole === currentRole) return;

          // Show confirmation modal
          pendingRoleChange = { userId, newRole };
          showRoleModal(`Change user role from ${currentRole} to ${newRole}?`);

          // Reset select while waiting for confirmation
          (e.target as HTMLSelectElement).value = currentRole;
        });
      });
    }

    function updateSelectionCount() {
      const count = selectedUserIds.size;
      document.getElementById('selection-count')!.textContent = `${count} user${count !== 1 ? 's' : ''} selected`;

      // Enable/disable bulk action buttons
      const bulkButtons = ['bulk-student-btn', 'bulk-teacher-btn', 'bulk-admin-btn'];
      bulkButtons.forEach(id => {
        const btn = document.getElementById(id) as HTMLButtonElement;
        btn.disabled = count === 0;
      });

      // Update select-all checkbox state
      const selectAllCheckbox = document.getElementById('select-all') as HTMLInputElement;
      if (count === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (count === filteredUsers.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      }
    }

    async function updateUserRole(userId: string, newRole: string) {
      try {
        const { error } = await supabase
          .from('applications')
          .update({ role: newRole })
          .eq('user_id', userId);

        if (error) throw error;

        // Update local data
        const user = allUsers.find(u => u.user_id === userId);
        if (user) {
          user.role = newRole;
        }

        renderUsers();
        return true;

      } catch (error) {
        console.error('Error updating role:', error);
        showToast('Failed to update user role. Please try again.', 'error');
        return false;
      }
    }

    async function bulkUpdateRoles(role: string) {
      if (selectedUserIds.size === 0) return;

      showConfirm(`Change role to ${role} for ${selectedUserIds.size} user(s)?`, async () => {
        const loadingId = showToast('Updating user roles...', 'info', 0);

        try {
          const userIds = Array.from(selectedUserIds);

          const { error } = await supabase
            .from('applications')
            .update({ role })
            .in('user_id', userIds);

          if (error) throw error;

          // Update local data
          userIds.forEach(userId => {
            const user = allUsers.find(u => u.user_id === userId);
            if (user) {
              user.role = role;
            }
          });

          selectedUserIds.clear();
          renderUsers();
          dismissToast(loadingId);
          showToast(`Successfully updated ${userIds.length} user(s)`, 'success');

        } catch (error) {
          console.error('Error in bulk update:', error);
          dismissToast(loadingId);
          showToast('Failed to update roles. Please try again.', 'error');
        }
      });
    }

    function showRoleModal(message: string) {
      document.getElementById('role-modal-message')!.textContent = message;
      document.getElementById('role-modal')?.classList.remove('hidden');
    }

    function hideRoleModal() {
      document.getElementById('role-modal')?.classList.add('hidden');
      pendingRoleChange = null;
    }

    async function initUsersPage() {
      const hasAccess = await checkAdminAccess();
      if (!hasAccess) return;

      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('users-content')?.classList.remove('hidden');

      await loadUsers();
    }

    // Event Listeners
    document.getElementById('search-input')?.addEventListener('input', filterUsers);
    document.getElementById('role-filter')?.addEventListener('change', filterUsers);

    document.getElementById('select-all')?.addEventListener('change', (e) => {
      const checked = (e.target as HTMLInputElement).checked;
      if (checked) {
        filteredUsers.forEach(user => selectedUserIds.add(user.user_id));
      } else {
        selectedUserIds.clear();
      }
      renderUsers();
    });

    document.getElementById('bulk-student-btn')?.addEventListener('click', () => bulkUpdateRoles('student'));
    document.getElementById('bulk-teacher-btn')?.addEventListener('click', () => bulkUpdateRoles('teacher'));
    document.getElementById('bulk-admin-btn')?.addEventListener('click', () => bulkUpdateRoles('admin'));

    document.getElementById('role-modal-cancel')?.addEventListener('click', hideRoleModal);
    document.getElementById('role-modal-confirm')?.addEventListener('click', async () => {
      if (pendingRoleChange) {
        const success = await updateUserRole(pendingRoleChange.userId, pendingRoleChange.newRole);
        if (success) {
          hideRoleModal();
        }
      }
    });

    // Initialize
    initUsersPage();
  </script>
</AdminLayout>
