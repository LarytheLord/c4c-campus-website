---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Analytics Dashboard - Admin - C4C Campus" currentPage="analytics">
    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading analytics...</p>
      </div>
    </div>

    <!-- Access Denied State -->
    <div id="access-denied" class="hidden container mx-auto px-4 py-12">
      <div class="max-w-md mx-auto text-center">
        <div class="card">
          <h2 class="text-2xl font-bold mb-4">Access Denied</h2>
          <p class="text-text-muted mb-6">You need admin privileges to access this page.</p>
          <a href="/admin/dashboard" class="btn btn-primary">Go to Admin Dashboard</a>
        </div>
      </div>
    </div>

    <!-- Analytics Content -->
    <div id="analytics-content" class="hidden">
      <div class="container mx-auto px-4 py-8">
        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="card">
            <div class="text-sm text-text-muted mb-1">Total Students</div>
            <div class="text-3xl font-bold" id="metric-students">-</div>
            <div class="text-xs text-green-500 mt-1" id="metric-students-change">-</div>
          </div>
          <div class="card">
            <div class="text-sm text-text-muted mb-1">Active Enrollments</div>
            <div class="text-3xl font-bold" id="metric-enrollments">-</div>
            <div class="text-xs text-text-muted mt-1" id="metric-enrollments-change">-</div>
          </div>
          <div class="card">
            <div class="text-sm text-text-muted mb-1">Avg Completion Rate</div>
            <div class="text-3xl font-bold" id="metric-completion">-%</div>
            <div class="text-xs text-text-muted mt-1">Across all courses</div>
          </div>
          <div class="card">
            <div class="text-sm text-text-muted mb-1">Total Watch Time</div>
            <div class="text-3xl font-bold" id="metric-watchtime">-h</div>
            <div class="text-xs text-text-muted mt-1">Student engagement</div>
          </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Enrollment Trend -->
          <div class="card">
            <h3 class="text-lg font-bold mb-4">Enrollment Trend (Last 30 Days)</h3>
            <div class="h-64 flex items-center justify-center">
              <canvas id="enrollment-chart"></canvas>
            </div>
          </div>

          <!-- Course Popularity -->
          <div class="card">
            <h3 class="text-lg font-bold mb-4">Top Courses by Enrollment</h3>
            <div class="h-64 flex items-center justify-center">
              <canvas id="courses-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Completion Rates -->
          <div class="card">
            <h3 class="text-lg font-bold mb-4">Course Completion Rates</h3>
            <div id="completion-list" class="space-y-3">
              <!-- Will be populated dynamically -->
            </div>
          </div>

          <!-- User Role Distribution -->
          <div class="card">
            <h3 class="text-lg font-bold mb-4">User Role Distribution</h3>
            <div class="h-64 flex items-center justify-center">
              <canvas id="roles-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Cohort Analytics -->
        <div class="card mb-8">
          <h3 class="text-lg font-bold mb-4">Active Cohorts Performance</h3>
          <div id="cohorts-loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
          </div>
          <div id="cohorts-list" class="hidden overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-border">
                  <th class="text-left p-3">Cohort</th>
                  <th class="text-left p-3">Course</th>
                  <th class="text-left p-3">Students</th>
                  <th class="text-left p-3">Avg Completion</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">Start Date</th>
                </tr>
              </thead>
              <tbody id="cohorts-table-body">
                <!-- Will be populated -->
              </tbody>
            </table>
          </div>
          <div id="cohorts-empty" class="hidden text-center py-8 text-text-muted">
            No active cohorts
          </div>
        </div>

        <!-- System Health -->
        <div class="card">
          <h3 class="text-lg font-bold mb-4">System Health Metrics</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <div class="text-sm text-text-muted mb-2">Database Size</div>
              <div class="text-xl font-bold" id="health-db-size">Calculating...</div>
            </div>
            <div>
              <div class="text-sm text-text-muted mb-2">Total Records</div>
              <div class="text-xl font-bold" id="health-records">-</div>
            </div>
            <div>
              <div class="text-sm text-text-muted mb-2">API Response Time</div>
              <div class="text-xl font-bold" id="health-response">-ms</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';
    import { Chart, registerables } from 'chart.js';

    Chart.register(...registerables);

    let currentUser: any = null;
    let enrollmentChart: Chart | null = null;
    let coursesChart: Chart | null = null;
    let rolesChart: Chart | null = null;

    async function checkAdminAccess() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login';
        return false;
      }

      currentUser = session.user;

      const { data: application } = await supabase
        .from('applications')
        .select('role')
        .eq('user_id', currentUser.id)
        .single();

      if (!application || application.role !== 'admin') {
        document.getElementById('loading-state')?.classList.add('hidden');
        document.getElementById('access-denied')?.classList.remove('hidden');
        return false;
      }

      return true;
    }

    async function loadKeyMetrics() {
      try {
        const startTime = Date.now();

        // Get total students
        const { count: studentCount } = await supabase
          .from('applications')
          .select('id', { count: 'exact', head: true })
          .eq('role', 'student');

        // Get active enrollments
        const { count: enrollmentCount } = await supabase
          .from('enrollments')
          .select('id', { count: 'exact', head: true })
          .eq('status', 'active');

        // Get completion stats using COUNT queries (more efficient than fetching all rows)
        const { count: totalProgressCount } = await supabase
          .from('lesson_progress')
          .select('id', { count: 'exact', head: true });

        const { count: completedLessonsCount } = await supabase
          .from('lesson_progress')
          .select('id', { count: 'exact', head: true })
          .eq('completed', true);

        // Get total watch time (with limit for safety on large datasets)
        const { data: progressData } = await supabase
          .from('lesson_progress')
          .select('time_spent_seconds')
          .limit(10000);

        const responseTime = Date.now() - startTime;

        // Calculate metrics using counts instead of client-side filtering
        const completedLessons = completedLessonsCount || 0;
        const totalLessons = totalProgressCount || 1;
        const completionRate = Math.round((completedLessons / totalLessons) * 100);

        const totalSeconds = progressData?.reduce((sum, p) => sum + (p.time_spent_seconds || 0), 0) || 0;
        const totalHours = Math.round(totalSeconds / 3600);

        // Update UI
        document.getElementById('metric-students')!.textContent = studentCount?.toString() || '0';
        document.getElementById('metric-enrollments')!.textContent = enrollmentCount?.toString() || '0';
        document.getElementById('metric-completion')!.textContent = completionRate + '%';
        document.getElementById('metric-watchtime')!.textContent = totalHours.toLocaleString() + 'h';
        document.getElementById('health-response')!.textContent = responseTime + 'ms';

      } catch (error) {
        console.error('Error loading metrics:', error);
      }
    }

    async function loadEnrollmentTrend() {
      try {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const { data: enrollments } = await supabase
          .from('enrollments')
          .select('enrolled_at')
          .gte('enrolled_at', thirtyDaysAgo.toISOString())
          .order('enrolled_at', { ascending: true });

        // Group by day - include today (31 days total: 30 days ago through today)
        const dailyCounts: { [key: string]: number } = {};
        const labels: string[] = [];

        for (let i = 0; i <= 30; i++) {
          const date = new Date(thirtyDaysAgo);
          date.setDate(date.getDate() + i);
          const dateStr = date.toISOString().split('T')[0];
          dailyCounts[dateStr] = 0;
          labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        }

        enrollments?.forEach(enrollment => {
          const date = enrollment.enrolled_at.split('T')[0];
          if (dailyCounts[date] !== undefined) {
            dailyCounts[date]++;
          }
        });

        const data = Object.values(dailyCounts);

        // Create chart
        const ctx = document.getElementById('enrollment-chart') as HTMLCanvasElement;
        enrollmentChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'New Enrollments',
              data,
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });

      } catch (error) {
        console.error('Error loading enrollment trend:', error);
      }
    }

    async function loadCoursePopularity() {
      try {
        const { data: enrollments } = await supabase
          .from('enrollments')
          .select('course_id, courses(title)')
          .limit(10000);

        // Count enrollments per course
        const courseCounts: { [key: string]: number } = {};
        const courseNames: { [key: number]: string } = {};

        enrollments?.forEach(enrollment => {
          const courseId = enrollment.course_id;
          const courseName = (enrollment.courses as any)?.title || 'Unknown';
          courseNames[courseId] = courseName;
          courseCounts[courseName] = (courseCounts[courseName] || 0) + 1;
        });

        // Get top 5 courses
        const sorted = Object.entries(courseCounts)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5);

        const labels = sorted.map(([name]) => name);
        const data = sorted.map(([,count]) => count);

        // Create chart
        const ctx = document.getElementById('courses-chart') as HTMLCanvasElement;
        coursesChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Enrollments',
              data,
              backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(251, 191, 36, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(139, 92, 246, 0.8)'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { beginAtZero: true }
            }
          }
        });

      } catch (error) {
        console.error('Error loading course popularity:', error);
      }
    }

    async function loadCompletionRates() {
      try {
        // Batch fetch: get courses and all enrollments in 2 queries instead of 2*N
        const [coursesResult, enrollmentsResult] = await Promise.all([
          supabase.from('courses').select('id, title').limit(10),
          supabase.from('enrollments').select('course_id, status').limit(10000)
        ]);

        const courses = coursesResult.data;
        const enrollments = enrollmentsResult.data;

        if (!courses) return;

        const completionList = document.getElementById('completion-list')!;

        // Process enrollments in memory
        const courseEnrollments: Record<number, { total: number; completed: number }> = {};
        enrollments?.forEach(e => {
          if (!courseEnrollments[e.course_id]) {
            courseEnrollments[e.course_id] = { total: 0, completed: 0 };
          }
          courseEnrollments[e.course_id].total++;
          if (e.status === 'completed') {
            courseEnrollments[e.course_id].completed++;
          }
        });

        const courseStats = courses.map(course => {
          const stats = courseEnrollments[course.id] || { total: 0, completed: 0 };
          const rate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
          return { name: course.title, rate };
        });

        completionList.innerHTML = courseStats
          .sort((a, b) => b.rate - a.rate)
          .map(stat => `
            <div>
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium">${stat.name}</span>
                <span class="text-sm text-text-muted">${stat.rate}%</span>
              </div>
              <div class="w-full bg-surface-hover rounded-full h-2">
                <div class="bg-primary h-2 rounded-full" style="width: ${stat.rate}%"></div>
              </div>
            </div>
          `).join('');

      } catch (error) {
        console.error('Error loading completion rates:', error);
      }
    }

    async function loadRoleDistribution() {
      try {
        const { data: applications } = await supabase
          .from('applications')
          .select('role')
          .limit(10000);

        const roleCounts = {
          student: 0,
          teacher: 0,
          admin: 0
        };

        applications?.forEach(app => {
          if (app.role in roleCounts) {
            roleCounts[app.role as keyof typeof roleCounts]++;
          }
        });

        const ctx = document.getElementById('roles-chart') as HTMLCanvasElement;
        rolesChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Students', 'Teachers', 'Admins'],
            datasets: [{
              data: [roleCounts.student, roleCounts.teacher, roleCounts.admin],
              backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(239, 68, 68, 0.8)'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });

      } catch (error) {
        console.error('Error loading role distribution:', error);
      }
    }

    async function loadCohortAnalytics() {
      const loadingEl = document.getElementById('cohorts-loading');
      const listEl = document.getElementById('cohorts-list');
      const emptyEl = document.getElementById('cohorts-empty');
      const tbody = document.getElementById('cohorts-table-body')!;

      try {
        const { data: cohorts } = await supabase
          .from('cohorts')
          .select('id, name, start_date, status, course_id, courses(title)')
          .eq('status', 'active');

        loadingEl?.classList.add('hidden');

        if (!cohorts || cohorts.length === 0) {
          emptyEl?.classList.remove('hidden');
          return;
        }

        // Batch fetch: get all enrollments and progress for all cohorts in 2 queries
        const cohortIds = cohorts.map(c => c.id);

        const [enrollmentsResult, progressResult] = await Promise.all([
          supabase.from('cohort_enrollments').select('cohort_id, user_id').in('cohort_id', cohortIds),
          supabase.from('lesson_progress').select('cohort_id, user_id, completed').in('cohort_id', cohortIds).eq('completed', true)
        ]);

        const allEnrollments = enrollmentsResult.data || [];
        const allProgress = progressResult.data || [];

        // Group enrollments by cohort_id
        const enrollmentsByCohort: Record<string, string[]> = {};
        allEnrollments.forEach(e => {
          if (!enrollmentsByCohort[e.cohort_id]) {
            enrollmentsByCohort[e.cohort_id] = [];
          }
          enrollmentsByCohort[e.cohort_id].push(e.user_id);
        });

        // Count completed lessons by cohort_id
        const completedByCohort: Record<string, number> = {};
        allProgress.forEach(p => {
          if (!completedByCohort[p.cohort_id]) {
            completedByCohort[p.cohort_id] = 0;
          }
          completedByCohort[p.cohort_id]++;
        });

        // Calculate stats for each cohort
        const cohortStats = cohorts.map(cohort => {
          const studentIds = enrollmentsByCohort[cohort.id] || [];
          const studentCount = studentIds.length;
          const completedCount = completedByCohort[cohort.id] || 0;
          const avgCompletion = studentCount > 0 ? Math.round(completedCount / studentCount) : 0;

          return {
            ...cohort,
            studentCount,
            avgCompletion
          };
        });

        tbody.innerHTML = cohortStats.map(cohort => `
          <tr class="border-b border-border">
            <td class="p-3 font-medium">${cohort.name}</td>
            <td class="p-3 text-text-muted">${(cohort.courses as any)?.title || 'Unknown'}</td>
            <td class="p-3">${cohort.studentCount}</td>
            <td class="p-3">${cohort.avgCompletion} lessons</td>
            <td class="p-3">
              <span class="px-2 py-1 rounded text-xs font-medium bg-green-500/10 text-green-500">
                ${cohort.status}
              </span>
            </td>
            <td class="p-3 text-text-muted text-sm">
              ${new Date(cohort.start_date).toLocaleDateString()}
            </td>
          </tr>
        `).join('');

        listEl?.classList.remove('hidden');

      } catch (error) {
        console.error('Error loading cohort analytics:', error);
        loadingEl?.classList.add('hidden');
        emptyEl?.classList.remove('hidden');
      }
    }

    async function loadSystemHealth() {
      try {
        // Count total records
        const [courses, enrollments, applications, lessons] = await Promise.all([
          supabase.from('courses').select('id', { count: 'exact', head: true }),
          supabase.from('enrollments').select('id', { count: 'exact', head: true }),
          supabase.from('applications').select('id', { count: 'exact', head: true }),
          supabase.from('lessons').select('id', { count: 'exact', head: true })
        ]);

        const totalRecords = (courses.count || 0) + (enrollments.count || 0) +
                            (applications.count || 0) + (lessons.count || 0);

        document.getElementById('health-records')!.textContent = totalRecords.toLocaleString();
        document.getElementById('health-db-size')!.textContent = 'N/A';

      } catch (error) {
        console.error('Error loading system health:', error);
      }
    }

    async function initAnalytics() {
      const hasAccess = await checkAdminAccess();
      if (!hasAccess) return;

      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('analytics-content')?.classList.remove('hidden');

      // Load all analytics
      await Promise.all([
        loadKeyMetrics(),
        loadEnrollmentTrend(),
        loadCoursePopularity(),
        loadCompletionRates(),
        loadRoleDistribution(),
        loadCohortAnalytics(),
        loadSystemHealth()
      ]);
    }

    // Initialize
    initAnalytics().catch(error => {
      console.error('Failed to initialize analytics:', error);
      document.getElementById('loading-state')?.classList.add('hidden');
      // Show a user-friendly error instead of infinite spinner
      const content = document.getElementById('analytics-content');
      if (content) {
        content.classList.remove('hidden');
        content.innerHTML = `
          <div class="container mx-auto px-4 py-12">
            <div class="max-w-md mx-auto text-center card">
              <h2 class="text-2xl font-bold mb-4">Failed to Load Analytics</h2>
              <p class="text-text-muted mb-6">An error occurred while loading the analytics dashboard. Please try refreshing the page.</p>
              <button onclick="window.location.reload()" class="btn btn-primary">Refresh Page</button>
            </div>
          </div>
        `;
      }
    });
  </script>
</AdminLayout>
