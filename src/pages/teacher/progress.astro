---
/**
 * Teacher Progress Dashboard Page
 * Displays comprehensive analytics for cohort progress:
 * - Overview statistics
 * - Progress charts
 * - Struggling students alerts
 * - Leaderboard
 * - CSV export functionality
 * - Auto-refresh every 5 minutes
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import CohortStats from '../../components/CohortStats';
import ProgressChart from '../../components/ProgressChart';
import StrugglingStudents from '../../components/StrugglingStudents';
import Leaderboard from '../../components/Leaderboard';
---

<BaseLayout title="Progress Dashboard - Teacher - C4C Campus" hideHeader={true} hideFooter={true}>
  <div class="min-h-screen bg-background">
    <!-- Teacher Header -->
    <div class="sticky top-0 z-50 bg-surface border-b border-border">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
            <a href="/teacher/courses" class="flex-shrink-0">
              <img src="/logo.jpeg" alt="C4C Campus" class="h-10 w-10 rounded-lg" />
            </a>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold">Progress Dashboard</h1>
              <p class="text-text-muted text-sm" id="subtitle">Track student progress and engagement</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="refresh-btn" class="btn btn-ghost btn-sm" title="Refresh data">
              <span id="refresh-icon">ðŸ”„</span> Refresh
            </button>
            <button id="export-btn" class="hidden btn btn-secondary btn-sm" title="Export to CSV">
              ðŸ“Š Export CSV
            </button>
            <a href="/teacher/courses" class="btn btn-ghost btn-sm">
              Back to Dashboard
            </a>
            <button id="logout-btn" class="btn btn-ghost text-sm">
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading dashboard...</p>
      </div>
    </div>

    <!-- Access Denied -->
    <div id="access-denied" class="hidden container mx-auto px-4 py-12">
      <div class="max-w-md mx-auto text-center">
        <div class="card">
          <h2 class="text-2xl font-bold mb-4">Access Denied</h2>
          <p class="text-text-muted mb-6">You need teacher or admin privileges to access this page.</p>
          <a href="/dashboard" class="btn btn-primary">
            Go to Dashboard
          </a>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden container mx-auto px-4 py-8">
      <!-- Breadcrumbs -->
      <nav class="mb-6 text-sm text-text-muted">
        <a href="/dashboard" class="hover:text-primary transition-colors">Dashboard</a>
        <span class="mx-2">/</span>
        <a href="/teacher/courses" class="hover:text-primary transition-colors">Teacher</a>
        <span class="mx-2">/</span>
        <span>Progress Dashboard</span>
      </nav>

      <!-- Cohort Selector -->
      <div class="card mb-8">
        <div class="flex items-center justify-between gap-4">
          <div class="flex-1">
            <label class="block text-sm font-medium mb-2">Select Cohort</label>
            <select id="cohort-selector" class="w-full md:w-96 border border-gray-300 rounded-lg px-4 py-2 bg-white">
              <option value="">Loading cohorts...</option>
            </select>
          </div>
          <div class="text-right">
            <p class="text-sm text-text-muted">Last updated</p>
            <p class="text-sm font-medium" id="last-updated">Just now</p>
          </div>
        </div>
      </div>

      <!-- Dashboard Widgets Container -->
      <div id="dashboard-widgets">
        <!-- CohortStats Component -->
        <div id="cohort-stats-container"></div>

        <!-- Grid Layout for Charts and Alerts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <!-- Progress Charts (2 columns) -->
          <div class="lg:col-span-2">
            <div id="progress-chart-container"></div>
          </div>

          <!-- Struggling Students (1 column) -->
          <div class="lg:col-span-1">
            <div id="struggling-students-container"></div>
          </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard-container"></div>
      </div>

      <!-- No Cohort Selected -->
      <div id="no-cohort" class="hidden text-center py-12">
        <div class="text-6xl mb-4">ðŸ“Š</div>
        <h3 class="text-xl font-semibold mb-2">Select a Cohort</h3>
        <p class="text-text-muted mb-4">Choose a cohort from the dropdown above to view progress analytics.</p>
      </div>

      <!-- No Data -->
      <div id="no-data" class="hidden text-center py-12">
        <div class="text-6xl mb-4">ðŸ“­</div>
        <h3 class="text-xl font-semibold mb-2">No Data Available</h3>
        <p class="text-text-muted mb-4">This cohort doesn't have any student data yet.</p>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';
    import { exportToCSV } from '../../lib/utils';
    import CohortStats from '../../components/CohortStats';
    import ProgressChart from '../../components/ProgressChart';
    import StrugglingStudents from '../../components/StrugglingStudents';
    import Leaderboard from '../../components/Leaderboard';
    import { createElement } from 'react';
    import { createRoot } from 'react-dom/client';

    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
    const supabase = createClient(supabaseUrl!, supabaseAnonKey!);

    let currentUser: any = null;
    let cohorts: any[] = [];
    let currentCohortId: number | null = null;
    let dashboardData: any = null;
    let autoRefreshInterval: number | null = null;

    // React roots for components
    let statsRoot: any = null;
    let chartRoot: any = null;
    let strugglingRoot: any = null;
    let leaderboardRoot: any = null;

    async function init() {
      // Check authentication
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        window.location.href = '/login';
        return;
      }

      currentUser = user;

      // Verify teacher role
      const { data: application } = await supabase
        .from('applications')
        .select('name, role')
        .eq('user_id', user.id)
        .single();

      if (!application?.role || (application.role !== 'teacher' && application.role !== 'admin')) {
        document.getElementById('loading-state')?.classList.add('hidden');
        document.getElementById('access-denied')?.classList.remove('hidden');
        return;
      }

      // Load cohorts
      await loadCohorts();

      // Show content
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('main-content')?.classList.remove('hidden');

      setupEventListeners();
      setupAutoRefresh();
    }

    async function loadCohorts() {
      // Fetch teacher's courses
      const { data: courses } = await supabase
        .from('courses')
        .select('id')
        .eq('created_by', currentUser.id);

      if (!courses || courses.length === 0) {
        const selector = document.getElementById('cohort-selector') as HTMLSelectElement;
        selector.innerHTML = '<option value="">No courses found</option>';
        return;
      }

      const courseIds = courses.map(c => c.id);

      // Fetch cohorts for these courses
      const { data, error } = await supabase
        .from('cohorts')
        .select('*, courses(name)')
        .in('course_id', courseIds)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading cohorts:', error);
        return;
      }

      cohorts = data || [];

      // Populate selector
      const selector = document.getElementById('cohort-selector') as HTMLSelectElement;
      if (cohorts.length === 0) {
        selector.innerHTML = '<option value="">No cohorts found</option>';
        document.getElementById('no-cohort')?.classList.remove('hidden');
      } else {
        selector.innerHTML = '<option value="">Select a cohort...</option>' +
          cohorts.map(c => `<option value="${c.id}">${c.name} - ${c.courses?.title || 'Unknown Course'}</option>`).join('');
      }
    }

    async function loadDashboardData(cohortId: number) {
      try {
        // Show loading state for components
        renderComponents(null, true);

        // Fetch analytics data from API
        const response = await fetch(`/api/teacher/cohort-analytics?cohortId=${cohortId}`);

        if (!response.ok) {
          throw new Error('Failed to fetch analytics data');
        }

        dashboardData = await response.json();

        // Update last updated time
        updateLastUpdatedTime();

        // Show export button
        document.getElementById('export-btn')?.classList.remove('hidden');

        // Hide no-data messages
        document.getElementById('no-cohort')?.classList.add('hidden');
        document.getElementById('no-data')?.classList.add('hidden');

        // Render components with data
        renderComponents(dashboardData, false);

      } catch (error) {
        console.error('Error loading dashboard data:', error);
        document.getElementById('no-data')?.classList.remove('hidden');
        renderComponents(null, false);
      }
    }

    function renderComponents(data: any, loading: boolean) {
      // Render CohortStats - only create root once
      const statsContainer = document.getElementById('cohort-stats-container');
      if (statsContainer && !statsRoot) {
        statsRoot = createRoot(statsContainer);
      }
      if (statsRoot) {
        statsRoot.render(
          createElement(CohortStats, {
            analytics: data?.analytics || null,
            loading
          })
        );
      }

      // Render ProgressChart - only create root once
      const chartContainer = document.getElementById('progress-chart-container');
      if (chartContainer && !chartRoot) {
        chartRoot = createRoot(chartContainer);
      }
      if (chartRoot) {
        chartRoot.render(
          createElement(ProgressChart, {
            progressData: data?.progress_over_time || [],
            loading
          })
        );
      }

      // Render StrugglingStudents - only create root once
      const strugglingContainer = document.getElementById('struggling-students-container');
      if (strugglingContainer && !strugglingRoot) {
        strugglingRoot = createRoot(strugglingContainer);
      }
      if (strugglingRoot) {
        strugglingRoot.render(
          createElement(StrugglingStudents, {
            students: data?.struggling_students || [],
            loading
          })
        );
      }

      // Render Leaderboard - only create root once
      const leaderboardContainer = document.getElementById('leaderboard-container');
      if (leaderboardContainer && !leaderboardRoot) {
        leaderboardRoot = createRoot(leaderboardContainer);
      }
      if (leaderboardRoot) {
        leaderboardRoot.render(
          createElement(Leaderboard, {
            entries: data?.leaderboard || [],
            loading
          })
        );
      }
    }

    function setupEventListeners() {
      // Cohort selector
      document.getElementById('cohort-selector')?.addEventListener('change', (e) => {
        const cohortId = parseInt((e.target as HTMLSelectElement).value);
        if (cohortId) {
          currentCohortId = cohortId;
          loadDashboardData(cohortId);
        } else {
          currentCohortId = null;
          document.getElementById('no-cohort')?.classList.remove('hidden');
          document.getElementById('export-btn')?.classList.add('hidden');
          renderComponents(null, false);
        }
      });

      // Refresh button
      document.getElementById('refresh-btn')?.addEventListener('click', async () => {
        if (currentCohortId) {
          const icon = document.getElementById('refresh-icon');
          if (icon) {
            icon.classList.add('animate-spin');
          }
          await loadDashboardData(currentCohortId);
          setTimeout(() => {
            icon?.classList.remove('animate-spin');
          }, 500);
        }
      });

      // Export button
      document.getElementById('export-btn')?.addEventListener('click', () => {
        if (dashboardData?.students) {
          const exportData = dashboardData.students.map((s: any) => ({
            student_name: s.name,
            email: s.email,
            enrolled_date: new Date(s.enrolled_at).toLocaleDateString(),
            status: s.status,
            completed_lessons: s.completed_lessons,
            total_lessons: s.total_lessons,
            completion_percentage: s.completion_percentage,
            time_spent_hours: s.time_spent_hours,
            last_activity_date: new Date(s.last_activity_at).toLocaleDateString(),
            days_since_activity: s.days_since_activity
          }));

          const cohortName = cohorts.find(c => c.id === currentCohortId)?.name || 'cohort';
          const filename = `${cohortName.toLowerCase().replace(/\s+/g, '-')}-progress-${new Date().toISOString().split('T')[0]}`;

          exportToCSV(exportData, filename);
        }
      });

      // Logout
      document.getElementById('logout-btn')?.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = '/login';
      });
    }

    function setupAutoRefresh() {
      // Auto-refresh every 5 minutes (300000ms)
      autoRefreshInterval = window.setInterval(() => {
        if (currentCohortId) {
          console.log('Auto-refreshing dashboard data...');
          loadDashboardData(currentCohortId);
        }
      }, 300000);
    }

    function updateLastUpdatedTime() {
      const lastUpdated = document.getElementById('last-updated');
      if (lastUpdated) {
        lastUpdated.textContent = new Date().toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit'
        });
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });

    // Initialize
    init();
  </script>
</BaseLayout>
