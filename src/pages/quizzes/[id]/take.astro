---
/**
 * Quiz Taking Page
 *
 * Features:
 * - Display quiz instructions
 * - Show timer (if timed)
 * - Render questions
 * - Save draft answers
 * - Submit confirmation dialog
 * - Prevent navigation during quiz
 */

import BaseLayout from '../../../layouts/BaseLayout.astro';

export const prerender = false;
---

<BaseLayout title="Take Quiz - C4C Campus" hideHeader={true} hideFooter={true}>
  <div class="min-h-screen bg-background">
    <!-- Header -->
    <div class="sticky top-0 z-50 bg-surface border-b border-border shadow-md">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
            <a href="/dashboard" class="flex-shrink-0">
              <img src="/logo.jpeg" alt="C4C Campus" class="h-10 w-10 rounded-lg" />
            </a>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold" id="quiz-title">Quiz</h1>
              <p class="text-text-muted text-sm" id="quiz-info">Loading...</p>
            </div>
          </div>

          <!-- Timer (shown when quiz has time limit) -->
          <div id="timer-container" class="hidden"></div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading quiz...</p>
      </div>
    </div>

    <!-- Instructions Modal (shown before quiz starts) -->
    <div id="instructions-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div class="bg-surface rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-4">Quiz Instructions</h2>
          <div id="instructions-content" class="prose prose-sm mb-6"></div>

          <div class="space-y-3 mb-6">
            <div class="flex items-center gap-3 text-sm">
              <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span id="passing-score-text"></span>
            </div>
            <div class="flex items-center gap-3 text-sm" id="time-limit-info">
              <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span id="time-limit-text"></span>
            </div>
            <div class="flex items-center gap-3 text-sm">
              <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span id="questions-count-text"></span>
            </div>
          </div>

          <div class="bg-warning/10 border border-warning/20 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-warning flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
              <div class="text-sm text-warning">
                <strong>Important:</strong> Once you start, you cannot pause the quiz. Make sure you have enough time to complete it.
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button id="start-quiz-btn" class="btn btn-primary flex-1">
              Start Quiz
            </button>
            <a href="#" id="cancel-btn" class="btn btn-ghost">
              Cancel
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Content -->
    <div id="quiz-content" class="hidden container mx-auto px-4 py-8 max-w-4xl">
      <!-- Progress Bar -->
      <div id="progress-container" class="mb-6"></div>

      <!-- Question Container -->
      <div id="question-container" class="mb-6"></div>

      <!-- Navigation -->
      <div class="flex items-center justify-between gap-4 pb-8">
        <button id="prev-question-btn" class="btn btn-ghost" disabled>
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Previous
        </button>

        <div class="flex gap-3">
          <button id="save-draft-btn" class="btn btn-ghost">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
            </svg>
            Save Draft
          </button>
        </div>

        <button id="next-question-btn" class="btn btn-primary">
          Next
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <button id="submit-quiz-btn" class="btn btn-success hidden">
          Submit Quiz
        </button>
      </div>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div class="bg-surface rounded-lg max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">Submit Quiz?</h3>
        <p class="text-text-muted mb-6">
          Are you sure you want to submit your quiz? You have answered <span id="answered-count"></span> out of <span id="total-count"></span> questions.
        </p>
        <div class="flex gap-3">
          <button id="confirm-submit-btn" class="btn btn-success flex-1">
            Yes, Submit
          </button>
          <button id="cancel-submit-btn" class="btn btn-ghost flex-1">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';
  import { showToast } from '@/lib/notifications';
  import type { Quiz, QuizQuestionForStudent, StartAttemptResponse } from '@/types/quiz';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl!, supabaseAnonKey!);

  let quiz: Quiz | null = null;
  let attempt: any = null;
  let questions: QuizQuestionForStudent[] = [];
  let answers: Map<string, string | string[]> = new Map();
  let currentQuestionIndex = 0;
  let timerInterval: number | null = null;
  let hasStarted = false;

  // Prevent navigation during quiz
  let preventNavigation = false;

  window.addEventListener('beforeunload', (e) => {
    if (preventNavigation && hasStarted) {
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });

  async function init() {
    // Get quiz ID and attempt ID from URL - these are UUIDs (strings)
    const pathParts = window.location.pathname.split('/');
    const quizId = pathParts[2];
    const urlParams = new URLSearchParams(window.location.search);
    const attemptId = urlParams.get('attemptId');

    if (!quizId) {
      showToast('Invalid quiz ID', 'error');
      return;
    }

    // Check authentication
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }

    try {
      if (attemptId) {
        // Continue existing attempt - attemptId is already a string (UUID)
        await loadExistingAttempt(quizId, attemptId, session.access_token);
      } else {
        // Start new attempt
        await startNewAttempt(quizId, session.access_token);
      }

      // Show instructions modal
      showInstructions();
    } catch (error) {
      console.error('Error loading quiz:', error);
      showToast('Failed to load quiz', 'error');
    }
  }

  async function startNewAttempt(quizId: string, token: string) {
    const response = await fetch(`/api/quizzes/${quizId}/start`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to start quiz');
    }

    const data: StartAttemptResponse = await response.json();

    // Get quiz details
    const quizResponse = await fetch(`/api/quizzes/${quizId}`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });

    const quizData = await quizResponse.json();
    quiz = quizData.quiz;
    attempt = data.attempt;
    questions = data.questions;

    document.getElementById('loading-state')?.classList.add('hidden');
  }

  async function loadExistingAttempt(quizId: string, attemptId: string, token: string) {
    // Load quiz and attempt data
    const [quizResponse, attemptResponse] = await Promise.all([
      fetch(`/api/quizzes/${quizId}`, {
        headers: { 'Authorization': `Bearer ${token}` },
      }),
      fetch(`/api/quizzes/${quizId}/attempts/${attemptId}`, {
        headers: { 'Authorization': `Bearer ${token}` },
      }),
    ]);

    const quizData = await quizResponse.json();
    const attemptData = await attemptResponse.json();

    quiz = quizData.quiz;
    attempt = attemptData.attempt;
    questions = attemptData.questions;

    // Load saved answers
    if (attempt.answers_json && Array.isArray(attempt.answers_json)) {
      attempt.answers_json.forEach((ans: any) => {
        answers.set(ans.question_id, ans.answer);
      });
    }

    document.getElementById('loading-state')?.classList.add('hidden');
  }

  function showInstructions() {
    if (!quiz) return;

    document.getElementById('quiz-title')!.textContent = quiz.title;
    document.getElementById('quiz-info')!.textContent = `Attempt #${attempt.attemptNumber}`;

    const modal = document.getElementById('instructions-modal')!;
    const content = document.getElementById('instructions-content')!;

    content.innerHTML = quiz.description || '<p>Read each question carefully and select your answer.</p>';
    document.getElementById('passing-score-text')!.textContent = `Passing score: ${quiz.passing_score}%`;
    document.getElementById('questions-count-text')!.textContent = `${questions.length} questions`;

    if (quiz.time_limit_minutes) {
      document.getElementById('time-limit-text')!.textContent = `Time limit: ${quiz.time_limit_minutes} minutes`;
    } else {
      document.getElementById('time-limit-info')?.classList.add('hidden');
    }

    modal.classList.remove('hidden');

    // Setup buttons
    document.getElementById('start-quiz-btn')!.onclick = startQuiz;
    document.getElementById('cancel-btn')!.onclick = (e) => {
      e.preventDefault();
      history.back();
    };
  }

  function startQuiz() {
    document.getElementById('instructions-modal')?.classList.add('hidden');
    document.getElementById('quiz-content')?.classList.remove('hidden');

    hasStarted = true;
    preventNavigation = true;

    // Start timer if needed
    if (quiz?.time_limit_minutes) {
      startTimer();
    }

    // Render first question
    renderQuestion();
    updateNavigation();
  }

  function startTimer() {
    if (!quiz || !attempt) return;

    const timerContainer = document.getElementById('timer-container')!;
    timerContainer.classList.remove('hidden');

    // Import and render timer component
    import('../../../components/QuizTimer').then(({ QuizTimer }) => {
      import('react-dom/client').then(({ createRoot }) => {
        const root = createRoot(timerContainer);
        root.render(
          QuizTimer({
            startedAt: attempt.started_at,
            timeLimit: quiz!.time_limit_minutes,
            onTimeUp: handleTimeUp,
          })
        );
      });
    });
  }

  function handleTimeUp() {
    showToast('Time is up! Submitting your quiz...', 'warning');
    setTimeout(() => {
      submitQuiz();
    }, 2000);
  }

  function renderQuestion() {
    const question = questions[currentQuestionIndex];
    if (!question) return;

    const container = document.getElementById('question-container')!;
    const progressContainer = document.getElementById('progress-container')!;

    // Render progress
    import('../../../components/QuizProgress').then(({ QuizProgress }) => {
      import('react-dom/client').then(({ createRoot }) => {
        const root = createRoot(progressContainer);
        const answeredSet = new Set(Array.from(answers.keys()).map(id =>
          questions.findIndex(q => q.id === id) + 1
        ));

        root.render(
          QuizProgress({
            currentQuestion: currentQuestionIndex + 1,
            totalQuestions: questions.length,
            answeredQuestions: answeredSet,
            showAll: true,
          })
        );
      });
    });

    // Render question
    import('../../../components/QuizQuestion').then(({ QuizQuestion }) => {
      import('react-dom/client').then(({ createRoot }) => {
        const root = createRoot(container);
        root.render(
          QuizQuestion({
            question,
            questionNumber: currentQuestionIndex + 1,
            totalQuestions: questions.length,
            value: answers.get(question.id) || '',
            onChange: (answer) => {
              answers.set(question.id, answer);
              updateNavigation();
            },
          })
        );
      });
    });
  }

  function updateNavigation() {
    const prevBtn = document.getElementById('prev-question-btn') as HTMLButtonElement;
    const nextBtn = document.getElementById('next-question-btn') as HTMLButtonElement;
    const submitBtn = document.getElementById('submit-quiz-btn') as HTMLButtonElement;

    prevBtn.disabled = currentQuestionIndex === 0;

    if (currentQuestionIndex === questions.length - 1) {
      nextBtn.classList.add('hidden');
      submitBtn.classList.remove('hidden');
    } else {
      nextBtn.classList.remove('hidden');
      submitBtn.classList.add('hidden');
    }
  }

  async function saveDraft() {
    if (!quiz || !attempt) return;

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const answersArray = Array.from(answers.entries()).map(([questionId, answer]) => ({
        questionId,
        answer,
      }));

      await fetch(`/api/quizzes/${quiz.id}/attempts/${attempt.id}/save`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ answers: answersArray }),
      });

      showToast('Draft saved', 'success');
    } catch (error) {
      console.error('Error saving draft:', error);
      showToast('Failed to save draft', 'error');
    }
  }

  async function submitQuiz() {
    if (!quiz || !attempt) return;

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const answersArray = Array.from(answers.entries()).map(([questionId, answer]) => ({
        questionId,
        answer,
      }));

      const response = await fetch(`/api/quizzes/${quiz.id}/attempts/${attempt.id}/submit`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ answers: answersArray }),
      });

      if (!response.ok) {
        throw new Error('Failed to submit quiz');
      }

      const data = await response.json();

      preventNavigation = false;
      showToast('Quiz submitted successfully!', 'success');

      // Redirect to results
      setTimeout(() => {
        window.location.href = `/quizzes/${quiz!.id}/results/${attempt.id}`;
      }, 1000);
    } catch (error) {
      console.error('Error submitting quiz:', error);
      showToast('Failed to submit quiz', 'error');
    }
  }

  function showSubmitConfirmation() {
    const modal = document.getElementById('submit-modal')!;
    document.getElementById('answered-count')!.textContent = answers.size.toString();
    document.getElementById('total-count')!.textContent = questions.length.toString();
    modal.classList.remove('hidden');
  }

  // Setup event listeners
  document.getElementById('prev-question-btn')?.addEventListener('click', () => {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      renderQuestion();
      updateNavigation();
    }
  });

  document.getElementById('next-question-btn')?.addEventListener('click', () => {
    if (currentQuestionIndex < questions.length - 1) {
      currentQuestionIndex++;
      renderQuestion();
      updateNavigation();
    }
  });

  document.getElementById('save-draft-btn')?.addEventListener('click', saveDraft);
  document.getElementById('submit-quiz-btn')?.addEventListener('click', showSubmitConfirmation);
  document.getElementById('confirm-submit-btn')?.addEventListener('click', () => {
    document.getElementById('submit-modal')?.classList.add('hidden');
    submitQuiz();
  });
  document.getElementById('cancel-submit-btn')?.addEventListener('click', () => {
    document.getElementById('submit-modal')?.classList.add('hidden');
  });

  // Auto-save every 30 seconds
  setInterval(saveDraft, 30000);

  // Initialize
  init();
</script>
</BaseLayout>
