---
/**
 * Quiz Attempts History Page
 *
 * Shows all attempts for a quiz with:
 * - List of all attempts
 * - Scores and dates
 * - Link to review each attempt
 * - Retry button (if allowed)
 */

import BaseLayout from '../../../layouts/BaseLayout.astro';

export const prerender = false;
---

<BaseLayout title="Quiz Attempts - C4C Campus" hideHeader={true} hideFooter={true}>
  <div class="min-h-screen bg-background">
    <!-- Header -->
    <div class="sticky top-0 z-50 bg-surface border-b border-border">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
            <a href="/dashboard" class="flex-shrink-0">
              <img src="/logo.jpeg" alt="C4C Campus" class="h-10 w-10 rounded-lg" />
            </a>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold" id="quiz-title">Quiz Attempts</h1>
              <p class="text-text-muted text-sm" id="breadcrumb">Loading...</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="back-btn" class="btn btn-ghost btn-sm">Back</button>
            <button id="logout-btn" class="btn btn-ghost text-sm">Sign Out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading attempts...</p>
      </div>
    </div>

    <!-- Attempts Content -->
    <div id="attempts-content" class="hidden container mx-auto px-4 py-8 max-w-4xl">
      <!-- Quiz Info Card -->
      <div class="card mb-8">
        <div class="flex items-start justify-between gap-4 mb-4">
          <div class="flex-1">
            <h2 class="text-2xl font-bold mb-2" id="quiz-title-display"></h2>
            <p class="text-text-muted" id="quiz-description"></p>
          </div>
          <button id="retry-btn" class="btn btn-primary hidden">
            Take Quiz Again
          </button>
        </div>

        <div class="flex flex-wrap gap-6 text-sm">
          <div>
            <span class="text-text-muted">Passing Score:</span>
            <span class="font-medium ml-2" id="passing-score"></span>
          </div>
          <div>
            <span class="text-text-muted">Max Attempts:</span>
            <span class="font-medium ml-2" id="max-attempts"></span>
          </div>
          <div>
            <span class="text-text-muted">Your Best Score:</span>
            <span class="font-bold ml-2" id="best-score"></span>
          </div>
        </div>
      </div>

      <!-- Attempts List -->
      <div class="space-y-4">
        <h3 class="text-xl font-bold mb-4">Your Attempts</h3>
        <div id="attempts-list">
          <!-- Attempts will be rendered here -->
        </div>

        <div id="no-attempts" class="hidden card text-center py-12">
          <svg class="w-16 h-16 mx-auto text-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <h3 class="text-xl font-bold mb-2">No Attempts Yet</h3>
          <p class="text-text-muted mb-6">You haven't taken this quiz yet.</p>
          <button id="start-quiz-btn" class="btn btn-primary">
            Take Quiz Now
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';
  import { showToast } from '@/lib/notifications';
  import type { Quiz, QuizAttempt } from '@/types/quiz';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl!, supabaseAnonKey!);

  let quiz: Quiz | null = null;
  let attempts: QuizAttempt[] = [];
  let canRetake = false;

  async function init() {
    // Get quiz ID from URL - these are UUIDs (strings)
    const pathParts = window.location.pathname.split('/');
    const quizId = pathParts[2];

    if (!quizId) {
      showToast('Invalid quiz ID', 'error');
      return;
    }

    // Check authentication
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }

    try {
      await loadAttempts(quizId, session.access_token);
      renderAttempts();

      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('attempts-content')?.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading attempts:', error);
      showToast('Failed to load attempts', 'error');
    }
  }

  async function loadAttempts(quizId: string, token: string) {
    // Load quiz and attempts
    const response = await fetch(`/api/quizzes/${quizId}`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });

    if (!response.ok) {
      throw new Error('Failed to load quiz');
    }

    const data = await response.json();
    quiz = data.quiz;
    attempts = data.userAttempts || data.attempts || [];

    if (!quiz) {
      throw new Error('Quiz not found');
    }

    // Use server-provided canAttempt for consistency
    canRetake = data.canAttempt ?? false;

    // Update header
    document.getElementById('quiz-title')!.textContent = quiz.title;
    document.getElementById('breadcrumb')!.textContent = `${attempts.length} attempt${attempts.length !== 1 ? 's' : ''}`;

    // Update quiz info
    document.getElementById('quiz-title-display')!.textContent = quiz.title;
    document.getElementById('quiz-description')!.textContent = quiz.description || 'No description';
    document.getElementById('passing-score')!.textContent = `${quiz.passing_score}%`;
    document.getElementById('max-attempts')!.textContent = quiz.max_attempts === 0 ? 'Unlimited' : quiz.max_attempts.toString();

    // Calculate best score
    const completedAttempts = attempts.filter(a => a.submitted_at);
    const bestScore = completedAttempts.length > 0
      ? Math.max(...completedAttempts.map(a => a.score ?? 0))
      : 0;

    const bestScoreEl = document.getElementById('best-score')!;
    bestScoreEl.textContent = completedAttempts.length > 0 ? `${bestScore}%` : 'N/A';
    if (quiz && bestScore >= quiz.passing_score) {
      bestScoreEl.classList.add('text-success');
    } else if (completedAttempts.length > 0) {
      bestScoreEl.classList.add('text-error');
    }

    // Show retry button if can retake
    if (canRetake) {
      const retryBtn = document.getElementById('retry-btn')!;
      retryBtn.classList.remove('hidden');
      retryBtn.onclick = handleStartQuiz;
    }

    // Setup back button
    document.getElementById('back-btn')?.addEventListener('click', () => {
      history.back();
    });
  }

  function renderAttempts() {
    if (attempts.length === 0) {
      document.getElementById('no-attempts')?.classList.remove('hidden');
      document.getElementById('start-quiz-btn')!.onclick = handleStartQuiz;
      return;
    }

    const container = document.getElementById('attempts-list')!;

    // Sort attempts by attempt number (descending)
    const sortedAttempts = [...attempts].sort((a, b) => b.attempt_number - a.attempt_number);

    sortedAttempts.forEach((attempt) => {
      const attemptCard = createAttemptCard(attempt);
      container.appendChild(attemptCard);
    });
  }

  function createAttemptCard(attempt: QuizAttempt): HTMLElement {
    const card = document.createElement('div');
    card.className = 'card hover:shadow-lg transition-shadow';

    const isCompleted = !!attempt.submitted_at;
    const isPassed = attempt.passed;
    const needsGrading = attempt.grading_status === 'needs_review';

    card.innerHTML = `
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-4 flex-1">
          <!-- Attempt Badge -->
          <div class="flex-shrink-0 w-16 h-16 rounded-lg flex flex-col items-center justify-center ${
            isPassed ? 'bg-success/10 text-success' :
            needsGrading ? 'bg-warning/10 text-warning' :
            isCompleted ? 'bg-error/10 text-error' :
            'bg-surface-hover text-text-muted'
          }">
            <div class="text-xs font-medium">Attempt</div>
            <div class="text-2xl font-bold">#${attempt.attempt_number}</div>
          </div>

          <!-- Attempt Info -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-3 mb-2">
              <h4 class="text-lg font-bold">
                ${isCompleted ? (isPassed ? 'Passed' : 'Not Passed') : 'In Progress'}
              </h4>
              ${needsGrading ? `
                <span class="px-2 py-1 bg-warning/10 text-warning text-xs font-medium rounded">
                  Awaiting Review
                </span>
              ` : ''}
            </div>

            <div class="flex flex-wrap gap-4 text-sm text-text-muted">
              ${isCompleted ? `
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span class="font-bold ${isPassed ? 'text-success' : 'text-error'}">${attempt.score}%</span>
                  <span>(${attempt.points_earned}/${attempt.total_points} points)</span>
                </div>
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>${formatTime(attempt.time_taken_seconds)}</span>
                </div>
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span>${formatDate(attempt.submitted_at!)}</span>
                </div>
              ` : `
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Started ${formatDate(attempt.started_at)}</span>
                </div>
              `}
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex-shrink-0 flex gap-2">
          ${isCompleted ? `
            <a href="/quizzes/${quiz!.id}/results/${attempt.id}" class="btn btn-primary btn-sm">
              View Results
            </a>
          ` : `
            <a href="/quizzes/${quiz!.id}/take?attemptId=${attempt.id}" class="btn btn-primary btn-sm">
              Continue
            </a>
          `}
        </div>
      </div>
    `;

    return card;
  }

  function formatTime(seconds: number | null): string {
    if (!seconds) return 'N/A';

    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;

    if (mins === 0) return `${secs}s`;
    if (secs === 0) return `${mins}m`;
    return `${mins}m ${secs}s`;
  }

  function formatDate(isoString: string): string {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;

    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
    });
  }

  async function handleStartQuiz() {
    if (!quiz) return;

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      // Start new attempt
      const response = await fetch(`/api/quizzes/${quiz.id}/start`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        const error = await response.json();
        showToast(error.error || 'Failed to start quiz', 'error');
        return;
      }

      const data = await response.json();

      // Navigate to quiz taking page
      window.location.href = `/quizzes/${quiz.id}/take?attemptId=${data.attempt.id}`;
    } catch (error) {
      console.error('Error starting quiz:', error);
      showToast('Failed to start quiz', 'error');
    }
  }

  // Setup event listeners
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/login';
  });

  // Initialize
  init();
</script>
</BaseLayout>
