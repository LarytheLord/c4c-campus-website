---
/**
 * Quiz Results Page
 *
 * Displays quiz results with:
 * - Score and pass/fail status
 * - Correct/incorrect answers
 * - Feedback per question
 * - Time taken
 * - Retry option (if allowed)
 */

import BaseLayout from '../../../../layouts/BaseLayout.astro';

export const prerender = false;
---

<BaseLayout title="Quiz Results - C4C Campus" hideHeader={true} hideFooter={true}>
  <div class="min-h-screen bg-background">
    <!-- Header -->
    <div class="sticky top-0 z-50 bg-white border-b border-border">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
            <a href="/dashboard" class="flex-shrink-0">
              <img src="/logo.jpeg" alt="C4C Campus" class="h-10 w-10 rounded-lg" />
            </a>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold" id="quiz-title">Quiz Results</h1>
              <p class="text-text-muted text-sm" id="breadcrumb">Loading...</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="back-btn" class="btn btn-ghost btn-sm">Back to Quiz</button>
            <button id="logout-btn" class="btn btn-ghost text-sm">Sign Out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading results...</p>
      </div>
    </div>

    <!-- Results Content -->
    <div id="results-content" class="hidden container mx-auto px-4 py-8">
      <!-- Results Summary (React Component) -->
      <div id="results-summary" class="mb-8"></div>

      <!-- Question Review -->
      <div id="review-container" class="hidden space-y-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Review Your Answers</h2>
          <button id="hide-review-btn" class="btn btn-ghost btn-sm">
            Hide Review
          </button>
        </div>
        <div id="questions-review"></div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '@/lib/supabase';
  import { showToast } from '@/lib/notifications';
  import type { Quiz, QuizAttempt } from '@/types/quiz';

  let quiz: Quiz | null = null;
  let attempt: QuizAttempt | null = null;
  let questions: any[] = [];
  let canRetake = false;

  async function init() {
    // Get quiz ID and attempt ID from URL - these are UUIDs (strings)
    const pathParts = window.location.pathname.split('/');
    const quizId = pathParts[2];
    const attemptId = pathParts[4];

    if (!quizId || !attemptId) {
      showToast('Invalid quiz or attempt ID', 'error');
      return;
    }

    // Check authentication
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }

    try {
      await loadResults(quizId, attemptId, session.access_token);
      renderResults();

      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('results-content')?.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading results:', error);
      showToast('Failed to load results', 'error');
    }
  }

  async function loadResults(quizId: string, attemptId: string, token: string) {
    // Load quiz details
    const quizResponse = await fetch(`/api/quizzes/${quizId}`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });

    if (!quizResponse.ok) {
      throw new Error('Failed to load quiz');
    }

    const quizData = await quizResponse.json();
    quiz = quizData.quiz;

    if (!quiz) {
      throw new Error('Quiz not found');
    }

    // Use server-provided canAttempt for consistency
    canRetake = quizData.canAttempt ?? false;

    // Load attempt results
    const attemptResponse = await fetch(`/api/quizzes/${quizId}/attempts/${attemptId}`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });

    if (!attemptResponse.ok) {
      throw new Error('Failed to load attempt');
    }

    const attemptData = await attemptResponse.json();
    attempt = attemptData.attempt;
    questions = attemptData.questions || [];

    if (!attempt) {
      throw new Error('Attempt not found');
    }

    // Update header
    document.getElementById('quiz-title')!.textContent = `${quiz.title} - Results`;
    document.getElementById('breadcrumb')!.textContent = `Attempt #${attempt.attempt_number}`;

    // Setup back button
    document.getElementById('back-btn')?.addEventListener('click', () => {
      window.location.href = `/quizzes/${quizId}/attempts`;
    });
  }

  function renderResults() {
    if (!quiz || !attempt) return;

    // Capture non-null values for use in async callbacks
    const quizData = quiz;
    const attemptData = attempt;

    const summaryContainer = document.getElementById('results-summary')!;

    // Render results summary
    import('../../../../components/QuizResults').then(({ QuizResults }) => {
      import('react-dom/client').then(({ createRoot }) => {
        const root = createRoot(summaryContainer);
        root.render(
          QuizResults({
            quiz: quizData,
            attempt: attemptData,
            canRetake,
            onRetry: handleRetry,
            onReview: showReview,
          })
        );
      });
    });
  }

  function showReview() {
    // Early return if data not loaded
    if (!quiz || !attempt) return;

    // Capture non-null values for use in async callbacks
    const quizData = quiz;
    const attemptData = attempt;

    const reviewContainer = document.getElementById('review-container')!;
    reviewContainer.classList.remove('hidden');

    const questionsContainer = document.getElementById('questions-review')!;

    // Render each question with answer review
    import('../../../../components/QuizQuestion').then(({ QuizQuestion }) => {
      import('react-dom/client').then(({ createRoot }) => {
        questions.forEach((question, index) => {
          const questionDiv = document.createElement('div');
          questionsContainer.appendChild(questionDiv);

          const userAnswer = attemptData.answers_json?.find((a: any) => a.question_id === question.id);

          const root = createRoot(questionDiv);
          root.render(
            QuizQuestion({
              question: {
                id: question.id,
                type: question.type,
                questionText: question.question_text,
                questionImageUrl: question.question_image_url,
                // Use 'options' per schema.sql quiz_questions table (not options_json)
                options: question.options,
                points: question.points,
                orderIndex: index,
              },
              questionNumber: index + 1,
              totalQuestions: questions.length,
              value: userAnswer?.answer || '',
              onChange: () => {}, // Read-only
              readonly: true,
              showCorrectAnswer: quizData.show_correct_answers,
              // Use 'correct_answer' per schema.sql quiz_questions table (not correct_answers_json)
              correctAnswer: question.correct_answer,
              isCorrect: userAnswer?.is_correct,
              explanation: question.explanation,
            })
          );
        });
      });
    });

    // Scroll to review
    reviewContainer.scrollIntoView({ behavior: 'smooth' });
  }

  async function handleRetry() {
    // Early return if data not loaded
    if (!quiz) return;

    // Capture non-null value for use in async callbacks
    const quizData = quiz;

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      // Start new attempt
      const response = await fetch(`/api/quizzes/${quizData.id}/start`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        const error = await response.json();
        showToast(error.error || 'Failed to start quiz', 'error');
        return;
      }

      const data = await response.json();

      // Navigate to quiz taking page
      window.location.href = `/quizzes/${quizData.id}/take?attemptId=${data.attempt.id}`;
    } catch (error) {
      console.error('Error starting retry:', error);
      showToast('Failed to start quiz', 'error');
    }
  }

  // Setup event listeners
  document.getElementById('hide-review-btn')?.addEventListener('click', () => {
    document.getElementById('review-container')?.classList.add('hidden');
  });

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/login';
  });

  // Initialize
  init();
</script>
</BaseLayout>
