---
import BaseLayout from '@/layouts/BaseLayout.astro';
---

<BaseLayout title="Courses - C4C Campus" hideHeader={true} hideFooter={true}>
  <div class="min-h-screen bg-background">
    <!-- Internal Header -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-sm shadow-sm">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
            <a href="/dashboard" class="flex-shrink-0">
              <img src="/logo.jpeg" alt="C4C Campus" class="h-10 w-10 rounded-lg" />
            </a>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold text-text">Browse Courses</h1>
              <p class="text-text-muted text-sm" id="welcome-text">Welcome back!</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <!-- Navigation Links -->
            <a href="/dashboard" class="hidden sm:block btn btn-ghost btn-sm">Dashboard</a>

            <!-- Language Selector -->
            <select id="language-selector" class="notranslate hidden sm:block border border-border rounded-lg px-3 py-2 text-sm bg-background" translate="no">
              <option value="">Language</option>
              <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
              <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
              <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
              <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
              <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
              <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
              <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
              <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
              <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
              <option value="es">Espa√±ol</option>
              <option value="fr">Fran√ßais</option>
              <option value="de">Deutsch</option>
              <option value="pt">Portugu√™s</option>
              <option value="zh-CN">‰∏≠Êñá</option>
              <option value="ja">Êó•Êú¨Ë™û</option>
              <option value="ko">ÌïúÍµ≠Ïñ¥</option>
              <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
            <div id="google_translate_element" style="display: none;"></div>
            <button id="logout-btn" class="btn btn-ghost text-sm">
              Sign Out
            </button>
          </div>
        </div>
      </div>
      <div class="h-0.5 bg-gradient-to-r from-primary/50 via-primary to-primary/50"></div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">

      <!-- Filter/Tabs -->
      <div class="mb-6 flex gap-4 border-b border-border">
      <button class="tab-btn active" data-filter="all">All Courses</button>
      <button class="tab-btn" data-filter="enrolled">My Courses</button>
      <button class="tab-btn" data-filter="available">Available</button>
    </div>

      <!-- Track Filters -->
      <div class="mb-6 flex flex-wrap gap-2">
      <button class="filter-chip active" data-track="all">All Tracks</button>
      <button class="filter-chip" data-track="animal_advocacy">Animal Advocacy</button>
      <button class="filter-chip" data-track="climate">Climate</button>
      <button class="filter-chip" data-track="ai_safety">AI Safety</button>
      <button class="filter-chip" data-track="general">General</button>
    </div>

      <!-- Loading State -->
      <div id="loading" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
      <p class="mt-4 text-text-muted">Loading courses...</p>
    </div>

      <!-- Courses Grid -->
      <div id="courses-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Courses will be inserted here -->
    </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-12">
        <div class="text-6xl mb-4">üìö</div>
        <h3 class="text-xl font-semibold mb-2">No courses found</h3>
        <p class="text-text-muted">Try adjusting your filters or check back later</p>
      </div>
    </div>
  </div>
</BaseLayout>

<style is:global>
  .tab-btn {
    padding: 0.75rem 1rem;
    font-weight: 500;
    color: hsl(0 0% 45%);
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }

  .tab-btn:hover {
    color: hsl(var(--primary));
  }

  .tab-btn.active {
    color: hsl(var(--primary));
    border-bottom-color: hsl(var(--primary));
  }

  .filter-chip {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    border-radius: 9999px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: hsl(0 0% 45%);
    transition: all 0.2s;
  }

  .filter-chip:hover {
    background: hsl(var(--primary) / 0.08);
    border-color: hsl(var(--primary));
    color: hsl(var(--primary));
  }

  .filter-chip.active {
    background: hsl(var(--primary-dark));
    color: white !important;
    border-color: hsl(var(--primary-dark));
  }

  .course-card-wrapper {
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s ease;
    cursor: pointer;
    background: white;
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  }

  .course-card-wrapper:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .course-card-wrapper:active {
    transform: translateY(0);
  }

  .course-thumbnail {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background: var(--surface-hover);
  }

  .course-content {
    padding: 20px;
  }

  .course-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
  }

  .course-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .course-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .meta-tag {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    background: #F3F4F6;
    color: #374151;
    font-weight: 500;
    font-size: 0.8125rem;
  }

  .enrolled-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    background: hsl(var(--success) / 0.1);
    color: hsl(var(--success));
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 0.5rem;
  }

  .view-details-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: hsl(var(--primary));
    text-decoration: none;
    transition: gap 0.2s;
  }

  .course-card-wrapper:hover .view-details-link {
    gap: 0.75rem;
  }

  .view-details-arrow {
    transition: transform 0.2s;
  }

  .course-card-wrapper:hover .view-details-link {
    color: hsl(var(--primary-dark));
  }

  .course-card-wrapper:hover .view-details-arrow {
    transform: translateX(4px);
  }
</style>

<script>
  import { supabase } from '@/lib/supabase';
  import { showToast, setButtonLoading, dismissToast } from '@/lib/notifications';
  import { escapeHTML } from '@/lib/security';

  let allCourses: any[] = [];
  let enrollments: Set<number> = new Set();
  let currentUser: any = null;
  let currentFilter = 'all';
  let currentTrack = 'all';

  async function init() {
    // Check if user is logged in
    const { data: { user } } = await supabase.auth.getUser();
    currentUser = user;

    // Redirect to login if not authenticated
    if (!currentUser) {
      window.location.href = '/login';
      return;
    }

    // Load user's name from applications table
    const { data: application } = await supabase
      .from('applications')
      .select('name')
      .eq('user_id', currentUser.id)
      .single();

    if (application?.name) {
      const firstName = application.name.split(' ')[0];
      const welcomeText = document.getElementById('welcome-text');
      if (welcomeText) {
        welcomeText.textContent = `Welcome back, ${firstName}!`;
      }
    }

    // Load courses and enrollments
    await Promise.all([
      loadCourses(),
      loadEnrollments()
    ]);

    renderCourses();
    setupEventListeners();
    setupLogout();
  }

  async function loadCourses() {
    const { data, error } = await supabase
      .from('courses')
      .select('*')
      .eq('is_published', true)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error loading courses:', error);
      return;
    }

    allCourses = data || [];
  }

  async function loadEnrollments() {
    if (!currentUser) return;

    const { data, error } = await supabase
      .from('enrollments')
      .select('course_id')
      .eq('user_id', currentUser.id)
      .eq('status', 'active');

    if (error) {
      console.error('Error loading enrollments:', error);
      return;
    }

    enrollments = new Set(data?.map(e => e.course_id) || []);
  }

  function renderCourses() {
    const loading = document.getElementById('loading');
    const grid = document.getElementById('courses-grid');
    const empty = document.getElementById('empty-state');

    // Filter courses
    let filtered = allCourses;

    // Filter by enrollment status
    if (currentFilter === 'enrolled') {
      filtered = filtered.filter(c => enrollments.has(c.id));
    } else if (currentFilter === 'available') {
      filtered = filtered.filter(c => !enrollments.has(c.id));
    }

    // Filter by track
    if (currentTrack !== 'all') {
      filtered = filtered.filter(c => c.track === currentTrack);
    }

    loading?.classList.add('hidden');

    if (filtered.length === 0) {
      grid?.classList.add('hidden');
      empty?.classList.remove('hidden');
      return;
    }

    empty?.classList.add('hidden');
    grid?.classList.remove('hidden');

    // Render course cards
    grid!.innerHTML = filtered.map(course => {
      const isEnrolled = enrollments.has(course.id);
      const thumbnailUrl = course.thumbnail_url;

      return `
        <div class="course-card-wrapper" data-course-id="${escapeHTML(String(course.id))}" data-slug="${escapeHTML(course.slug)}">
          ${thumbnailUrl && thumbnailUrl !== 'null' ? `<img src="${escapeHTML(thumbnailUrl)}" alt="${escapeHTML(course.title)}" class="course-thumbnail" />` : ''}
          <div class="course-content">
            <h3 class="course-title">${escapeHTML(course.title)}</h3>
            ${course.description ? `<p class="course-description">${escapeHTML(course.description)}</p>` : ''}
            <div class="course-meta">
              <span class="meta-tag">${escapeHTML(formatTrack(course.track))}</span>
              <span class="meta-tag">${escapeHTML(formatDifficulty(course.difficulty))}</span>
              ${course.default_duration_weeks ? `<span class="meta-tag">${course.default_duration_weeks} weeks</span>` : ''}
            </div>
            ${isEnrolled ?
              '<div class="enrolled-badge">‚úì Enrolled</div>' :
              '<button class="btn btn-primary btn-sm mt-3 w-full enroll-btn" data-course-id="' + escapeHTML(String(course.id)) + '" onclick="event.stopPropagation()">Enroll Now</button>'
            }
            <div class="view-details-link">
              <span>View Course Details</span>
              <span class="view-details-arrow">‚Üí</span>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Add click handlers for course cards
    document.querySelectorAll('.course-card-wrapper').forEach(card => {
      card.addEventListener('click', () => {
        const slug = card.getAttribute('data-slug');
        if (slug) {
          window.location.href = `/courses/${slug}`;
        }
      });
    });

    // Add enroll button handlers
    document.querySelectorAll('.enroll-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        // Course IDs are UUIDs (strings)
        const courseId = btn.getAttribute('data-course-id')!;
        const button = btn as HTMLButtonElement;

        // Add loading state
        setButtonLoading(button, true, 'Enrolling...');

        await enrollInCourse(courseId);

        // Reset button state
        setButtonLoading(button, false, 'Enroll Now');
      });
    });
  }

  async function enrollInCourse(courseId: string) {
    if (!currentUser) {
      showToast('Please login to enroll in courses', 'error');
      setTimeout(() => {
        window.location.href = '/login';
      }, 1500);
      return;
    }

    const loadingId = showToast('Enrolling in course...', 'info', 0);

    try {
      // Get the user's session token
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        dismissToast(loadingId);
        showToast('Session expired. Please login again.', 'error');
        setTimeout(() => {
          window.location.href = '/login';
        }, 1500);
        return;
      }

      // Call the enrollment API endpoint
      const response = await fetch('/api/enroll', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`
        },
        body: JSON.stringify({ courseId })
      });

      const result = await response.json();

      dismissToast(loadingId);

      if (!response.ok) {
        if (response.status === 409) {
          showToast('You are already enrolled in this course!', 'warning');
        } else {
          showToast('Error enrolling: ' + (result.error || 'Unknown error'), 'error');
        }
        return;
      }

      showToast('Successfully enrolled!', 'success');
      await loadEnrollments();
      renderCourses();
    } catch (error) {
      console.error('Enrollment error:', error);
      dismissToast(loadingId);
      showToast('Error enrolling in course. Please try again.', 'error');
    }
  }

  function setupEventListeners() {
    // Tab filters
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.getAttribute('data-filter') || 'all';
        renderCourses();
      });
    });

    // Track filters
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentTrack = chip.getAttribute('data-track') || 'all';
        renderCourses();
      });
    });
  }

  function formatTrack(track: string): string {
    const map: Record<string, string> = {
      'animal_advocacy': 'Animal Advocacy',
      'climate': 'Climate',
      'ai_safety': 'AI Safety',
      'general': 'General'
    };
    // Return mapped value, or convert snake_case to Title Case as fallback
    return map[track] || track.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  }

  function formatDifficulty(difficulty: string): string {
    return difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
  }

  function setupLogout() {
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/login';
    });
  }

  // Initialize
  init();
</script>
</BaseLayout>
