---
/**
 * Assignment Detail & Submission Page
 * Students can view assignment details and submit their work
 */
import BaseLayout from '@/layouts/BaseLayout.astro';
export const prerender = false;

const { id } = Astro.params;
---

<BaseLayout title="Assignment - Code4Change">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Loading State -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
        <p class="mt-4 text-gray-600">Loading assignment...</p>
      </div>

      <!-- Error State -->
      <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-lg"></div>

      <!-- Main Content -->
      <div id="content" class="hidden">
        <!-- Back Button -->
        <a href="/assignments" class="inline-flex items-center text-blue-600 hover:text-blue-700 mb-6 transition-colors">
          <span class="mr-2">‚Üê</span>
          Back to Assignments
        </a>

        <!-- Assignment Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-6">
          <div class="flex items-start justify-between gap-4 mb-4">
            <div class="flex-1">
              <h1 id="assignment-title" class="text-4xl font-bold mb-2"></h1>
              <p id="assignment-meta" class="text-gray-600 text-sm"></p>
            </div>
            <div id="status-badge"></div>
          </div>

          <p id="assignment-description" class="text-gray-700 text-lg"></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Main Content Column -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Instructions -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h2 class="text-2xl font-bold mb-4">Instructions</h2>
              <div id="assignment-instructions" class="prose prose-sm max-w-none"></div>
            </div>

            <!-- Grading Rubric -->
            <div id="rubric-container"></div>

            <!-- Submission Form -->
            <div id="submission-form-container"></div>

            <!-- Submission History -->
            <div id="history-container"></div>
          </div>

          <!-- Sidebar -->
          <div class="space-y-6">
            <!-- Countdown Timer -->
            <div id="countdown-container"></div>

            <!-- Submission Status -->
            <div id="submission-status-container"></div>

            <!-- Assignment Details -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h3 class="text-lg font-semibold mb-4">Assignment Details</h3>
              <div id="assignment-details" class="space-y-3 text-sm"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';
    import type { AssignmentWithSubmission } from '@/types/assignment';
    import { createRoot } from 'react-dom/client';
    import { createElement } from 'react';
    import AssignmentRubric from '@/components/student/AssignmentRubric';
    import DueDateCountdown from '@/components/student/DueDateCountdown';
    import SubmissionStatus from '@/components/student/SubmissionStatus';
    import FileUploader from '@/components/student/FileUploader';
    import SubmissionHistory from '@/components/student/SubmissionHistory';
    import { getAssignmentStatus, getStatusBadgeHtml, type AssignmentStatus } from '@/lib/assignment-status';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const assignmentId = window.location.pathname.split('/')[2];
    let assignment: AssignmentWithSubmission | null = null;
    let assignmentStatus: AssignmentStatus | null = null;

    async function loadAssignment() {
      try {
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
          window.location.href = `/login?redirect=/assignments/${assignmentId}`;
          return;
        }

        // Get assignment details
        const { data: assignmentData, error: assignmentError } = await supabase
          .from('assignments')
          .select(`
            *,
            lessons(
              id, name,
              modules(
                id, title,
                courses(id, name, created_by)
              )
            )
          `)
          .eq('id', assignmentId)
          .eq('is_published', true)
          .single();

        if (assignmentError || !assignmentData) {
          throw new Error('Assignment not found or access denied');
        }

        // Get user's submission
        const { data: submission } = await supabase
          .from('assignment_submissions')
          .select('*')
          .eq('assignment_id', assignmentId)
          .eq('user_id', session.user.id)
          .order('submission_number', { ascending: false })
          .limit(1)
          .single();

        assignment = {
          ...assignmentData,
          user_submission: submission || null
        };

        // Compute assignment status using the centralized helper
        assignmentStatus = getAssignmentStatus(assignment!, new Date());

        renderAssignment();
        hideLoading();
      } catch (error) {
        console.error('Error loading assignment:', error);
        showError(error instanceof Error ? error.message : 'Failed to load assignment');
      }
    }

    function renderAssignment() {
      if (!assignment) return;

      const lesson = assignment.lessons as any;
      const course = lesson?.modules?.courses;

      // Header
      const titleEl = document.getElementById('assignment-title');
      if (titleEl) titleEl.textContent = assignment.title;

      const metaEl = document.getElementById('assignment-meta');
      if (metaEl) {
        metaEl.textContent = `${course?.title || 'Unknown Course'} ‚Ä¢ ${lesson?.name || 'Unknown Lesson'}`;
      }

      const descEl = document.getElementById('assignment-description');
      if (descEl && assignment.description) {
        descEl.textContent = assignment.description;
      }

      // Status Badge
      renderStatusBadge();

      // Instructions
      const instructionsEl = document.getElementById('assignment-instructions');
      if (instructionsEl && assignment.instructions) {
        instructionsEl.innerHTML = assignment.instructions
          .split('\n')
          .map(line => `<p>${line}</p>`)
          .join('');
      }

      // Rubric
      if (assignment.grading_rubric) {
        const rubricContainer = document.getElementById('rubric-container');
        if (rubricContainer) {
          const root = createRoot(rubricContainer);
          root.render(createElement(AssignmentRubric, {
            rubric: assignment.grading_rubric,
            maxPoints: assignment.max_points
          }));
        }
      }

      // Countdown
      if (assignment.due_date) {
        const countdownContainer = document.getElementById('countdown-container');
        if (countdownContainer) {
          const root = createRoot(countdownContainer);
          root.render(createElement(DueDateCountdown, {
            dueDate: assignment.due_date,
            lateAllowed: assignment.allow_late_submissions
          }));
        }
      }

      // Submission Status - use computed status from helper
      const statusContainer = document.getElementById('submission-status-container');
      if (statusContainer && assignmentStatus) {
        const root = createRoot(statusContainer);
        root.render(createElement(SubmissionStatus, {
          submission: assignment.user_submission,
          maxPoints: assignment.max_points,
          isPastDue: assignmentStatus.isPastDue,
          lateAllowed: assignment.allow_late_submissions
        }));
      }

      // Submission Form
      renderSubmissionForm();

      // Details
      renderDetails();

      // Show content
      const contentEl = document.getElementById('content');
      if (contentEl) contentEl.classList.remove('hidden');
    }

    function renderStatusBadge() {
      if (!assignment || !assignmentStatus) return;

      const badgeEl = document.getElementById('status-badge');
      if (!badgeEl) return;

      // Use the centralized getStatusBadgeHtml helper for consistent styling
      // The helper uses score from user_submission (not legacy grade/points_earned)
      badgeEl.innerHTML = getStatusBadgeHtml(assignmentStatus).replace(
        'px-3 py-1',
        'px-4 py-2'
      );
    }

    function renderSubmissionForm() {
      if (!assignment || !assignmentStatus) return;

      const formContainer = document.getElementById('submission-form-container');
      if (!formContainer) return;

      // Use computed status from the helper
      const { hasSubmission, canSubmit, canResubmit, isLateButAllowed, currentSubmissionNumber, isClosed } = assignmentStatus;

      if (isClosed && !hasSubmission) {
        formContainer.innerHTML = `
          <div class="bg-gray-50 border border-gray-300 rounded-lg p-8 text-center">
            <div class="text-6xl mb-4">üîí</div>
            <h3 class="text-xl font-bold text-gray-700 mb-2">Submissions Closed</h3>
            <p class="text-gray-600">This assignment is no longer accepting submissions.</p>
          </div>
        `;
        return;
      }

      if (canSubmit) {
        const formRoot = createRoot(formContainer);
        formRoot.render(createElement('div', { className: 'bg-white rounded-lg shadow-sm border border-gray-200 p-6' }, [
          createElement('h2', { key: 'title', className: 'text-2xl font-bold mb-4' },
            canResubmit ? `Resubmission #${currentSubmissionNumber + 1}` : 'Submit Your Work'
          ),
          createElement(FileUploader, {
            key: 'uploader',
            assignmentId: assignment.id,
            allowedTypes: assignment.allowed_file_types,
            maxSizeMB: assignment.max_file_size_mb,
            onSuccess: () => {
              window.location.reload();
            },
            onCancel: () => {
              // Do nothing
            }
          })
        ]));

        // Late warning
        if (isLateButAllowed && !hasSubmission) {
          const warning = document.createElement('div');
          warning.className = 'mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg text-sm text-orange-700';
          warning.innerHTML = `<strong>‚ö†Ô∏è Late Submission:</strong> A ${assignment.late_penalty_percent}% penalty will be applied to your grade.`;
          formContainer.appendChild(warning);
        }
      } else if (hasSubmission) {
        formContainer.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
            <div class="text-5xl mb-3">‚úÖ</div>
            <h3 class="text-lg font-bold text-green-700 mb-2">Assignment Submitted</h3>
            <p class="text-green-600 text-sm">Your work has been submitted and is awaiting grading.</p>
          </div>
        `;
      }
    }

    function renderDetails() {
      if (!assignment) return;

      const detailsEl = document.getElementById('assignment-details');
      if (!detailsEl) return;

      detailsEl.innerHTML = `
        <div class="flex justify-between py-2 border-b border-gray-200">
          <span class="text-gray-600">Maximum Points:</span>
          <span class="font-medium">${assignment.max_points}</span>
        </div>

        ${assignment.due_date ? `
          <div class="flex justify-between py-2 border-b border-gray-200">
            <span class="text-gray-600">Due Date:</span>
            <span class="font-medium">${new Date(assignment.due_date).toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit'
            })}</span>
          </div>
        ` : ''}

        <div class="flex justify-between py-2 border-b border-gray-200">
          <span class="text-gray-600">File Types:</span>
          <span class="font-medium text-xs">${assignment.allowed_file_types.slice(0, 3).join(', ')}${assignment.allowed_file_types.length > 3 ? ` +${assignment.allowed_file_types.length - 3}` : ''}</span>
        </div>

        <div class="flex justify-between py-2 border-b border-gray-200">
          <span class="text-gray-600">Max File Size:</span>
          <span class="font-medium">${assignment.max_file_size_mb}MB</span>
        </div>

        <div class="flex justify-between py-2 border-b border-gray-200">
          <span class="text-gray-600">Late Submissions:</span>
          <span class="font-medium">${assignment.allow_late_submissions ? `Allowed (${assignment.late_penalty_percent}% penalty)` : 'Not Allowed'}</span>
        </div>

        <div class="flex justify-between py-2 border-b border-gray-200">
          <span class="text-gray-600">Resubmissions:</span>
          <span class="font-medium">${assignment.allow_resubmission ? `Allowed (max ${assignment.max_submissions})` : 'Not Allowed'}</span>
        </div>

        <div class="flex justify-between py-2">
          <span class="text-gray-600">Created:</span>
          <span class="font-medium">${new Date(assignment.created_at).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          })}</span>
        </div>
      `;
    }

    function showError(message: string) {
      const errorDiv = document.getElementById('error');
      const loadingDiv = document.getElementById('loading');

      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }

      if (loadingDiv) {
        loadingDiv.classList.add('hidden');
      }
    }

    function hideLoading() {
      const loadingDiv = document.getElementById('loading');
      if (loadingDiv) {
        loadingDiv.classList.add('hidden');
      }
    }

    // Initialize
    loadAssignment();
  </script>
</BaseLayout>
