---
/**
 * Submission Detail Page
 * View details of a specific submission
 */
import BaseLayout from '@/layouts/BaseLayout.astro';
export const prerender = false;

const { id, submissionId } = Astro.params;
---

<BaseLayout title="Submission Details - Code4Change">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Loading State -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
        <p class="mt-4 text-gray-600">Loading submission...</p>
      </div>

      <!-- Error State -->
      <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-lg"></div>

      <!-- Main Content -->
      <div id="content" class="hidden">
        <!-- Back Button -->
        <a id="back-link" href="#" class="inline-flex items-center text-blue-600 hover:text-blue-700 mb-6 transition-colors">
          <span class="mr-2">‚Üê</span>
          Back to Assignment
        </a>

        <!-- Submission Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-6">
          <div class="flex items-start justify-between gap-4 mb-4">
            <div class="flex-1">
              <h1 id="submission-title" class="text-3xl font-bold mb-2"></h1>
              <p id="submission-meta" class="text-gray-600"></p>
            </div>
            <div id="status-badge"></div>
          </div>
        </div>

        <!-- Submission Details -->
        <div class="space-y-6">
          <!-- File Information -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold mb-4">Submitted File</h2>
            <div id="file-info" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"></div>
          </div>

          <!-- Grade & Feedback -->
          <div id="grade-container"></div>

          <!-- Submission History -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold mb-4">Submission Timeline</h2>
            <div id="timeline" class="space-y-4"></div>
          </div>

          <!-- Actions -->
          <div class="flex gap-3">
            <button
              id="download-btn"
              class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
              Download Submission
            </button>
            <button
              id="resubmit-btn"
              class="hidden px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
            >
              Submit New Version
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';
    import type { Submission } from '@/types/assignment';
    import { formatFileSize, getFileIcon } from '@/lib/file-upload';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const pathParts = window.location.pathname.split('/');
    const assignmentId = pathParts[2];
    const submissionId = pathParts[4];

    let submission: any = null;
    let assignment: any = null;

    async function loadSubmission() {
      try {
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
          window.location.href = `/login?redirect=${window.location.pathname}`;
          return;
        }

        // Get submission with assignment details
        const { data: submissionData, error: submissionError } = await supabase
          .from('assignment_submissions')
          .select(`
            *,
            assignments(
              *,
              lessons(
                id, name,
                modules(
                  id, title,
                  courses(id, name)
                )
              )
            )
          `)
          .eq('id', submissionId)
          .single();

        if (submissionError || !submissionData) {
          throw new Error('Submission not found or access denied');
        }

        // Verify user owns this submission
        if (submissionData.user_id !== session.user.id) {
          throw new Error('Access denied');
        }

        submission = submissionData;
        assignment = submissionData.assignments;

        renderSubmission([]);
        hideLoading();
      } catch (error) {
        console.error('Error loading submission:', error);
        showError(error instanceof Error ? error.message : 'Failed to load submission');
      }
    }

    function renderSubmission(history: any[]) {
      if (!submission || !assignment) return;

      // Back link
      const backLink = document.getElementById('back-link');
      if (backLink) {
        backLink.setAttribute('href', `/assignments/${assignmentId}`);
      }

      // Title
      const titleEl = document.getElementById('submission-title');
      if (titleEl) {
        titleEl.textContent = `Submission #${submission.submission_number}`;
      }

      // Meta
      const metaEl = document.getElementById('submission-meta');
      if (metaEl) {
        const lesson = assignment.lessons as any;
        const course = lesson?.modules?.courses;
        metaEl.textContent = `${assignment.title} ‚Ä¢ ${course?.name || 'Course'}`;
      }

      // Status badge
      renderStatusBadge();

      // File info
      renderFileInfo();

      // Grade & feedback
      renderGrade();

      // Timeline
      renderTimeline(history);

      // Resubmit button
      const now = new Date();
      const dueDate = assignment.due_date ? new Date(assignment.due_date) : null;
      const isPastDue = dueDate && now > dueDate;
      const canResubmit = assignment.allow_resubmission &&
        submission.submission_number < assignment.max_submissions &&
        (!isPastDue || assignment.allow_late_submissions);

      const resubmitBtn = document.getElementById('resubmit-btn');
      if (resubmitBtn && canResubmit) {
        resubmitBtn.classList.remove('hidden');
        resubmitBtn.addEventListener('click', () => {
          window.location.href = `/assignments/${assignmentId}`;
        });
      }

      // Show content
      const contentEl = document.getElementById('content');
      if (contentEl) contentEl.classList.remove('hidden');
    }

    function renderStatusBadge() {
      if (!submission) return;

      const badgeEl = document.getElementById('status-badge');
      if (!badgeEl) return;

      let badge = '';
      if (submission.status === 'graded') {
        const points = submission.points_earned || submission.grade || 0;
        badge = `<span class="px-4 py-2 bg-green-100 text-green-700 text-sm font-medium rounded-full">Graded: ${points}/${assignment.max_points}</span>`;
      } else if (submission.is_late) {
        badge = '<span class="px-4 py-2 bg-orange-100 text-orange-700 text-sm font-medium rounded-full">Late Submission</span>';
      } else {
        badge = '<span class="px-4 py-2 bg-yellow-100 text-yellow-700 text-sm font-medium rounded-full">Pending Grade</span>';
      }

      badgeEl.innerHTML = badge;
    }

    function renderFileInfo() {
      if (!submission) return;

      const fileInfoEl = document.getElementById('file-info');
      if (!fileInfoEl) return;

      const icon = getFileIcon(submission.file_name);
      const size = formatFileSize(submission.file_size_bytes);

      fileInfoEl.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="text-4xl">${icon}</span>
          <div>
            <p class="font-medium text-lg">${submission.file_name}</p>
            <p class="text-sm text-gray-600">${size} ‚Ä¢ ${submission.file_type}</p>
          </div>
        </div>
        <button
          id="download-file-btn"
          class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium"
        >
          Download
        </button>
      `;

      // Download handler
      const downloadBtn = document.getElementById('download-file-btn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', handleDownload);
      }

      // Main download button
      const mainDownloadBtn = document.getElementById('download-btn');
      if (mainDownloadBtn) {
        mainDownloadBtn.addEventListener('click', handleDownload);
      }
    }

    function renderGrade() {
      if (!submission) return;

      const gradeContainer = document.getElementById('grade-container');
      if (!gradeContainer) return;

      if (submission.status !== 'graded' || submission.grade === null) {
        gradeContainer.innerHTML = `
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
            <div class="text-5xl mb-3">‚è≥</div>
            <h3 class="text-lg font-bold text-yellow-700 mb-2">Grading in Progress</h3>
            <p class="text-yellow-600 text-sm">Your submission is being reviewed by the instructor.</p>
          </div>
        `;
        return;
      }

      const grade = submission.points_earned || submission.grade || 0;
      const percentage = (grade / assignment.max_points) * 100;

      let gradeColor = 'gray';
      let gradeIcon = 'üìä';

      if (percentage >= 90) {
        gradeColor = 'green';
        gradeIcon = 'üåü';
      } else if (percentage >= 80) {
        gradeColor = 'blue';
        gradeIcon = '‚ú®';
      } else if (percentage >= 70) {
        gradeColor = 'yellow';
        gradeIcon = 'üëç';
      } else if (percentage >= 60) {
        gradeColor = 'orange';
        gradeIcon = 'üìà';
      } else {
        gradeColor = 'red';
        gradeIcon = 'üìâ';
      }

      gradeContainer.innerHTML = `
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-semibold mb-4">Grade & Feedback</h2>

          <div class="text-center mb-6">
            <div class="text-6xl mb-2">${gradeIcon}</div>
            <div class="text-5xl font-bold text-${gradeColor}-600 mb-2">${grade}</div>
            <div class="text-gray-600 text-lg mb-1">out of ${assignment.max_points} points</div>
            <div class="text-2xl font-semibold text-${gradeColor}-600">${percentage.toFixed(1)}%</div>
          </div>

          <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
            <div class="bg-${gradeColor}-500 h-3 rounded-full" style="width: ${percentage}%"></div>
          </div>

          ${submission.is_late && submission.grade !== submission.points_earned ? `
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4 text-sm text-orange-700">
              <strong>‚ö†Ô∏è Late Penalty Applied:</strong> Original grade ${submission.grade} reduced to ${submission.points_earned}
            </div>
          ` : ''}

          ${submission.feedback ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h3 class="font-semibold mb-2 flex items-center gap-2">
                <span>üí¨</span> Instructor Feedback
              </h3>
              <p class="text-gray-700 whitespace-pre-wrap">${submission.feedback}</p>
            </div>
          ` : '<p class="text-gray-500 text-sm text-center">No feedback provided yet.</p>'}

          ${submission.graded_at ? `
            <div class="mt-4 text-sm text-gray-600 text-center">
              Graded on ${new Date(submission.graded_at).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
              })}
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderTimeline(history: any[]) {
      const timelineEl = document.getElementById('timeline');
      if (!timelineEl) return;

      const events = [
        {
          action: submission.submission_number > 1 ? 'resubmitted' : 'submitted',
          timestamp: submission.submitted_at,
          icon: 'üì§',
          color: 'blue',
          description: `Submission #${submission.submission_number} uploaded${submission.is_late ? ' (Late)' : ''}`
        },
        ...history.map(h => ({
          action: h.action,
          timestamp: h.created_at,
          icon: getActionIcon(h.action),
          color: getActionColor(h.action),
          description: getActionDescription(h.action, h.details)
        }))
      ];

      timelineEl.innerHTML = events.map((event, index) => `
        <div class="flex gap-4">
          <div class="flex flex-col items-center">
            <div class="w-10 h-10 rounded-full bg-${event.color}-100 flex items-center justify-center text-lg">
              ${event.icon}
            </div>
            ${index < events.length - 1 ? '<div class="w-0.5 h-full bg-gray-200 mt-2"></div>' : ''}
          </div>
          <div class="flex-1 pb-6">
            <p class="font-medium text-gray-900">${event.description}</p>
            <p class="text-sm text-gray-600">
              ${new Date(event.timestamp).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
              })}
            </p>
          </div>
        </div>
      `).join('');
    }

    function getActionIcon(action: string): string {
      const icons: Record<string, string> = {
        submitted: 'üì§',
        resubmitted: 'üîÑ',
        graded: '‚úÖ',
        returned: 'üì•',
        downloaded_by_teacher: 'üë®‚Äçüè´',
        downloaded_by_student: 'üì•',
        feedback_updated: 'üí¨',
        grade_updated: 'üìù'
      };
      return icons[action] || 'üìã';
    }

    function getActionColor(action: string): string {
      const colors: Record<string, string> = {
        submitted: 'blue',
        resubmitted: 'purple',
        graded: 'green',
        returned: 'blue',
        downloaded_by_teacher: 'gray',
        downloaded_by_student: 'gray',
        feedback_updated: 'yellow',
        grade_updated: 'orange'
      };
      return colors[action] || 'gray';
    }

    function getActionDescription(action: string, details: any): string {
      const descriptions: Record<string, string> = {
        submitted: 'Assignment submitted',
        resubmitted: 'Assignment resubmitted',
        graded: 'Graded by instructor',
        returned: 'Returned to student',
        downloaded_by_teacher: 'Downloaded by instructor',
        downloaded_by_student: 'Downloaded by you',
        feedback_updated: 'Feedback updated',
        grade_updated: 'Grade updated'
      };
      return descriptions[action] || action;
    }

    async function handleDownload() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const response = await fetch(`/api/submissions/${submissionId}/download`, {
          headers: {
            'Authorization': `Bearer ${session.access_token}`
          }
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to get download URL');
        }

        window.open(result.url, '_blank');
      } catch (error) {
        alert(`Download failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
      }
    }

    function showError(message: string) {
      const errorDiv = document.getElementById('error');
      const loadingDiv = document.getElementById('loading');

      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }

      if (loadingDiv) {
        loadingDiv.classList.add('hidden');
      }
    }

    function hideLoading() {
      const loadingDiv = document.getElementById('loading');
      if (loadingDiv) {
        loadingDiv.classList.add('hidden');
      }
    }

    // Initialize
    loadSubmission();
  </script>
</BaseLayout>
