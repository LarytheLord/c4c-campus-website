---
/**
 * Assignment List Page
 * Students can view all assignments across enrolled courses
 */
import BaseLayout from '@/layouts/BaseLayout.astro';
// Note: getStatusBadgeHtml is imported in the client script below
export const prerender = false;
---

<BaseLayout title="My Assignments - Code4Change">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-4xl font-bold mb-2">My Assignments</h1>
        <p class="text-gray-600">View and submit your course assignments</p>
      </div>

      <!-- Quick Stats -->
      <div id="stats-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <!-- Will be populated by JavaScript -->
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">Filter Assignments</h2>
        <div class="flex flex-wrap gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select id="status-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="all">All Assignments</option>
              <option value="not_submitted">Not Submitted</option>
              <option value="submitted">Submitted</option>
              <option value="graded">Graded</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
            <select id="sort-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="due_date_asc">Due Date (Nearest First)</option>
              <option value="due_date_desc">Due Date (Latest First)</option>
              <option value="created_desc">Recently Created</option>
              <option value="title_asc">Title (A-Z)</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Course</label>
            <select id="course-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="all">All Courses</option>
              <!-- Will be populated by JavaScript -->
            </select>
          </div>
        </div>
      </div>

      <!-- Assignments List -->
      <div id="assignments-container" class="space-y-4">
        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
          <p class="mt-4 text-gray-600">Loading assignments...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"></div>

        <!-- Empty State -->
        <div id="empty" class="hidden text-center py-12 bg-white rounded-lg border border-gray-200">
          <div class="text-6xl mb-4">üìù</div>
          <h3 class="text-xl font-semibold mb-2">No Assignments Found</h3>
          <p class="text-gray-600">You don't have any assignments yet or none match your filters.</p>
        </div>

        <!-- Assignments will be rendered here -->
        <div id="assignments-list"></div>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';
    import type { AssignmentWithSubmission } from '@/types/assignment';
    import { getAssignmentStatus, getStatusBadgeHtml } from '@/lib/assignment-status';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    interface AssignmentWithCourse extends AssignmentWithSubmission {
      course_name?: string;
      course_id?: number;
      lesson_name?: string;
    }

    let allAssignments: AssignmentWithCourse[] = [];
    let filteredAssignments: AssignmentWithCourse[] = [];

    async function loadAssignments() {
      try {
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
          window.location.href = '/login?redirect=/assignments';
          return;
        }

        // Get user's enrolled courses
        const { data: enrollments, error: enrollError } = await supabase
          .from('enrollments')
          .select('course_id, courses(id, name)')
          .eq('user_id', session.user.id)
          .eq('status', 'active');

        if (enrollError) throw enrollError;

        if (!enrollments || enrollments.length === 0) {
          showEmpty();
          return;
        }

        // Get all assignments for enrolled courses
        const courseIds = enrollments.map(e => e.course_id);

        const { data: assignmentsData, error: assignmentsError } = await supabase
          .from('assignments')
          .select(`
            *,
            lessons!inner(
              id, name,
              modules!inner(
                id, name,
                courses!inner(id, name)
              )
            )
          `)
          .in('lessons.modules.course_id', courseIds)
          .eq('is_published', true);

        if (assignmentsError) throw assignmentsError;

        // Get user's submissions for these assignments
        const assignmentIds = assignmentsData?.map(a => a.id) || [];

        const { data: submissions, error: submissionsError } = await supabase
          .from('assignment_submissions')
          .select('*')
          .in('assignment_id', assignmentIds)
          .eq('user_id', session.user.id);

        if (submissionsError) throw submissionsError;

        // Combine assignments with submissions
        allAssignments = (assignmentsData || []).map(assignment => {
          const userSubmission = submissions?.find(s => s.assignment_id === assignment.id) || null;
          const lesson = assignment.lessons as any;
          const course = lesson?.modules?.courses;

          return {
            ...assignment,
            user_submission: userSubmission,
            course_name: course?.title || 'Unknown Course',
            course_id: course?.id,
            lesson_name: lesson?.name || 'Unknown Lesson'
          };
        });

        // Populate course filter
        populateCourseFilter(enrollments);

        // Calculate stats
        calculateStats();

        // Apply initial filters
        applyFilters();

        hideLoading();
      } catch (error) {
        console.error('Error loading assignments:', error);
        showError(error instanceof Error ? error.message : 'Failed to load assignments');
      }
    }

    function populateCourseFilter(enrollments: any[]) {
      const courseFilter = document.getElementById('course-filter') as HTMLSelectElement;
      if (!courseFilter) return;

      enrollments.forEach(enrollment => {
        const course = enrollment.courses;
        const option = document.createElement('option');
        option.value = course.id.toString();
        option.textContent = course.title;
        courseFilter.appendChild(option);
      });
    }

    function calculateStats() {
      const now = new Date();
      let notSubmitted = 0;
      let submitted = 0;
      let graded = 0;
      let overdue = 0;

      allAssignments.forEach(assignment => {
        const dueDate = assignment.due_date ? new Date(assignment.due_date) : null;
        const isPastDue = dueDate && now > dueDate;
        const hasSubmission = assignment.user_submission !== null;

        if (!hasSubmission) {
          notSubmitted++;
          if (isPastDue) overdue++;
        } else {
          submitted++;
          if (assignment.user_submission?.status === 'graded') {
            graded++;
          }
        }
      });

      const statsContainer = document.getElementById('stats-container');
      if (!statsContainer) return;

      statsContainer.innerHTML = `
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="text-3xl font-bold text-blue-600">${notSubmitted}</div>
          <div class="text-sm text-gray-600 mt-1">Not Submitted</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="text-3xl font-bold text-green-600">${submitted}</div>
          <div class="text-sm text-gray-600 mt-1">Submitted</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="text-3xl font-bold text-purple-600">${graded}</div>
          <div class="text-sm text-gray-600 mt-1">Graded</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="text-3xl font-bold text-red-600">${overdue}</div>
          <div class="text-sm text-gray-600 mt-1">Overdue</div>
        </div>
      `;
    }

    function applyFilters() {
      const statusFilter = (document.getElementById('status-filter') as HTMLSelectElement)?.value || 'all';
      const sortFilter = (document.getElementById('sort-filter') as HTMLSelectElement)?.value || 'due_date_asc';
      const courseFilter = (document.getElementById('course-filter') as HTMLSelectElement)?.value || 'all';

      const now = new Date();

      // Filter
      filteredAssignments = allAssignments.filter(assignment => {
        // Course filter
        if (courseFilter !== 'all' && assignment.course_id?.toString() !== courseFilter) {
          return false;
        }

        // Status filter
        const hasSubmission = assignment.user_submission !== null;
        const isGraded = assignment.user_submission?.status === 'graded';
        const dueDate = assignment.due_date ? new Date(assignment.due_date) : null;
        const isPastDue = dueDate && now > dueDate;

        if (statusFilter === 'not_submitted' && hasSubmission) return false;
        if (statusFilter === 'submitted' && (!hasSubmission || isGraded)) return false;
        if (statusFilter === 'graded' && !isGraded) return false;
        if (statusFilter === 'overdue' && (!isPastDue || hasSubmission)) return false;

        return true;
      });

      // Sort
      filteredAssignments.sort((a, b) => {
        switch (sortFilter) {
          case 'due_date_asc':
            if (!a.due_date) return 1;
            if (!b.due_date) return -1;
            return new Date(a.due_date).getTime() - new Date(b.due_date).getTime();
          case 'due_date_desc':
            if (!a.due_date) return 1;
            if (!b.due_date) return -1;
            return new Date(b.due_date).getTime() - new Date(a.due_date).getTime();
          case 'created_desc':
            return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
          case 'title_asc':
            return a.title.localeCompare(b.title);
          default:
            return 0;
        }
      });

      renderAssignments();
    }

    function renderAssignments() {
      const listContainer = document.getElementById('assignments-list');
      const emptyContainer = document.getElementById('empty');

      if (!listContainer || !emptyContainer) return;

      if (filteredAssignments.length === 0) {
        listContainer.innerHTML = '';
        emptyContainer.classList.remove('hidden');
        return;
      }

      emptyContainer.classList.add('hidden');

      const now = new Date();

      listContainer.innerHTML = filteredAssignments.map(assignment => {
        // Use centralized status helper
        const status = getAssignmentStatus(assignment, now);
        const statusBadge = getStatusBadgeHtml(status);
        const dueDate = assignment.due_date ? new Date(assignment.due_date) : null;
        const isPastDue = status.isPastDue;

        return `
          <a href="/assignments/${assignment.id}" class="block bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between gap-4 mb-4">
              <div class="flex-1 min-w-0">
                <h3 class="text-xl font-bold mb-1 truncate">${assignment.title}</h3>
                <p class="text-sm text-gray-600 mb-2">
                  <span class="font-medium">${assignment.course_name}</span> ‚Ä¢ ${assignment.lesson_name}
                </p>
                ${assignment.description ? `<p class="text-gray-600 text-sm line-clamp-2">${assignment.description}</p>` : ''}
              </div>
              <div>
                ${statusBadge}
              </div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center gap-4">
                ${dueDate ? `
                  <div class="flex items-center gap-1 ${isPastDue ? 'text-red-600' : 'text-gray-600'}">
                    <span>üìÖ</span>
                    <span>Due: ${dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                  </div>
                ` : '<span class="text-gray-500">No due date</span>'}

                <div class="text-gray-600">
                  <span class="font-medium">${assignment.max_points}</span> points
                </div>
              </div>

              <div class="text-blue-600 font-medium">
                View Details ‚Üí
              </div>
            </div>
          </a>
        `;
      }).join('');
    }

    function showError(message: string) {
      const errorDiv = document.getElementById('error');
      const loadingDiv = document.getElementById('loading');

      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }

      if (loadingDiv) {
        loadingDiv.classList.add('hidden');
      }
    }

    function showEmpty() {
      const emptyDiv = document.getElementById('empty');
      const loadingDiv = document.getElementById('loading');

      if (emptyDiv) {
        emptyDiv.classList.remove('hidden');
      }

      if (loadingDiv) {
        loadingDiv.classList.add('hidden');
      }
    }

    function hideLoading() {
      const loadingDiv = document.getElementById('loading');
      if (loadingDiv) {
        loadingDiv.classList.add('hidden');
      }
    }

    // Event listeners
    document.getElementById('status-filter')?.addEventListener('change', applyFilters);
    document.getElementById('sort-filter')?.addEventListener('change', applyFilters);
    document.getElementById('course-filter')?.addEventListener('change', applyFilters);

    // Initialize
    loadAssignments();
  </script>
</BaseLayout>
