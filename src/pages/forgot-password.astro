---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Reset Password - Code for Compassion Campus"
  description="Reset your C4C Campus account password."
>
  <div class="container mx-auto px-4 py-16">
    <div class="max-w-md mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-black mb-4">Reset Password</h1>
        <p class="text-text-muted">
          Enter your email address and we'll send you a link to reset your password.
        </p>
      </div>

      <!-- Reset Password Card -->
      <div class="card p-8">
        <form id="forgot-password-form" class="space-y-6">
          <div>
            <label for="email" class="block text-sm font-semibold mb-2">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-colors"
              placeholder="your.email@example.com"
            />
          </div>

          <button
            type="submit"
            class="btn btn-primary w-full"
          >
            Send Reset Link
          </button>

          <div id="error-message" class="hidden mt-4 p-4 rounded-lg text-sm bg-error/10 text-error border border-error/20">
          </div>

          <div id="success-message" class="hidden mt-4 p-4 rounded-lg text-sm bg-success/10 text-success border border-success/20">
          </div>
        </form>

        <div class="mt-6 pt-6 border-t border-gray-200 text-center">
          <p class="text-sm text-text-muted">
            Remember your password? <a href="/login" class="text-primary hover:text-primary-dark font-medium">Sign in</a>
          </p>
        </div>
      </div>

      <!-- Info Box -->
      <div class="mt-8 card bg-surface p-6">
        <h3 class="font-bold mb-3">Need Help?</h3>
        <p class="text-sm text-text-muted mb-2">
          If you're having trouble resetting your password or don't have access to your email, please contact us:
        </p>
        <p class="text-sm text-text-muted">
          <a href="mailto:info@codeforcompassion.com" class="text-primary hover:text-primary-dark font-medium">info@codeforcompassion.com</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    document.getElementById('forgot-password-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const form = e.target as HTMLFormElement;
      const email = (form.elements.namedItem('email') as HTMLInputElement).value;
      const errorDiv = document.getElementById('error-message');
      const successDiv = document.getElementById('success-message');
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

      if (!errorDiv || !successDiv || !submitButton) return;

      // Disable submit button and show loading state
      submitButton.disabled = true;
      submitButton.textContent = 'Sending...';
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');

      try {
        // Get the current site URL for the redirect
        const redirectUrl = `${window.location.origin}/reset-password`;

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: redirectUrl,
        });

        if (error) {
          errorDiv.textContent = 'Unable to send reset email. Please check your email address and try again.';
          errorDiv.classList.remove('hidden');
          submitButton.disabled = false;
          submitButton.textContent = 'Send Reset Link';
        } else {
          // Show success message
          successDiv.innerHTML = `
            <p class="font-semibold mb-2">Check your email!</p>
            <p>If an account exists with <strong>${email}</strong>, you'll receive a password reset link shortly.</p>
            <p class="mt-2 text-xs opacity-75">Don't see it? Check your spam folder.</p>
          `;
          successDiv.classList.remove('hidden');
          submitButton.textContent = 'Email Sent';
          // Keep button disabled to prevent spam
        }
      } catch (err) {
        console.error('Password reset error:', err);
        errorDiv.textContent = 'An error occurred. Please try again later.';
        errorDiv.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'Send Reset Link';
      }
    });
  </script>
</BaseLayout>
