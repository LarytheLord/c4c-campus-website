---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Student Dashboard - C4C Campus" hideHeader={true} hideFooter={true}>
  <div class="min-h-screen bg-background">
    <!-- Dashboard Header -->
    <div class="sticky top-0 z-50 bg-white border-b border-border">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
            <a href="/dashboard" class="flex-shrink-0">
              <img src="/logo.jpeg" alt="C4C Campus" class="h-10 w-10 rounded-lg" />
            </a>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold">Student Dashboard</h1>
              <p class="text-text-muted text-sm" id="welcome-text">Welcome back!</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <!-- Navigation Links -->
            <a href="/courses" class="hidden sm:block btn btn-ghost btn-sm">Courses</a>

            <!-- Language Selector -->
            <select id="language-selector" class="notranslate hidden sm:block border border-border rounded-lg px-3 py-2 text-sm bg-background" translate="no">
              <option value="">Language</option>
              <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
              <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
              <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
              <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
              <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
              <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
              <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
              <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
              <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
              <option value="es">Espa√±ol</option>
              <option value="fr">Fran√ßais</option>
              <option value="de">Deutsch</option>
              <option value="pt">Portugu√™s</option>
              <option value="zh-CN">‰∏≠Êñá</option>
              <option value="ja">Êó•Êú¨Ë™û</option>
              <option value="ko">ÌïúÍµ≠Ïñ¥</option>
              <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
            <div id="google_translate_element" style="display: none;"></div>
            <button id="logout-btn" class="btn btn-ghost text-sm">
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading your dashboard...</p>
      </div>
    </div>

    <!-- Dashboard Content (Hidden until loaded) -->
    <div id="dashboard-content" class="hidden">
      <div class="container mx-auto px-4 py-8">
        <!-- Main Content -->
        <div>
          <!-- Welcome Message -->
          <div class="card mb-6">
            <h2 class="text-2xl font-bold mb-2">Welcome to C4C Campus!</h2>
            <p class="text-text-muted">Your learning hub for courses, progress tracking, and workflow automation.</p>
          </div>

          <!-- My Courses Section -->
          <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold">üìö My Courses</h2>
              <a href="/courses" class="btn btn-ghost btn-sm">View All ‚Üí</a>
            </div>
            <div id="courses-loading" class="text-center py-8">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
              <p class="mt-2 text-text-muted text-sm">Loading courses...</p>
            </div>
            <div id="courses-list" class="hidden space-y-3">
              <!-- Courses will be inserted here -->
            </div>
            <div id="courses-empty" class="hidden text-center py-8 text-text-muted">
              <p>No courses enrolled yet. Browse available courses to get started!</p>
              <a href="/courses" class="btn btn-primary mt-4">Browse Courses</a>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="card">
              <div class="flex items-center gap-3">
                <div class="p-3 bg-primary/10 rounded-lg">
                  <span class="text-2xl">üìö</span>
                </div>
                <div>
                  <p class="text-sm text-text-muted">Enrolled Courses</p>
                  <p class="text-2xl font-bold" id="stat-enrolled">-</p>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="flex items-center gap-3">
                <div class="p-3 bg-green-500/10 rounded-lg">
                  <span class="text-2xl">‚úÖ</span>
                </div>
                <div>
                  <p class="text-sm text-text-muted">Completed</p>
                  <p class="text-2xl font-bold" id="stat-completed">-</p>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="flex items-center gap-3">
                <div class="p-3 bg-blue-500/10 rounded-lg">
                  <span class="text-2xl">‚è±Ô∏è</span>
                </div>
                <div>
                  <p class="text-sm text-text-muted">Total Hours</p>
                  <p class="text-2xl font-bold" id="stat-hours">-</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Not Logged In State -->
    <div id="not-logged-in" class="hidden container mx-auto px-4 py-12">
      <div class="max-w-md mx-auto text-center">
        <div class="card">
          <h2 class="text-2xl font-bold mb-4">Please Sign In</h2>
          <p class="text-text-muted mb-6">You need to be logged in to access the student dashboard.</p>
          <a href="/login" class="btn btn-primary">
            Go to Login
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';
    import { escapeHTML } from '../lib/security';

    let currentUser: any = null;

    // Check authentication on page load
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        // Not logged in
        document.getElementById('loading-state')?.classList.add('hidden');
        document.getElementById('not-logged-in')?.classList.remove('hidden');
        return;
      }

      currentUser = session.user;

      // Fetch user's application data
      const { data: application } = await supabase
        .from('applications')
        .select('*')
        .eq('user_id', currentUser.id)
        .single();

      if (application) {
        // Check if user has student role - redirect teachers/admins to their dashboards
        if (application.role === 'admin') {
          window.location.href = '/admin/dashboard';
          return;
        } else if (application.role === 'teacher') {
          window.location.href = '/teacher/courses';
          return;
        }

        // Update UI with user data
        const welcomeText = document.getElementById('welcome-text');
        if (welcomeText) {
          welcomeText.textContent = `Welcome back, ${application.name.split(' ')[0]}!`;
        }
      }

      // Show dashboard
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('dashboard-content')?.classList.remove('hidden');

      // Load course data
      loadEnrollments();
    }

    // Load user's course enrollments with real progress data
    async function loadEnrollments() {
      const coursesLoading = document.getElementById('courses-loading');
      const coursesList = document.getElementById('courses-list');
      const coursesEmpty = document.getElementById('courses-empty');

      try {
        // Fetch user's enrollments with course data
        const { data: enrollments, error } = await supabase
          .from('enrollments')
          .select(`
            *,
            courses:course_id (
              id,
              title,
              slug,
              description,
              track,
              default_duration_weeks,
              thumbnail_url
            )
          `)
          .eq('user_id', currentUser.id)
          .eq('status', 'active');

        if (error) throw error;

        coursesLoading?.classList.add('hidden');

        if (!enrollments || enrollments.length === 0) {
          coursesEmpty?.classList.remove('hidden');
          document.getElementById('stat-enrolled')!.textContent = '0';
          document.getElementById('stat-completed')!.textContent = '0';
          document.getElementById('stat-hours')!.textContent = '0';
          return;
        }

        // Fetch actual progress data for each course
        const courseIds = enrollments.map((e: any) => e.courses.id);

        // Get modules for these courses
        const { data: modules } = await supabase
          .from('modules')
          .select('id, course_id')
          .in('course_id', courseIds);

        const moduleIds = modules?.map(m => m.id) || [];
        const modulesByCourse: Record<number, number[]> = {};
        modules?.forEach((m: any) => {
          if (!modulesByCourse[m.course_id]) modulesByCourse[m.course_id] = [];
          modulesByCourse[m.course_id].push(m.id);
        });

        // Get lessons for these modules
        const { data: lessons } = moduleIds.length > 0
          ? await supabase.from('lessons').select('id, module_id').in('module_id', moduleIds)
          : { data: [] };

        const lessonsByModule: Record<number, number[]> = {};
        lessons?.forEach((l: any) => {
          if (!lessonsByModule[l.module_id]) lessonsByModule[l.module_id] = [];
          lessonsByModule[l.module_id].push(l.id);
        });

        // Calculate total lessons per course
        const totalLessonsByCourse: Record<number, number> = {};
        courseIds.forEach((courseId: number) => {
          const courseModules = modulesByCourse[courseId] || [];
          let total = 0;
          courseModules.forEach(moduleId => {
            total += (lessonsByModule[moduleId] || []).length;
          });
          totalLessonsByCourse[courseId] = total;
        });

        // Get lesson progress for this user
        const allLessonIds = lessons?.map(l => l.id) || [];
        const { data: progressData } = allLessonIds.length > 0
          ? await supabase
              .from('lesson_progress')
              .select('lesson_id, completed, time_spent_seconds')
              .eq('user_id', currentUser.id)
              .in('lesson_id', allLessonIds)
          : { data: [] };

        // Map progress by lesson_id
        const progressByLesson: Record<number, any> = {};
        progressData?.forEach((p: any) => {
          progressByLesson[p.lesson_id] = p;
        });

        // Calculate progress per course
        type CourseProgress = {
          completedLessons: number;
          totalLessons: number;
          percentage: number;
          timeSpentSeconds: number;
        };
        const progressByCourse: Record<number, CourseProgress> = {};

        courseIds.forEach((courseId: number) => {
          const courseModules = modulesByCourse[courseId] || [];
          let completedLessons = 0;
          let timeSpentSeconds = 0;
          let totalLessons = totalLessonsByCourse[courseId] || 0;

          courseModules.forEach(moduleId => {
            const moduleLessons = lessonsByModule[moduleId] || [];
            moduleLessons.forEach(lessonId => {
              const progress = progressByLesson[lessonId];
              if (progress?.completed) completedLessons++;
              if (progress?.time_spent_seconds) timeSpentSeconds += progress.time_spent_seconds;
            });
          });

          progressByCourse[courseId] = {
            completedLessons,
            totalLessons,
            percentage: totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0,
            timeSpentSeconds,
          };
        });

        // Helper to format track names (e.g., "animal_advocacy" -> "Animal Advocacy")
        function formatTrackName(track: string): string {
          return track
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
        }

        // Display courses with real progress
        coursesList!.innerHTML = enrollments.map((enrollment: any) => {
          const course = enrollment.courses;
          const isCompleted = enrollment.completed_at !== null;
          const progress = progressByCourse[course.id] || { completedLessons: 0, totalLessons: 0, percentage: 0, timeSpentSeconds: 0 };
          const timeSpentHours = Math.round((progress.timeSpentSeconds / 3600) * 10) / 10;
          const formattedTrack = course.track ? formatTrackName(course.track) : '';

          return `
            <a href="/courses/${escapeHTML(course.slug)}" class="block border border-border rounded-lg p-4 hover:bg-surface-hover transition-colors">
              <div class="flex items-start gap-4">
                ${course.thumbnail_url ? `<img src="${escapeHTML(course.thumbnail_url)}" alt="${escapeHTML(course.title)}" class="w-20 h-20 rounded-lg object-cover" />` : ''}
                <div class="flex-1">
                  <h4 class="font-semibold text-lg">${escapeHTML(course.title)}</h4>
                  <p class="text-sm text-text-muted mt-1">${escapeHTML(course.description || '')}</p>

                  <!-- Progress bar -->
                  <div class="mt-3">
                    <div class="flex items-center justify-between text-xs text-text-muted mb-1">
                      <span>${progress.completedLessons}/${progress.totalLessons} lessons</span>
                      <span>${progress.percentage}% complete</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div class="bg-fuchsia-500 h-2 rounded-full transition-all" style="width: ${progress.percentage}%"></div>
                    </div>
                  </div>

                  <div class="flex items-center gap-4 mt-3 text-sm text-text-muted">
                    ${formattedTrack ? `<span class="px-2 py-1 bg-fuchsia-100 text-fuchsia-800 rounded">${escapeHTML(formattedTrack)}</span>` : ''}
                    <span>‚è±Ô∏è ${timeSpentHours}h spent</span>
                    ${isCompleted ? '<span class="text-green-500">‚úì Completed</span>' : '<span class="text-blue-500">In Progress</span>'}
                  </div>
                </div>
              </div>
            </a>
          `;
        }).join('');

        coursesList?.classList.remove('hidden');

        // Update stats with real progress data
        const completedCount = enrollments.filter((e: any) => e.completed_at !== null).length;

        // Calculate total completed lessons and time from real progress
        let totalCompletedLessons = 0;
        let totalTimeSpentSeconds = 0;
        Object.values(progressByCourse).forEach((p: CourseProgress) => {
          totalCompletedLessons += p.completedLessons;
          totalTimeSpentSeconds += p.timeSpentSeconds;
        });

        const totalHours = Math.round((totalTimeSpentSeconds / 3600) * 10) / 10;

        document.getElementById('stat-enrolled')!.textContent = enrollments.length.toString();
        document.getElementById('stat-completed')!.textContent = completedCount.toString();
        document.getElementById('stat-hours')!.textContent = totalHours.toString();

      } catch (error) {
        console.error('Error loading enrollments:', error);
        coursesLoading?.classList.add('hidden');
        coursesEmpty?.classList.remove('hidden');
        document.getElementById('stat-enrolled')!.textContent = '0';
        document.getElementById('stat-completed')!.textContent = '0';
        document.getElementById('stat-hours')!.textContent = '0';
      }
    }

    // Logout handler
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/login';
    });

    // Google Translate Integration
    const languageSelector = document.getElementById('language-selector');
    if (languageSelector) {
      languageSelector.addEventListener('change', function() {
        const lang = (this as HTMLSelectElement).value;
        if (lang) {
          // Wait for Google Translate to initialize
          setTimeout(function() {
            const select = document.querySelector('.goog-te-combo') as HTMLSelectElement;
            if (select) {
              select.value = lang;
              select.dispatchEvent(new Event('change'));
            }
          }, 500);
        }
      });
    }

    // Initialize
    checkAuth();
  </script>

  <!-- Google Translate Script -->
  <script is:inline type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  <script is:inline type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'hi,ta,te,kn,bn,mr,gu,ml,pa,or,as,ur,es,fr,de,pt,zh-CN,ja,ko,ar',
        autoDisplay: false
      }, 'google_translate_element');
    }
  </script>
</BaseLayout>
