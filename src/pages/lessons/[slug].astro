---
/**
 * Lesson Page - Individual lesson with video, content, and discussions
 *
 * Features:
 * - Video player
 * - Lesson content (markdown)
 * - Downloadable resources
 * - Discussion thread
 * - Progress tracking
 * - Navigation (prev/next lesson)
 *
 * URL: /lessons/{slug}
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
// Note: DiscussionThread is dynamically imported in client-side script

export const prerender = false;
---

<BaseLayout title="Lesson - C4C Campus" hideHeader={true} hideFooter={true}>
  <div class="min-h-screen bg-background">
    <!-- Header -->
    <div class="sticky top-0 z-50 bg-white border-b border-border">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
            <a href="/dashboard" class="flex-shrink-0">
              <img src="/logo.jpeg" alt="C4C Campus" class="h-10 w-10 rounded-lg" />
            </a>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold" id="lesson-title">Lesson</h1>
              <p class="text-text-muted text-sm" id="breadcrumb">Loading...</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="back-btn" class="btn btn-ghost btn-sm">Back to Course</button>
            <button id="logout-btn" class="btn btn-ghost text-sm">Sign Out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-4 py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        <p class="mt-4 text-text-muted">Loading lesson...</p>
      </div>
    </div>

    <!-- Lesson Content -->
    <div id="lesson-content" class="hidden">
      <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Video Player -->
        <div id="video-container" class="mb-8">
          <div class="bg-black rounded-lg overflow-hidden shadow-lg aspect-video">
            <video
              id="lesson-video"
              class="w-full h-full"
              controls
              controlslist="nodownload"
            >
              <source id="video-source" src="" type="video/mp4" />
              Your browser does not support the video tag.
            </video>
          </div>
          <div class="mt-4 flex items-center justify-between">
            <div>
              <button id="mark-complete-btn" class="btn btn-primary">
                Mark as Complete
              </button>
            </div>
            <div class="flex gap-2">
              <button id="prev-lesson-btn" class="btn btn-ghost btn-sm" style="display: none;">
                ‚Üê Previous
              </button>
              <button id="next-lesson-btn" class="btn btn-ghost btn-sm" style="display: none;">
                Next ‚Üí
              </button>
            </div>
          </div>
        </div>

        <!-- Lesson Text Content -->
        <div id="text-content-container" class="hidden mb-8 card">
          <div class="prose prose-sm sm:prose max-w-none" id="text-content">
            <!-- Markdown content will be rendered here -->
          </div>
        </div>

        <!-- Resources -->
        <div id="resources-container" class="hidden mb-8 card">
          <h3 class="text-lg font-bold mb-4">Resources</h3>
          <div id="resources-list" class="space-y-2">
            <!-- Resources will be listed here -->
          </div>
        </div>

        <!-- Assignments -->
        <div id="assignments-container" class="hidden mb-8 card">
          <h3 class="text-lg font-bold mb-4">Assignments</h3>
          <div id="assignments-list" class="space-y-3">
            <!-- Assignments will be listed here -->
          </div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container" class="hidden mb-8">
          <div id="quiz-root"></div>
        </div>

        <!-- Discussion Section -->
        <div id="discussion-container" class="card">
          <div id="discussion-root"></div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';
  import { marked } from 'marked';
  import { showToast } from '@/lib/notifications';
  import { canAccessLesson } from '@/lib/time-gating';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl!, supabaseAnonKey!);

  let currentUser: any = null;
  let currentLesson: any = null;
  let currentModule: any = null;
  let currentCourse: any = null;
  let userCohortId: string | null = null;
  let isTeacher = false;
  let hasAccess = false;
  let accessReason: string = '';

  // Progress tracking state
  let existingProgressId: number | null = null; // Cache existing progress record ID for updates
  let existingProgressData: any = null; // Cached progress data
  let localTimeSpentSeconds = 0; // Accumulator for time tracking
  let lastSaveTime = 0; // Track when we last saved (for 10s interval)

  async function init() {
    // Get slug from URL
    const pathParts = window.location.pathname.split('/');
    const slug = pathParts[pathParts.length - 1];

    // Check authentication
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }

    currentUser = user;

    // Check if user is teacher
    const { data: application } = await supabase
      .from('applications')
      .select('email')
      .eq('user_id', user.id)
      .single();

    isTeacher = application?.email?.startsWith('teacher@') || false;

    // Load lesson
    await loadLesson(slug);

    // Show content
    document.getElementById('loading-state')?.classList.add('hidden');
    document.getElementById('lesson-content')?.classList.remove('hidden');

    // Render discussion component
    renderDiscussion();

    setupEventListeners();
  }

  async function loadLesson(slug: string) {
    // Fetch lesson with module and course info
    const { data: lesson, error } = await supabase
      .from('lessons')
      .select(`
        *,
        modules:module_id (
          *,
          courses:course_id (*)
        )
      `)
      .eq('slug', slug)
      .single();

    if (error || !lesson) {
      showToast('Lesson not found', 'error');
      setTimeout(() => {
        window.location.href = '/courses';
      }, 1500);
      return;
    }

    currentLesson = lesson;
    currentModule = lesson.modules;
    currentCourse = lesson.modules.courses;

    // Get user's cohort for this course - filter by course to avoid mismatched cohorts
    const { data: enrollment } = await supabase
      .from('cohort_enrollments')
      .select(`
        cohort_id,
        cohorts!inner (
          course_id
        )
      `)
      .eq('user_id', currentUser.id)
      .eq('status', 'active')
      .eq('cohorts.course_id', currentCourse.id)
      .limit(1)
      .single();

    userCohortId = enrollment?.cohort_id || null;

    // Query existing lesson_progress for video resume and to cache record ID
    const { data: existingProgress } = await supabase
      .from('lesson_progress')
      .select('id, video_position_seconds, time_spent_seconds, completed, watch_count')
      .eq('user_id', currentUser.id)
      .eq('lesson_id', currentLesson.id)
      .single();

    if (existingProgress) {
      existingProgressId = existingProgress.id;
      existingProgressData = existingProgress;
      localTimeSpentSeconds = existingProgress.time_spent_seconds || 0;
    }

    // Check lesson access using time-gating utilities
    const accessStatus = await canAccessLesson(
      currentLesson.id,
      currentUser.id,
      supabase,
      isTeacher
    );

    hasAccess = accessStatus.canAccess;
    accessReason = accessStatus.reason;

    // If user doesn't have access, show appropriate message and hide content
    if (!hasAccess) {
      document.getElementById('loading-state')?.classList.add('hidden');
      const contentDiv = document.getElementById('lesson-content');
      if (contentDiv) {
        contentDiv.classList.remove('hidden');
        let message = '';
        if (accessReason === 'not_enrolled') {
          message = 'You are not enrolled in this course. Please enroll to access this lesson.';
        } else if (accessReason === 'module_locked') {
          message = 'This module is currently locked. It will be available when unlocked by your instructor.';
        } else {
          message = 'You do not have access to this lesson.';
        }

        contentDiv.innerHTML = `
          <div class="container mx-auto px-4 py-12">
            <div class="max-w-md mx-auto text-center">
              <div class="mb-6">
                <svg class="w-16 h-16 mx-auto text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
              </div>
              <h2 class="text-2xl font-bold mb-4">Access Restricted</h2>
              <p class="text-text-muted mb-6">${message}</p>
              <a href="/courses/${currentCourse.slug}" class="btn btn-primary">
                Back to Course
              </a>
            </div>
          </div>
        `;
      }
      return;
    }

    // Update UI
    document.getElementById('lesson-title')!.textContent = lesson.title;
    document.getElementById('breadcrumb')!.textContent =
      `${currentCourse.title} / ${currentModule.title} / ${lesson.title}`;

    // Video with resume support
    const videoDiv = document.querySelector('#video-container .bg-black') as HTMLElement;
    const resumePosition = existingProgressData?.video_position_seconds || 0;

    if (lesson.video_url) {
      // Check if it's a YouTube URL
      const youtubeId = extractYouTubeId(lesson.video_url);
      if (youtubeId && videoDiv) {
        // For YouTube, pass start time via query parameter
        const startParam = resumePosition > 0 ? `&start=${Math.floor(resumePosition)}` : '';
        videoDiv.innerHTML = `
          <iframe
            class="w-full h-full"
            src="https://www.youtube.com/embed/${youtubeId}?enablejsapi=1${startParam}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        `;
      } else {
        // Regular HTML5 video file
        const videoSource = document.getElementById('video-source') as HTMLSourceElement;
        videoSource.src = lesson.video_url;
        const video = document.getElementById('lesson-video') as HTMLVideoElement;
        video.load();

        // Resume from saved position once metadata is loaded
        if (resumePosition > 0) {
          video.addEventListener('loadedmetadata', () => {
            video.currentTime = resumePosition;
          }, { once: true });
        }

        // Setup video progress tracking
        setupVideoProgressTracking(video);
      }
    } else {
      document.getElementById('video-container')?.classList.add('hidden');
    }

    // Text content
    if (lesson.content) {
      const container = document.getElementById('text-content-container');
      const content = document.getElementById('text-content');
      if (container && content) {
        content.innerHTML = marked.parse(lesson.content) as string;
        container.classList.remove('hidden');
      }
    }

    // Resources
    if (lesson.resources && lesson.resources.length > 0) {
      const container = document.getElementById('resources-container');
      const list = document.getElementById('resources-list');
      if (container && list) {
        list.innerHTML = lesson.resources.map((resource: any) => `
          <a
            href="${resource.path}"
            download
            class="flex items-center gap-3 p-3 border border-border rounded-lg hover:bg-surface-hover transition-colors"
          >
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <div class="flex-1">
              <div class="font-medium">${resource.name}</div>
              <div class="text-xs text-text-muted">${formatBytes(resource.size)}</div>
            </div>
          </a>
        `).join('');
        container.classList.remove('hidden');
      }
    }

    // Load assignments for this lesson
    await loadAssignments();

    // Load quizzes for this lesson
    await loadQuizzes();

    // Back button
    const backBtn = document.getElementById('back-btn');
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        window.location.href = `/courses/${currentCourse.slug}`;
      });
    }
  }

  async function loadAssignments() {
    if (!currentLesson) return;

    try {
      // Fetch assignments for this lesson
      const { data: assignments, error } = await supabase
        .from('assignments')
        .select('*')
        .eq('lesson_id', currentLesson.id)
        .eq('is_published', true)
        .order('due_date', { ascending: true });

      if (error) {
        console.error('Error loading assignments:', error);
        return;
      }

      if (!assignments || assignments.length === 0) {
        return;
      }

      // Get user's submissions for these assignments
      const assignmentIds = assignments.map(a => a.id);
      const { data: submissions } = await supabase
        .from('assignment_submissions')
        .select('*')
        .in('assignment_id', assignmentIds)
        .eq('user_id', currentUser.id);

      const container = document.getElementById('assignments-container');
      const list = document.getElementById('assignments-list');

      if (!container || !list) return;

      const now = new Date();

      list.innerHTML = assignments.map((assignment: any) => {
        const submission = submissions?.find((s: any) => s.assignment_id === assignment.id);
        const dueDate = assignment.due_date ? new Date(assignment.due_date) : null;
        const isPastDue = dueDate && now > dueDate;
        const hasSubmission = submission !== undefined;

        let statusBadge = '';
        let statusColor = 'border-blue-200 bg-blue-50';

        if (!hasSubmission) {
          if (isPastDue && !assignment.allow_late_submissions) {
            statusBadge = '<span class="px-3 py-1 bg-red-100 text-red-700 text-xs font-medium rounded-full">Closed</span>';
            statusColor = 'border-gray-300 bg-gray-50';
          } else if (isPastDue) {
            statusBadge = '<span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full">Late</span>';
            statusColor = 'border-orange-200 bg-orange-50';
          } else {
            statusBadge = '<span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">Not Submitted</span>';
            statusColor = 'border-blue-200 bg-blue-50';
          }
        } else if (submission.status === 'graded') {
          const points = submission.score || 0;
          statusBadge = `<span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">Graded: ${points}/${assignment.max_points}</span>`;
          statusColor = 'border-green-200 bg-green-50';
        } else {
          statusBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded-full">Submitted</span>';
          statusColor = 'border-yellow-200 bg-yellow-50';
        }

        return `
          <a
            href="/assignments/${assignment.id}"
            class="flex items-start justify-between gap-4 p-4 border-2 ${statusColor} rounded-lg hover:shadow-md transition-all"
          >
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h4 class="font-semibold text-base truncate">${assignment.title}</h4>
                ${statusBadge}
              </div>
              ${assignment.description ? `<p class="text-sm text-text-muted line-clamp-2 mb-2">${assignment.description}</p>` : ''}
              <div class="flex items-center gap-4 text-xs text-text-muted">
                ${dueDate ? `
                  <span class="${isPastDue ? 'text-red-600 font-medium' : ''}">
                    üìÖ Due: ${dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                  </span>
                ` : '<span>No due date</span>'}
                <span>üéØ ${assignment.max_points} points</span>
              </div>
            </div>
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </a>
        `;
      }).join('');

      container.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading assignments:', error);
    }
  }

  async function loadQuizzes() {
    if (!currentLesson) return;

    try {
      // Fetch quizzes for this lesson
      const { data: quizzes, error } = await supabase
        .from('quizzes')
        .select('id')
        .eq('lesson_id', currentLesson.id)
        .eq('is_published', true);

      if (error) {
        console.error('Error loading quizzes:', error);
        return;
      }

      if (!quizzes || quizzes.length === 0) {
        return;
      }

      const container = document.getElementById('quiz-container');
      const root = document.getElementById('quiz-root');

      if (!container || !root) return;

      // Show the first quiz (typically one quiz per lesson)
      const quizId = quizzes[0].id;

      // Import and render QuizCard component
      import('../../components/QuizCard').then(({ QuizCard }) => {
        import('react-dom/client').then(({ createRoot }) => {
          const reactRoot = createRoot(root);
          reactRoot.render(
            QuizCard({
              quizId,
              lessonId: currentLesson.id,
            })
          );
        });
      });

      container.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading quizzes:', error);
    }
  }

  function renderDiscussion() {
    if (!userCohortId || !currentLesson) return;

    const root = document.getElementById('discussion-root');
    if (!root) return;

    // Import and render React component
    import('../../components/DiscussionThread').then(({ DiscussionThread }) => {
      import('react-dom/client').then(({ createRoot }) => {
        import('react').then(({ createElement }) => {
          const reactRoot = createRoot(root);
          reactRoot.render(createElement(DiscussionThread, {
            lessonId: currentLesson.id,
            cohortId: userCohortId!,
            currentUserId: currentUser.id,
            isTeacher: isTeacher,
          }));
        });
      });
    });
  }

  function extractYouTubeId(url: string): string | null {
    const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[7].length === 11) ? match[7] : null;
  }

  function formatBytes(bytes: number): string {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Setup video progress tracking with periodic auto-save
  function setupVideoProgressTracking(video: HTMLVideoElement) {
    let isPlaying = false;
    let playStartTime = 0;

    // Track play/pause for time accumulation
    video.addEventListener('play', () => {
      isPlaying = true;
      playStartTime = Date.now();
    });

    video.addEventListener('pause', () => {
      if (isPlaying) {
        const elapsed = Math.floor((Date.now() - playStartTime) / 1000);
        localTimeSpentSeconds += elapsed;
      }
      isPlaying = false;
      // Save on pause
      saveVideoProgress(video.currentTime, false);
    });

    // Auto-save every 10 seconds during playback
    video.addEventListener('timeupdate', () => {
      const now = Date.now();
      if (now - lastSaveTime >= 10000) { // 10 seconds
        if (isPlaying) {
          const elapsed = Math.floor((now - playStartTime) / 1000);
          localTimeSpentSeconds += elapsed;
          playStartTime = now; // Reset for next interval
        }
        saveVideoProgress(video.currentTime, false);
        lastSaveTime = now;
      }
    });

    // Save on page unload
    window.addEventListener('beforeunload', () => {
      if (isPlaying) {
        const elapsed = Math.floor((Date.now() - playStartTime) / 1000);
        localTimeSpentSeconds += elapsed;
      }
      // Use sendBeacon for reliable delivery on page close
      saveVideoProgressSync(video.currentTime);
    });
  }

  // Async save video progress (upsert)
  async function saveVideoProgress(positionSeconds: number, completed: boolean) {
    if (!currentUser || !currentLesson) return;

    const progressData: any = {
      user_id: currentUser.id,
      lesson_id: currentLesson.id,
      video_position_seconds: Math.floor(positionSeconds),
      time_spent_seconds: localTimeSpentSeconds,
      last_accessed_at: new Date().toISOString(),
    };

    // Include cohort_id when user is in a cohort
    if (userCohortId) {
      progressData.cohort_id = userCohortId;
    }

    if (completed) {
      progressData.completed = true;
      progressData.completed_at = new Date().toISOString();
    }

    // If we have an existing record, update by ID; otherwise upsert on unique constraint
    if (existingProgressId) {
      await supabase
        .from('lesson_progress')
        .update(progressData)
        .eq('id', existingProgressId);
    } else {
      const { data } = await supabase
        .from('lesson_progress')
        .upsert(progressData, { onConflict: 'user_id,lesson_id' })
        .select('id')
        .single();

      if (data) {
        existingProgressId = data.id;
      }
    }
  }

  // Synchronous save for beforeunload (uses sendBeacon fallback)
  function saveVideoProgressSync(positionSeconds: number) {
    if (!currentUser || !currentLesson) return;

    const progressData: any = {
      user_id: currentUser.id,
      lesson_id: currentLesson.id,
      video_position_seconds: Math.floor(positionSeconds),
      time_spent_seconds: localTimeSpentSeconds,
      last_accessed_at: new Date().toISOString(),
    };

    if (userCohortId) {
      progressData.cohort_id = userCohortId;
    }

    // Attempt to use sendBeacon for reliable delivery
    // This is a best-effort save on page close
    // Note: sendBeacon doesn't support custom headers, so this is limited
    try {
      const url = `${supabaseUrl}/rest/v1/lesson_progress?on_conflict=user_id,lesson_id`;
      const body = JSON.stringify(progressData);
      if (navigator.sendBeacon) {
        navigator.sendBeacon(url, new Blob([body], { type: 'application/json' }));
      }
    } catch {
      // Silently fail - best effort
    }
  }

  function setupEventListeners() {
    // Mark complete button - enhanced to update existing record with full data
    document.getElementById('mark-complete-btn')?.addEventListener('click', async () => {
      if (!currentUser || !currentLesson) return;

      // Get video duration if available
      const video = document.getElementById('lesson-video') as HTMLVideoElement;
      const videoDuration = video?.duration ? Math.floor(video.duration) : 0;

      const progressData: any = {
        user_id: currentUser.id,
        lesson_id: currentLesson.id,
        completed: true,
        completed_at: new Date().toISOString(),
        last_accessed_at: new Date().toISOString(),
        time_spent_seconds: localTimeSpentSeconds,
      };

      // Set video_position_seconds to lesson duration if available
      if (videoDuration > 0) {
        progressData.video_position_seconds = videoDuration;
      }

      // Include cohort_id when user is in a cohort
      if (userCohortId) {
        progressData.cohort_id = userCohortId;
      }

      // Increment watch_count if this is a revisit completion
      if (existingProgressData?.completed) {
        progressData.watch_count = (existingProgressData.watch_count || 1) + 1;
      } else {
        progressData.watch_count = existingProgressData?.watch_count || 1;
      }

      let error;
      if (existingProgressId) {
        // Update existing record
        const result = await supabase
          .from('lesson_progress')
          .update(progressData)
          .eq('id', existingProgressId);
        error = result.error;
      } else {
        // Upsert new record
        const result = await supabase
          .from('lesson_progress')
          .upsert(progressData, { onConflict: 'user_id,lesson_id' });
        error = result.error;
      }

      if (error) {
        showToast('Failed to mark lesson as complete', 'error');
      } else {
        showToast('Lesson marked as complete!', 'success');
        // Update local state
        if (existingProgressData) {
          existingProgressData.completed = true;
        }
      }
    });

    // Logout
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/login';
    });
  }

  // Initialize
  init();
</script>
</BaseLayout>
