---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Set New Password - Code for Compassion Campus"
  description="Set a new password for your C4C Campus account."
>
  <div class="container mx-auto px-4 py-16">
    <div class="max-w-md mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-black mb-4">Set New Password</h1>
        <p class="text-text-muted">
          Enter your new password below.
        </p>
      </div>

      <!-- Reset Password Card -->
      <div class="card p-8">
        <!-- Loading state while verifying token -->
        <div id="loading-state" class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent mb-4"></div>
          <p class="text-text-muted">Verifying your reset link...</p>
        </div>

        <!-- Error state for invalid/expired token -->
        <div id="error-state" class="hidden text-center py-8">
          <div class="text-5xl mb-4">⚠️</div>
          <h2 class="text-xl font-bold mb-2 text-error">Invalid or Expired Link</h2>
          <p class="text-text-muted mb-6">
            This password reset link is invalid or has expired. Please request a new one.
          </p>
          <a href="/forgot-password" class="btn btn-primary">
            Request New Link
          </a>
        </div>

        <!-- Form state for valid token -->
        <form id="reset-password-form" class="hidden space-y-6">
          <div>
            <label for="password" class="block text-sm font-semibold mb-2">New Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="12"
              pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]).{12,}$"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-colors"
              placeholder="Min 12 chars: Aa1!@#"
            />
            <p class="text-xs text-text-muted mt-1">Must include: uppercase (A-Z), lowercase (a-z), number (0-9), special char (!@#$%^&* etc.)</p>
          </div>

          <div>
            <label for="confirmPassword" class="block text-sm font-semibold mb-2">Confirm New Password</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              required
              minlength="12"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-colors"
              placeholder="Re-enter your new password"
            />
          </div>

          <button
            type="submit"
            class="btn btn-primary w-full"
          >
            Update Password
          </button>

          <div id="form-error-message" class="hidden mt-4 p-4 rounded-lg text-sm bg-error/10 text-error border border-error/20">
          </div>
        </form>

        <!-- Success state -->
        <div id="success-state" class="hidden text-center py-8">
          <div class="text-5xl mb-4">✓</div>
          <h2 class="text-xl font-bold mb-2 text-success">Password Updated!</h2>
          <p class="text-text-muted mb-6">
            Your password has been successfully updated. You can now sign in with your new password.
          </p>
          <a href="/login" class="btn btn-primary">
            Sign In
          </a>
        </div>
      </div>

      <!-- Info Box -->
      <div class="mt-8 card bg-surface p-6">
        <h3 class="font-bold mb-3">Password Requirements</h3>
        <ul class="text-sm text-text-muted space-y-1">
          <li>→ At least 12 characters long</li>
          <li>→ Contains uppercase letter (A-Z)</li>
          <li>→ Contains lowercase letter (a-z)</li>
          <li>→ Contains a number (0-9)</li>
          <li>→ Contains a special character (!@#$%^&* etc.)</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const formState = document.getElementById('reset-password-form');
    const successState = document.getElementById('success-state');

    // Check if we have a valid session from the reset link
    async function verifyResetToken() {
      try {
        // Supabase automatically handles the token from the URL hash
        // When user clicks the reset link, Supabase sets up the session
        const { data: { session }, error } = await supabase.auth.getSession();

        if (error || !session) {
          // Check if there's a hash fragment that might contain the token
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const accessToken = hashParams.get('access_token');
          const type = hashParams.get('type');

          if (accessToken && type === 'recovery') {
            // Set the session using the recovery token
            const { error: setSessionError } = await supabase.auth.setSession({
              access_token: accessToken,
              refresh_token: hashParams.get('refresh_token') || '',
            });

            if (setSessionError) {
              showError();
              return;
            }

            showForm();
          } else {
            showError();
          }
        } else {
          showForm();
        }
      } catch (err) {
        console.error('Token verification error:', err);
        showError();
      }
    }

    function showError() {
      loadingState?.classList.add('hidden');
      errorState?.classList.remove('hidden');
    }

    function showForm() {
      loadingState?.classList.add('hidden');
      formState?.classList.remove('hidden');
    }

    function showSuccess() {
      formState?.classList.add('hidden');
      successState?.classList.remove('hidden');
    }

    // Verify token on page load
    verifyResetToken();

    // Handle form submission
    formState?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const password = (document.getElementById('password') as HTMLInputElement).value;
      const confirmPassword = (document.getElementById('confirmPassword') as HTMLInputElement).value;
      const errorDiv = document.getElementById('form-error-message');
      const submitButton = formState.querySelector('button[type="submit"]') as HTMLButtonElement;

      if (!errorDiv || !submitButton) return;

      // Validate passwords match
      if (password !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match. Please try again.';
        errorDiv.classList.remove('hidden');
        return;
      }

      // Validate password strength
      const passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]).{12,}$/;
      if (!passwordPattern.test(password)) {
        errorDiv.textContent = 'Password does not meet the requirements. Please ensure it has at least 12 characters with uppercase, lowercase, number, and special character.';
        errorDiv.classList.remove('hidden');
        return;
      }

      // Disable submit button and show loading state
      submitButton.disabled = true;
      submitButton.textContent = 'Updating...';
      errorDiv.classList.add('hidden');

      try {
        const { error } = await supabase.auth.updateUser({
          password: password
        });

        if (error) {
          errorDiv.textContent = error.message || 'Unable to update password. Please try again.';
          errorDiv.classList.remove('hidden');
          submitButton.disabled = false;
          submitButton.textContent = 'Update Password';
        } else {
          // Sign out the user so they can log in with the new password
          await supabase.auth.signOut();
          showSuccess();
        }
      } catch (err) {
        console.error('Password update error:', err);
        errorDiv.textContent = 'An error occurred. Please try again later.';
        errorDiv.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'Update Password';
      }
    });
  </script>
</BaseLayout>
