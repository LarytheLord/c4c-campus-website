---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  image?: string;
  hideHeader?: boolean;
  hideFooter?: boolean;
}

const {
  title,
  description = 'India\'s first permanent AI innovation hub training developers to build responsible, impact-driven technology.',
  image = '/logo.jpeg',
  hideHeader = false,
  hideFooter = false
} = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Favicons - Using logo.jpeg as primary -->
    <link rel="icon" href="/logo.jpeg?v=4" type="image/jpeg" />
    <link rel="apple-touch-icon" href="/logo.jpeg?v=4" />
    <link rel="shortcut icon" href="/logo.jpeg?v=4" type="image/jpeg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.site)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.site)} />

    <!-- Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Theme Color -->
    <meta name="theme-color" content="#FF00FF" />

    <!-- Google Translate -->
    <script is:inline type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script is:inline type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement({
          pageLanguage: 'en',
          includedLanguages: 'hi,ta,te,kn,bn,mr,gu,ml,pa,or,as,ur,es,fr,de,pt,zh-CN,ja,ko,ar',
          autoDisplay: false
        }, 'google_translate_element');
      }

      // Function to change translation language
      function changeLanguage(lang) {
        // Store user's language preference in session storage
        sessionStorage.setItem('preferredLanguage', lang);
        
        if (lang === 'en') {
          // For English, we need to completely reset the translation state
          resetToEnglish();
          return true;
        }
        
        // For other languages, trigger Google Translate
        const select = document.querySelector('.goog-te-combo');
        if (select) {
          select.value = lang;
          select.dispatchEvent(new Event('change'));
          return true;
        }
        
        // If the select element isn't ready, try again after a delay
        setTimeout(() => {
          const selectRetry = document.querySelector('.goog-te-combo');
          if (selectRetry) {
            selectRetry.value = lang;
            selectRetry.dispatchEvent(new Event('change'));
          }
        }, 1000);
        
        return false;
      }

      function resetToEnglish() {
        // Clear Google Translate cookies
        clearGoogleTranslateCookies();
        
        // Remove Google Translate elements from the DOM
        cleanupGoogleTranslate();
        
        // Remove any Google Translate modifications to the body
        document.body.className = document.body.className
          .replace(/\bskiptranslate\b/g, '')
          .replace(/\btranslated-\w+\b/g, '')
          .replace(/\bgt-\w+\b/g, '')
          .trim();
        
        // Reset the Google Translate iframe container
        const translateContainer = document.getElementById('google_translate_element');
        if (translateContainer) {
          translateContainer.innerHTML = '';
        }
        
        // Force a reload to ensure original English content is displayed
        // Use a technique that bypasses cache
        window.location.href = window.location.href.split('#')[0] + '?t=' + new Date().getTime();
      }

      function clearGoogleTranslateCookies() {
        const cookies = document.cookie.split(';');
        cookies.forEach(cookie => {
          const eqPos = cookie.indexOf('=');
          const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
          
          if (name.startsWith('goog')) {
            // Delete the cookie with multiple domain/path variations
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${window.location.hostname};`;
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.${window.location.hostname};`;
          }
        });
      }

      function cleanupGoogleTranslate() {
        // Remove Google Translate iframes
        const iframes = document.querySelectorAll('iframe[src*="translate.googleapis"]');
        iframes.forEach(iframe => {
          iframe.parentNode?.removeChild(iframe);
        });
        
        // Remove Google Translate elements
        const selectorsToRemove = [
          '[class*="goog"]',
          '[class*="skiptranslate"]',
          '[id*=":0"]', // Common Google Translate ID pattern
          '[class*="gt-"]'
        ];
        
        selectorsToRemove.forEach(selector => {
          const elements = document.querySelectorAll(selector);
          elements.forEach(el => el.remove());
        });
      }

      // On page load, check if there's a preferred language
      document.addEventListener('DOMContentLoaded', function() {
        const preferredLang = sessionStorage.getItem('preferredLanguage');
        
        if (preferredLang && preferredLang !== 'en') {
          // If user previously selected a non-English language, reapply it after a delay
          // to ensure Google Translate is fully loaded
          setTimeout(() => {
            changeLanguage(preferredLang);
          }, 1500);
        } else if (preferredLang === 'en') {
          // If user prefers English, ensure translation is cleared
          // This handles cases where the page might have been cached with translation
          cleanupGoogleTranslate();
        }
        
        const languageSelector = document.getElementById('language-selector');
        if (languageSelector) {
          languageSelector.addEventListener('change', function() {
            const lang = this.value;
            if (lang) {
              // Try immediately first
              if (!changeLanguage(lang)) {
                // If not ready, retry with increasing delays
                let attempts = 0;
                const maxAttempts = 10;
                const tryChange = function() {
                  attempts++;
                  if (changeLanguage(lang)) {
                    return;
                  }
                  if (attempts < maxAttempts) {
                    setTimeout(tryChange, 300);
                  }
                };
                setTimeout(tryChange, 300);
              }
            }
          });
        }
      });
    </script>
  </head>
  <body class="bg-white text-gray-900 min-h-screen flex flex-col">
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Confirm Modal Container -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 z-[9998] flex items-center justify-center p-4">
      <div class="bg-white rounded-lg max-w-md w-full shadow-xl pointer-events-auto">
        <div class="p-6">
          <h3 class="text-xl font-bold mb-4" id="confirm-title">Confirm Action</h3>
          <p class="text-gray-600 mb-6" id="confirm-message"></p>
          <div class="flex gap-3 justify-end">
            <button id="confirm-cancel-btn" class="btn btn-ghost">Cancel</button>
            <button id="confirm-confirm-btn" class="btn btn-primary">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Google Translate target div (must always exist for widget initialization) -->
    <div id="google_translate_element" style="display: none;"></div>

    {!hideHeader && (
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-sm border-b border-gray-200">
      <nav class="w-full mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16 gap-4">
          <!-- Logo + Language Selector -->
          <div class="flex items-center gap-4 flex-shrink-0">
            <a href="/" class="flex items-center gap-3 font-bold text-xl whitespace-nowrap">
              <img src="/logo.jpeg" alt="Code for Compassion Campus" class="h-10 w-10 rounded-lg" />
              <span class="hidden lg:inline">Code for Compassion Campus</span>
            </a>

            <!-- Language Selector -->
            <select id="language-selector" class="notranslate hidden lg:block border border-gray-300 rounded-lg px-3 py-2 bg-white text-sm flex-shrink-0" translate="no" aria-label="Select page language">
              <option value="en">English</option>
              <option value="hi">हिन्दी</option>
              <option value="ta">தமிழ்</option>
              <option value="te">తెలుగు</option>
              <option value="kn">ಕನ್ನಡ</option>
              <option value="bn">বাংলা</option>
              <option value="mr">मराठी</option>
              <option value="gu">ગુજરાતી</option>
              <option value="ml">മലയാളം</option>
              <option value="pa">ਪੰਜਾਬੀ</option>
              <option value="es">Español</option>
              <option value="fr">Français</option>
              <option value="de">Deutsch</option>
              <option value="pt">Português</option>
              <option value="zh-CN">中文</option>
              <option value="ja">日本語</option>
              <option value="ko">한국어</option>
              <option value="ar">العربية</option>
            </select>
          </div>

          <!-- Mobile Menu Button -->
          <button
            id="mobile-menu-button"
            class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors"
            aria-label="Toggle menu"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center gap-4 lg:gap-6 flex-shrink-0">
            <a href="/framework" class="text-text hover:text-primary transition-colors font-medium whitespace-nowrap">Framework</a>
            <a href="/programs" class="text-text hover:text-primary transition-colors font-medium whitespace-nowrap">Programs</a>
            <a href="/tracks" class="text-text hover:text-primary transition-colors font-medium whitespace-nowrap">Tracks</a>
            <a href="/about" class="text-text hover:text-primary transition-colors font-medium whitespace-nowrap">About</a>
            <a href="/faq" class="text-text hover:text-primary transition-colors font-medium whitespace-nowrap">FAQ</a>
            <a href="/contact" class="text-text hover:text-primary transition-colors font-medium whitespace-nowrap">Contact</a>
            <a href="/login" class="btn btn-secondary whitespace-nowrap text-sm">
              Student Login
            </a>
            <a href="/apply" class="btn btn-primary whitespace-nowrap">
              Apply Now
            </a>
          </div>
        </div>

        <!-- Mobile Navigation -->
        <div id="mobile-menu" class="hidden md:hidden pb-4">
          <div class="flex flex-col gap-4">
            <a href="/framework" class="text-text hover:text-primary transition-colors font-medium">Framework</a>
            <a href="/programs" class="text-text hover:text-primary transition-colors font-medium">Programs</a>
            <a href="/tracks" class="text-text hover:text-primary transition-colors font-medium">Tracks</a>
            <a href="/about" class="text-text hover:text-primary transition-colors font-medium">About</a>
            <a href="/faq" class="text-text hover:text-primary transition-colors font-medium">FAQ</a>
            <a href="/contact" class="text-text hover:text-primary transition-colors font-medium">Contact</a>
            <a href="/login" class="btn btn-secondary w-full text-center">
              Student Login
            </a>
            <a href="/apply" class="btn btn-primary w-full text-center">
              Apply Now
            </a>
          </div>
        </div>
      </nav>
    </header>
    )}

    <main class="flex-grow">
      <slot />
    </main>

    {!hideFooter && (
    <footer class="bg-gray-900 text-gray-300">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <!-- About -->
          <div class="col-span-1 md:col-span-2">
            <div class="flex items-center gap-3 mb-4">
              <img src="/logo.jpeg" alt="Code for Compassion Campus" class="h-12 w-12 rounded-lg" />
              <span class="font-bold text-xl text-white">Code for Compassion Campus</span>
            </div>
            <p class="text-gray-400 max-w-md">
              Train in Bengaluru to build AI tools for animal advocacy, climate action, and AI safety - with ethics and impact built in from day one.
            </p>
          </div>

          <!-- Programs -->
          <div>
            <h3 class="font-semibold text-white mb-4">Programs</h3>
            <ul class="space-y-2">
              <li><a href="/programs#bootcamp" class="hover:text-primary-400 transition-colors">Bootcamp</a></li>
              <li><a href="/programs#hackathons" class="hover:text-primary-400 transition-colors">Hackathons</a></li>
              <li><a href="/programs#accelerator" class="hover:text-primary-400 transition-colors">Accelerator</a></li>
            </ul>
          </div>

          <!-- Connect -->
          <div>
            <h3 class="font-semibold text-white mb-4">Connect</h3>
            <ul class="space-y-2">
              <li><a href="/framework" class="hover:text-primary-400 transition-colors">Framework</a></li>
              <li><a href="/tracks" class="hover:text-primary-400 transition-colors">Tracks</a></li>
              <li><a href="/about" class="hover:text-primary-400 transition-colors">About</a></li>
              <li><a href="/faq" class="hover:text-primary-400 transition-colors">FAQ</a></li>
              <li><a href="/apply" class="hover:text-primary-400 transition-colors">Apply</a></li>
              <li><a href="https://discord.gg/qewprMy7G6" target="_blank" rel="noopener noreferrer" class="hover:text-primary-400 transition-colors">Discord</a></li>
            </ul>
          </div>
        </div>

        <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-500">
          <p>&copy; {new Date().getFullYear()} C4C Campus. A joint venture between <a href="http://openpaws.ai/" target="_blank" rel="noopener noreferrer" class="hover:text-primary-400 transition-colors">Open Paws</a> & <a href="https://www.electricsheep.is/" target="_blank" rel="noopener noreferrer" class="hover:text-primary-400 transition-colors">Electric Sheep</a>.</p>
        </div>
      </div>
    </footer>
    )}

    <script>
      // Mobile menu toggle - minimal JS
      const button = document.getElementById('mobile-menu-button');
      const menu = document.getElementById('mobile-menu');

      button?.addEventListener('click', () => {
        menu?.classList.toggle('hidden');
      });
    </script>
  </body>
</html>
