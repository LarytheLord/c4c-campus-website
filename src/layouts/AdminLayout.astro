---
import BaseLayout from './BaseLayout.astro';

interface Props {
  title: string;
  currentPage?: string;
}

const { title, currentPage = '' } = Astro.props;

const navItems = [
  { href: '/admin/dashboard', label: 'Dashboard', key: 'dashboard' },
  { href: '/admin/applications-review', label: 'Applications', key: 'applications-review' },
  { href: '/admin/users', label: 'Users', key: 'users' },
  { href: '/admin/cohorts', label: 'Cohorts', key: 'cohorts' },
  { href: '/admin/analytics', label: 'Analytics', key: 'analytics' },
];
---

<BaseLayout title={title} hideHeader={true} hideFooter={true}>
  <div class="min-h-screen bg-background">
    <!-- Admin Header -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-sm shadow-sm">
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-between gap-4">
          <!-- Left: Logo + Brand -->
          <a href="/admin/dashboard" class="flex items-center gap-3 flex-shrink-0">
            <img src="/logo.jpeg" alt="C4C Campus" class="h-10 w-10 rounded-lg" />
            <div class="hidden sm:block">
              <span class="font-bold text-xl text-text">C4C Admin</span>
            </div>
          </a>

          <!-- Center: Navigation -->
          <nav class="hidden md:flex items-center gap-1">
            {navItems.map(item => (
              <a
                href={item.href}
                class:list={[
                  'admin-nav-link px-4 py-2 rounded-full text-sm font-medium transition-all',
                  currentPage === item.key ? 'admin-nav-active' : ''
                ]}
              >
                {item.label}
              </a>
            ))}
          </nav>

          <!-- Right: Actions -->
          <div class="flex items-center gap-2">
            <button id="admin-logout-btn" class="btn btn-ghost btn-sm text-error">
              Sign Out
            </button>
          </div>
        </div>

        <!-- Mobile Navigation -->
        <nav class="flex md:hidden items-center gap-1 mt-3 overflow-x-auto pb-2 -mb-2">
          {navItems.map(item => (
            <a
              href={item.href}
              class:list={[
                'admin-nav-link-mobile px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-all',
                currentPage === item.key ? 'admin-nav-active' : ''
              ]}
            >
              {item.label}
            </a>
          ))}
        </nav>
      </div>
      <!-- Gradient accent line -->
      <div class="h-0.5 bg-gradient-to-r from-primary/50 via-primary to-primary/50"></div>
    </header>

    <!-- Page Content -->
    <main>
      <slot />
    </main>
  </div>

  <style>
    .admin-nav-link {
      color: hsl(0 0% 45%);
    }
    .admin-nav-link:hover {
      color: hsl(var(--primary));
      background: hsl(var(--primary) / 0.08);
    }
    .admin-nav-link.admin-nav-active {
      background: hsl(var(--primary-dark));
      color: white !important;
    }
    .admin-nav-link-mobile {
      color: hsl(0 0% 45%);
      background: hsl(0 0% 95%);
    }
    .admin-nav-link-mobile:hover {
      color: hsl(var(--primary));
    }
    .admin-nav-link-mobile.admin-nav-active {
      background: hsl(var(--primary-dark));
      color: white !important;
    }
  </style>

  <script>
    import { supabase } from '../lib/supabase';

    // Check admin access
    async function checkAdminAccess() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login';
        return false;
      }

      const { data: application } = await supabase
        .from('applications')
        .select('role')
        .eq('user_id', session.user.id)
        .single();

      if (!application || application.role !== 'admin') {
        window.location.href = '/admin/dashboard?error=unauthorized';
        return false;
      }

      return true;
    }

    // Logout handler
    document.getElementById('admin-logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/login';
    });

    // Check access on load
    checkAdminAccess();
  </script>
</BaseLayout>
